<!doctype html><html class="theme-next muse use-motion" lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta http-equiv="content-language" content="zh-cn"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><style>.pace .pace-progress{background:#ff009e;height:2px}.pace .pace-progress-inner{box-shadow:0 0 10px #e6006b,0 0 5px #ff009e}.pace .pace-activity{border-top-color:#ff009e;border-left-color:#ff009e}</style><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css"><meta name="keywords" content="Java,Docker,Spring Cloud,Spring,"><link rel="alternate" href="/atom.xml" title="ookamiAntD's Blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.png?v=5.1.0"><meta name="description" content="微服务架构下，微服务在带来良好的设计和架构理念的同时，也带来了运维上的额外复杂性，尤其是在服务部署和服务监控上。单体应用是集中式的，就一个单体跑在一起，部署和管理的时候非常简单，而微服务是一个网状分布的，有很多服务需要维护和管理，对它进行部署和维护的时候则比较复杂。"><meta name="keywords" content="Java,Docker,Spring Cloud,Spring"><meta property="og:type" content="article"><meta property="og:title" content="基于Docker构建高可用Eureka并提交到私有仓库"><meta property="og:url" content="http://yangbingdong.com/2018/spring-cloud-docker-integration/index.html"><meta property="og:site_name" content="ookamiAntD&#39;s Blog"><meta property="og:description" content="微服务架构下，微服务在带来良好的设计和架构理念的同时，也带来了运维上的额外复杂性，尤其是在服务部署和服务监控上。单体应用是集中式的，就一个单体跑在一起，部署和管理的时候非常简单，而微服务是一个网状分布的，有很多服务需要维护和管理，对它进行部署和维护的时候则比较复杂。"><meta property="og:locale" content="en"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/dev-ops"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/structure.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/portainer.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/harbor.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/duplicate01.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/duplicate02.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/portainer-eureka.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/compose-up03.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/cnm-demo.png"><meta property="og:updated_time" content="2018-03-14T06:38:23.186Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="基于Docker构建高可用Eureka并提交到私有仓库"><meta name="twitter:description" content="微服务架构下，微服务在带来良好的设计和架构理念的同时，也带来了运维上的额外复杂性，尤其是在服务部署和服务监控上。单体应用是集中式的，就一个单体跑在一起，部署和管理的时候非常简单，而微服务是一个网状分布的，有很多服务需要维护和管理，对它进行部署和维护的时候则比较复杂。"><meta name="twitter:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/dev-ops"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",sidebar:{position:"right",display:"always"},fancybox:!0,motion:!0,duoshuo:{userId:"undefined",author:"Author"},algolia:{applicationID:"RI3NF6GUI0",apiKey:"3d33fa60ba30d3b17f37220bb1a36749",indexName:"blogIndex",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://yangbingdong.com/2018/spring-cloud-docker-integration/"><title>基于Docker构建高可用Eureka并提交到私有仓库 | ookamiAntD's Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e9505ac4e11d464329d615553a72b526";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class="headband"></div><a href="https://github.com/masteranthoneyd/blog" rel="external nofollow noopener noreferrer" target="_blank"><img style="position:absolute;top:0;left:0;border:0" src="https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png"></a><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">ookamiAntD's Blog</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Easy coding,easy life.</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook" rel="section"><i class="menu-item-icon fa fa-fw fa-commenting"></i><br>Message</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div><span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://yangbingdong.com/2018/spring-cloud-docker-integration/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ookamiAntD"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar/avatar-admin.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="ookamiAntD's Blog"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="ookamiAntD's Blog" src=""></span></span><header class="post-header"><h2 class="post-title" itemprop="name headline">基于Docker构建高可用Eureka并提交到私有仓库</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-02T13:00:19+08:00">2018-01-02 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Programming/" itemprop="url" rel="index"><span itemprop="name">Programming</span> </a></span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Programming/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span> </a></span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Programming/Java/Spring-Cloud/" itemprop="url" rel="index"><span itemprop="name">Spring Cloud</span> </a></span></span><span id="busuanzi_container_page_pv">&nbsp; | &nbsp; 热度&nbsp; <span id="busuanzi_value_page_pv"></span>°C </span><span id="/2018/spring-cloud-docker-integration/" class="leancloud_visitors" data-flag-title="基于Docker构建高可用Eureka并提交到私有仓库"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">Visitors </span><span class="leancloud-visitors-count"></span></span><br><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-edit"></i> </span><span class="post-meta-item-text">WordCount:</span> <span class="post-count">3,743字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-text">min2read:</span> <span class="post-count">20分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/dev-ops" alt=""></p><blockquote><p>微服务架构下，微服务在带来良好的设计和架构理念的同时，也带来了运维上的额外复杂性，尤其是在服务部署和服务监控上。单体应用是集中式的，就一个单体跑在一起，部署和管理的时候非常简单，而微服务是一个网状分布的，有很多服务需要维护和管理，对它进行部署和维护的时候则比较复杂。</p></blockquote><a id="more"></a><h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><ul><li>安装Docker</li><li>IDE（使用IDEA）</li><li>Maven环境</li><li>Docker私有仓库</li></ul><p>集成Docker需要的插件<code>docker-maven-plugin</code>：<em><a href="https://github.com/spotify/docker-maven-plugin" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/spotify/docker-maven-plugin</a></em></p><p><strong>注意</strong>，此篇使用<code>Spring Cloud Eureka</code>作为例子，并实现高可用</p><h1 id="Maven-setting-xml配置"><a href="#Maven-setting-xml配置" class="headerlink" title="Maven setting.xml配置"></a>Maven setting.xml配置</h1><p><code>settings.xml</code>配置私有库的访问：</p><p>首先使用你的私有仓库访问密码生成主密码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn --encrypt-master-password &lt;password&gt;</span><br></pre></td></tr></table></figure>
<p>其次在<code>settings.xml</code>文件的同级目录创建<code>settings-security.xml</code>文件，将主密码写入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;settingsSecurity&gt;</span><br><span class="line">  &lt;master&gt;&#123;Ns0JM49fW9gHMTZ44n*****************=&#125;&lt;/master&gt;</span><br><span class="line">&lt;/settingsSecurity&gt;</span><br></pre></td></tr></table></figure>
<p>最后使用你的私有仓库访问密码生成服务密码，将生成的密码写入到<code>settings.xml</code>的<code>&lt;services&gt;</code>中（可能会提示目录不存在，解决方法是创建一个<code>.m2</code>目录并把<code>settings-security.xml</code>复制进去）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn --encrypt-password &lt;password&gt;</span><br><span class="line">&#123;D9YIyWYvtYsHayLjIenj***********=&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;server&gt;</span><br><span class="line">     &lt;id&gt;docker-registry&lt;/id&gt;</span><br><span class="line">     &lt;username&gt;admin&lt;/username&gt;</span><br><span class="line">     &lt;password&gt;&#123;D9YIyWYvtYsHayLjIenj***********=&#125;&lt;/password&gt;</span><br><span class="line">     &lt;configuration&gt;</span><br><span class="line">       &lt;email&gt;yangbingdong1994@gmail.com&lt;/email&gt;</span><br><span class="line">     &lt;/configuration&gt;</span><br><span class="line">   &lt;/server&gt;</span><br></pre></td></tr></table></figure>
<h1 id="构建基础镜像"><a href="#构建基础镜像" class="headerlink" title="构建基础镜像"></a>构建基础镜像</h1><p>Dockerfile：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM frolvlad/alpine-oraclejdk8:slim</span><br><span class="line">MAINTAINER ybd &lt;yangbingdong1994@gmail.com&gt;</span><br><span class="line">ARG TZ </span><br><span class="line">ARG HTTP_PROXY</span><br><span class="line">ENV TZ=$&#123;TZ:-&quot;Asia/Shanghai&quot;&#125; http_proxy=$&#123;HTTP_PROXY&#125; https_proxy=$&#123;HTTP_PROXY&#125;</span><br><span class="line">RUN apk update &amp;&amp; \</span><br><span class="line">    apk add --no-cache &amp;&amp; \</span><br><span class="line">    apk add curl bash tree tzdata &amp;&amp; \</span><br><span class="line">    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; \</span><br><span class="line">    echo $TZ &gt; /etc/timezone </span><br><span class="line">ENV http_proxy=</span><br><span class="line">ENV https_proxy=</span><br></pre></td></tr></table></figure>
<p>构建：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build --build-arg HTTP_PROXY=192.168.6.113:8118 -t yangbingdong/oraclejdk8 .</span><br></pre></td></tr></table></figure>
<p>其中<code>HTTP_PROXY</code>是sock5代理转过来的http代理，通过<code>--build-arg</code>参数传入，注意<strong>不能</strong>是<code>127.0.0.1</code>或<code>localhost</code>。</p>
<h1 id="Step1、利用IDEA的Spring-Initializr构建高可用Eureka工程"><a href="#Step1、利用IDEA的Spring-Initializr构建高可用Eureka工程" class="headerlink" title="Step1、利用IDEA的Spring Initializr构建高可用Eureka工程"></a>Step1、利用IDEA的Spring Initializr构建高可用Eureka工程</h1><p>项目结构：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/structure.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableEurekaServer</span><br><span class="line">public class EurekaserverApplication &#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(EurekaserverApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>application-peer1.properties</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server.port=5001</span><br><span class="line">spring.application.name=eureka-center-server</span><br><span class="line">eureka.instance.hostname=peer1</span><br><span class="line">#eureka.instance.prefer-ip-address=true</span><br><span class="line">#eureka.instance.instance-id=$&#123;spring.cloud.client.ipAddress&#125;:$&#123;server.port&#125;</span><br><span class="line">#eureka.client.register-with-eureka=false</span><br><span class="line">eureka.client.fetch-registry=true</span><br><span class="line">eureka.server.enable-self-preservation=false</span><br><span class="line">#eureka.instance.ip-address=true</span><br><span class="line">spring.output.ansi.enabled=ALWAYS</span><br><span class="line">eureka.client.serviceUrl.defaultZone=http://peer2:5002/eureka/</span><br></pre></td></tr></table></figure>
<p><code>application-peer2.properties</code>:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server.port=5002</span><br><span class="line">spring.application.name=eureka-center-server</span><br><span class="line">eureka.instance.hostname=peer2</span><br><span class="line">#eureka.instance.prefer-ip-address=true</span><br><span class="line">#eureka.instance.instance-id=$&#123;spring.cloud.client.ipAddress&#125;:$&#123;server.port&#125;</span><br><span class="line">#eureka.client.register-with-eureka=false</span><br><span class="line">eureka.client.fetch-registry=true</span><br><span class="line">eureka.server.enable-self-preservation=false</span><br><span class="line">#eureka.instance.ip-address=true</span><br><span class="line">spring.output.ansi.enabled=ALWAYS</span><br><span class="line">eureka.client.serviceUrl.defaultZone=http://peer1:5001/eureka/</span><br></pre></td></tr></table></figure><p></p>
<h1 id="Step2、创建Dockerfile"><a href="#Step2、创建Dockerfile" class="headerlink" title="Step2、创建Dockerfile"></a>Step2、创建Dockerfile</h1><p>在<code>src/main</code>下面新建<code>docker</code>文件夹，并创建<code>Dockerfile</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FROM yangbingdong/docker-oraclejdk8</span><br><span class="line">MAINTAINER ybd &lt;yangbingdong1994@gmail.com&gt;</span><br><span class="line">VOLUME /tmp</span><br><span class="line">ENV PROJECT_NAME=&quot;@project.build.finalName@.@project.packaging@&quot; JAVA_OPTS=&quot;&quot;</span><br><span class="line">ADD $PROJECT_NAME app.jar</span><br><span class="line"></span><br><span class="line">RUN sh -c &apos;touch /app.jar&apos;</span><br><span class="line"></span><br><span class="line">CMD [&quot;sh&quot;, &quot;-c&quot;, &quot;java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -Dspring.profiles.active=$&#123;ACTIVE:-docker1&#125; -jar /app.jar&quot;]</span><br><span class="line"># ENTRYPOINT [ &quot;sh&quot;, &quot;-c&quot;, &quot;java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -jar /app.jar&quot; ]</span><br></pre></td></tr></table></figure>
<h1 id="Step3、添加插件"><a href="#Step3、添加插件" class="headerlink" title="Step3、添加插件"></a>Step3、添加插件</h1><p>在完整的<code>pom.xml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">	xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">	&lt;groupId&gt;com.ybd.server&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;eureka-center-server&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line">	&lt;name&gt;eureka-center-server&lt;/name&gt;</span><br><span class="line">	&lt;description&gt;统一服务注册中心&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;resources.plugin.version&gt;3.0.2&lt;/resources.plugin.version&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">        &lt;spring-boot.version&gt;1.5.9.RELEASE&lt;/spring-boot.version&gt;</span><br><span class="line">        &lt;spring-boot-maven-plugin.version&gt;1.5.9.RELEASE&lt;/spring-boot-maven-plugin.version&gt;</span><br><span class="line">        &lt;spring-cloud.version&gt;Edgware.RELEASE&lt;/spring-cloud.version&gt;</span><br><span class="line">        &lt;maven.test.skip&gt;true&lt;/maven.test.skip&gt;</span><br><span class="line"></span><br><span class="line">        &lt;docker.plugin.version&gt;1.0.0&lt;/docker.plugin.version&gt;</span><br><span class="line">        &lt;dockerfile.compiled.position&gt;$&#123;project.build.directory&#125;/docker&lt;/dockerfile.compiled.position&gt;</span><br><span class="line">        &lt;docker.registry.name&gt;discover-server&lt;/docker.registry.name&gt;</span><br><span class="line">        &lt;docker.registry.url&gt;192.168.6.113:8888&lt;/docker.registry.url&gt;</span><br><span class="line">        &lt;docker.skip.build&gt;false&lt;/docker.skip.build&gt;</span><br><span class="line">        &lt;docker.push.image&gt;false&lt;/docker.push.image&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencyManagement&gt;</span><br><span class="line">        &lt;dependencies&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-boot.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">        &lt;/dependencies&gt;</span><br><span class="line">    &lt;/dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">	&lt;dependencies&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-starter-eureka-server&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">        &lt;!--配置需要认证的eureka所需要引用的包--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">	&lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-boot-maven-plugin.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;repackage&lt;/goal&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                    &lt;/execution&gt;</span><br><span class="line">                &lt;/executions&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!-- resources插件，使用@变量@形式获取Maven变量到Dockerfile中 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;resources.plugin.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;prepare-dockerfile&lt;/id&gt;</span><br><span class="line">                        &lt;phase&gt;validate&lt;/phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;copy-resources&lt;/goal&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                        &lt;configuration&gt;</span><br><span class="line">                            &lt;!-- 编译后Dockerfile的输出位置 --&gt;</span><br><span class="line">                            &lt;outputDirectory&gt;$&#123;dockerfile.compiled.position&#125;&lt;/outputDirectory&gt;</span><br><span class="line">                            &lt;resources&gt;</span><br><span class="line">                                &lt;!-- Dockerfile位置 --&gt;</span><br><span class="line">                                &lt;resource&gt;</span><br><span class="line">                                    &lt;directory&gt;$&#123;project.basedir&#125;/src/main/docker&lt;/directory&gt;</span><br><span class="line">                                    &lt;filtering&gt;true&lt;/filtering&gt;</span><br><span class="line">                                &lt;/resource&gt;</span><br><span class="line">                            &lt;/resources&gt;</span><br><span class="line">                        &lt;/configuration&gt;</span><br><span class="line">                    &lt;/execution&gt;</span><br><span class="line">                &lt;/executions&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">            &lt;!-- 集成Docker maven 插件 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;com.spotify&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;docker-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;docker.plugin.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;build&lt;/goal&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                    &lt;/execution&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;push-image&lt;/id&gt;</span><br><span class="line">                        &lt;phase&gt;deploy&lt;/phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;push&lt;/goal&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                        &lt;configuration&gt;</span><br><span class="line">                            &lt;imageName&gt;$&#123;docker.registry.url&#125;/$&#123;docker.registry.name&#125;/$&#123;project.artifactId&#125;:latest&lt;/imageName&gt;</span><br><span class="line">                        &lt;/configuration&gt;</span><br><span class="line">                    &lt;/execution&gt;</span><br><span class="line">                &lt;/executions&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;!--配置变量，包括是否build、imageName、imageTag，非常灵活--&gt;</span><br><span class="line">                    &lt;skipDocker&gt;$&#123;docker.skip.build&#125;&lt;/skipDocker&gt;</span><br><span class="line">                    &lt;!--最后镜像产生了两个tag，版本和和最新的--&gt;</span><br><span class="line">                    &lt;forceTags&gt;true&lt;/forceTags&gt;</span><br><span class="line">                    &lt;imageTags&gt;</span><br><span class="line">                        &lt;imageTag&gt;$&#123;project.version&#125;&lt;/imageTag&gt;</span><br><span class="line">                        &lt;imageTag&gt;latest&lt;/imageTag&gt;</span><br><span class="line">                    &lt;/imageTags&gt;</span><br><span class="line">                    &lt;!--install阶段也上传，否则只有deploy阶段上传--&gt;</span><br><span class="line">                    &lt;pushImage&gt;$&#123;docker.push.image&#125;&lt;/pushImage&gt;</span><br><span class="line">                    &lt;!-- 配置镜像名称，遵循Docker的命名规范： springio/image --&gt;</span><br><span class="line">                    &lt;imageName&gt;$&#123;docker.registry.url&#125;/$&#123;docker.registry.name&#125;/$&#123;project.artifactId&#125;&lt;/imageName&gt;</span><br><span class="line">                    &lt;!-- Dockerfile位置，由于配置了编译时动态获取Maven变量，真正的Dockerfile位于位于编译后位置 --&gt;</span><br><span class="line">                    &lt;dockerDirectory&gt;$&#123;dockerfile.compiled.position&#125;&lt;/dockerDirectory&gt;</span><br><span class="line">                    &lt;resources&gt;</span><br><span class="line">                        &lt;!-- 构建时需要的资源文件，这些文件和Dockerfile放在一起，这里只需要Spring Boot生成的jar文件即可 --&gt;</span><br><span class="line">                        &lt;resource&gt;</span><br><span class="line">                            &lt;targetPath&gt;/&lt;/targetPath&gt;</span><br><span class="line">                            &lt;directory&gt;$&#123;project.build.directory&#125;&lt;/directory&gt;</span><br><span class="line">                            &lt;include&gt;$&#123;project.build.finalName&#125;.jar&lt;/include&gt;</span><br><span class="line">                        &lt;/resource&gt;</span><br><span class="line">                    &lt;/resources&gt;</span><br><span class="line">                    &lt;!--push到私有的hub--&gt;</span><br><span class="line">                    &lt;serverId&gt;docker-registry&lt;/serverId&gt;</span><br><span class="line">                    &lt;registryUrl&gt;192.168.6.113:8888&lt;/registryUrl&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line">    &lt;distributionManagement&gt;</span><br><span class="line">        &lt;repository&gt;</span><br><span class="line">            &lt;id&gt;nexus-releases&lt;/id&gt;</span><br><span class="line">            &lt;name&gt;Nexus Release Repository&lt;/name&gt;</span><br><span class="line">            &lt;url&gt;http://192.168.0.200:8081/repository/maven-releases/&lt;/url&gt;</span><br><span class="line">        &lt;/repository&gt;</span><br><span class="line">        &lt;snapshotRepository&gt;</span><br><span class="line">            &lt;id&gt;nexus-snapshots&lt;/id&gt;</span><br><span class="line">            &lt;name&gt;Nexus Snapshot Repository&lt;/name&gt;</span><br><span class="line">            &lt;url&gt;http://192.168.0.200:8081/repository/maven-snapshots/&lt;/url&gt;</span><br><span class="line">        &lt;/snapshotRepository&gt;</span><br><span class="line">    &lt;/distributionManagement&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
<p><strong>说明</strong>：</p>
<ul>
<li>这里的<code>serverId</code>要与maven <code>setting.xml</code>里面的一样</li>
</ul>
<ul>
<li>Dockerfile构建文件在<code>src/main/docker</code>中</li>
<li>如果Dockerfile文件需要maven构建参数（比如需要构建后的打包文件名等），则使用<code>@@</code>占位符（如<code>@project.build.finalName@</code>）原因是Sping Boot 的pom将resource插件的占位符由<code>${}</code>改为<code>@@</code>，非继承Spring Boot 的pom文件，则使用<code>${}</code>占位符</li>
<li>如果不需要动态生成Dockerfile文件，则可以将Dockerfile资源拷贝部分放入<code>docker-maven-plugin</code>插件的<code>&lt;resources&gt;</code>配置里</li>
<li><code>spring-boot-maven-plugin</code>插件一定要在其他构建插件之上，否则打包文件会有问题。</li>
</ul>
<h1 id="Step4、构建"><a href="#Step4、构建" class="headerlink" title="Step4、构建"></a>Step4、构建</h1><p>如果<code>&lt;pushImage&gt;false&lt;/pushImage&gt;</code>则install阶段将不提交Docker镜像，只有maven的<code>deploy</code>阶段才提交。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[INFO] --- spring-boot-maven-plugin:1.5.9.RELEASE:repackage (default) @ eureka-center-server ---</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- docker-maven-plugin:1.0.0:build (default) @ eureka-center-server ---</span><br><span class="line">[INFO] Using authentication suppliers: [ConfigFileRegistryAuthSupplier, NoOpRegistryAuthSupplier]</span><br><span class="line">[WARNING] Ignoring run because dockerDirectory is set</span><br><span class="line">[INFO] Copying /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/target/eureka-center-server-0.0.1-SNAPSHOT.jar -&gt; /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/target/docker/eureka-center-server-0.0.1-SNAPSHOT.jar</span><br><span class="line">[INFO] Copying /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/target/docker/eureka-center-server-0.0.1-SNAPSHOT.jar -&gt; /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/target/docker/eureka-center-server-0.0.1-SNAPSHOT.jar</span><br><span class="line">[INFO] Copying /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/target/docker/Dockerfile -&gt; /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/target/docker/Dockerfile</span><br><span class="line">[INFO] Building image 192.168.6.113:8888/discover-server/eureka-center-server</span><br><span class="line">Step 1/7 : FROM frolvlad/alpine-oraclejdk8:slim</span><br><span class="line"></span><br><span class="line"> ---&gt; 491f45037124</span><br><span class="line">Step 2/7 : MAINTAINER ybd &lt;yangbingdong1994@gmail.com&gt;</span><br><span class="line"></span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 016c2033bd32</span><br><span class="line">Step 3/7 : VOLUME /tmp</span><br><span class="line"></span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; d2a287b6ed52</span><br><span class="line">Step 4/7 : ENV PROJECT_NAME=&quot;eureka-center-server-0.0.1-SNAPSHOT.jar&quot; JAVA_OPTS=&quot;&quot;</span><br><span class="line"></span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 34565a7de714</span><br><span class="line">Step 5/7 : ADD $PROJECT_NAME app.jar</span><br><span class="line"></span><br><span class="line"> ---&gt; 64d9055ce969</span><br><span class="line">Step 6/7 : RUN sh -c &apos;touch /app.jar&apos;</span><br><span class="line"></span><br><span class="line"> ---&gt; Running in 66f4eb550a57</span><br><span class="line">Removing intermediate container 66f4eb550a57</span><br><span class="line"> ---&gt; 93486965cad9</span><br><span class="line">Step 7/7 : CMD [&quot;sh&quot;, &quot;-c&quot;, &quot;java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -Dspring.profiles.active=$&#123;ACTIVE:-docker&#125;  -jar /app.jar&quot;]</span><br><span class="line"></span><br><span class="line"> ---&gt; Running in 8b42c471791f</span><br><span class="line">Removing intermediate container 8b42c471791f</span><br><span class="line"> ---&gt; 2eb3dbbab6c5</span><br><span class="line">ProgressMessage&#123;id=null, status=null, stream=null, error=null, progress=null, progressDetail=null&#125;</span><br><span class="line">Successfully built 2eb3dbbab6c5</span><br><span class="line">Successfully tagged 192.168.6.113:8888/discover-server/eureka-center-server:latest</span><br><span class="line">[INFO] Built 192.168.6.113:8888/discover-server/eureka-center-server</span><br><span class="line">[INFO] Tagging 192.168.6.113:8888/discover-server/eureka-center-server with 0.0.1-SNAPSHOT</span><br><span class="line">[INFO] Tagging 192.168.6.113:8888/discover-server/eureka-center-server with latest</span><br><span class="line">[INFO] Pushing 192.168.6.113:8888/discover-server/eureka-center-server</span><br><span class="line">The push refers to repository [192.168.6.113:8888/discover-server/eureka-center-server]</span><br><span class="line">40566d372b69: Pushed </span><br><span class="line">40566d372b69: Layer already exists </span><br><span class="line">4fd38f0d6712: Layer already exists </span><br><span class="line">d7cd646c41bd: Layer already exists </span><br><span class="line">ced237d13962: Layer already exists </span><br><span class="line">2aebd096e0e2: Layer already exists </span><br><span class="line">null: null </span><br><span class="line">null: null </span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-install-plugin:2.4:install (default-install) @ eureka-center-server ---</span><br><span class="line">[INFO] Installing /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/target/eureka-center-server-0.0.1-SNAPSHOT.jar to /home/ybd/data/application/maven/maven-repo/com/iba/server/eureka-center-server/0.0.1-SNAPSHOT/eureka-center-server-0.0.1-SNAPSHOT.jar</span><br><span class="line">[INFO] Installing /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/pom.xml to /home/ybd/data/application/maven/maven-repo/com/iba/server/eureka-center-server/0.0.1-SNAPSHOT/eureka-center-server-0.0.1-SNAPSHOT.pom</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time: 15.962 s</span><br><span class="line">[INFO] Finished at: 2017-12-25T13:33:39+08:00</span><br><span class="line">[INFO] Final Memory: 55M/591M</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>可以看到本地以及私有仓库都多了一个镜像：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/portainer.png" alt=""></p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/harbor.png" alt=""></p>
<p><strong>此处有个疑问</strong>，很明显看得出来这里上传了两个一样大小的包，不知道是不是同一个jar包，但id又不一样：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/duplicate01.png" alt=""></p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/duplicate02.png" alt=""></p>
<h1 id="Step5、运行"><a href="#Step5、运行" class="headerlink" title="Step5、运行"></a>Step5、运行</h1><p>运行程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run --name discover-server1 -e ACTIVE=peer1 -p 5001:5001 -d --network=host [IMAGE]</span><br><span class="line"></span><br><span class="line">docker run --name discover-server2 -e ACTIVE=peer2 -p 5002:5002 -d --network=host [IMAGE]</span><br><span class="line"># 限制内存加上：-e &quot;JAVA_OPTS=-Xmx128m&quot;</span><br></pre></td></tr></table></figure>
<p>这样一个简单的基于Docker的高可用Eureka就运行起来了。</p>
<h1 id="高可用Eureka-Server"><a href="#高可用Eureka-Server" class="headerlink" title="高可用Eureka Server"></a>高可用Eureka Server</h1><p><strong>基于Compose运行高可用的Eureka</strong></p>
<h2 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a><code>application.yml</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: eureka-center-server</span><br><span class="line">  cloud:</span><br><span class="line">    inetutils:</span><br><span class="line">      preferred-networks: $&#123;PREFERRED_NETWORKS&#125;</span><br><span class="line">  output:</span><br><span class="line">    ansi:</span><br><span class="line">      enabled: always</span><br><span class="line">security:</span><br><span class="line">  basic:</span><br><span class="line">    enabled: true     # 开启基于HTTP basic的认证</span><br><span class="line">  user:</span><br><span class="line">    name: $&#123;SECURITY_NAME&#125;</span><br><span class="line">    password: $&#123;SECURITY_PASSWORD&#125;</span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  profiles: docker1</span><br><span class="line">server:</span><br><span class="line">  port: $&#123;PORT&#125;</span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: docker-eureka1</span><br><span class="line">    prefer-ip-address: true</span><br><span class="line">    ip-address: $&#123;eureka.instance.hostname&#125;</span><br><span class="line">    instance-id: $&#123;eureka.instance.hostname&#125;:$&#123;spring.cloud.client.ipAddress&#125;:$&#123;server.port&#125;</span><br><span class="line">    lease-renewal-interval-in-seconds: $&#123;LEASE_RENEWAL_INTERVAL_INSECONDS&#125;</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: $&#123;ADDITIONAL_EUREKA_SERVER_LIST&#125;</span><br><span class="line">  server:</span><br><span class="line">    enable-self-preservation: false</span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  profiles: docker2</span><br><span class="line">server:</span><br><span class="line">  port: $&#123;PORT&#125;</span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: docker-eureka2</span><br><span class="line">    prefer-ip-address: true</span><br><span class="line">    ip-address: $&#123;eureka.instance.hostname&#125;</span><br><span class="line">    instance-id: $&#123;eureka.instance.hostname&#125;:$&#123;spring.cloud.client.ipAddress&#125;:$&#123;server.port&#125;</span><br><span class="line">    lease-renewal-interval-in-seconds: $&#123;LEASE_RENEWAL_INTERVAL_INSECONDS&#125;</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: $&#123;ADDITIONAL_EUREKA_SERVER_LIST&#125;</span><br><span class="line">  server:</span><br><span class="line">    enable-self-preservation: false</span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  profiles: docker3</span><br><span class="line">server:</span><br><span class="line">  port: $&#123;PORT&#125;</span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: docker-eureka3</span><br><span class="line">    prefer-ip-address: true</span><br><span class="line">    ip-address: $&#123;eureka.instance.hostname&#125;</span><br><span class="line">    instance-id: $&#123;eureka.instance.hostname&#125;:$&#123;spring.cloud.client.ipAddress&#125;:$&#123;server.port&#125;</span><br><span class="line">    lease-renewal-interval-in-seconds: $&#123;LEASE_RENEWAL_INTERVAL_INSECONDS&#125;</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: $&#123;ADDITIONAL_EUREKA_SERVER_LIST&#125;</span><br><span class="line">  server:</span><br><span class="line">    enable-self-preservation: false</span><br></pre></td></tr></table></figure>
<p>开启<code>basic</code>的认证需要添加依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h2 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a><code>docker-compose.yml</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3.4&quot;</span><br><span class="line">services:</span><br><span class="line">  docker-eureka1:</span><br><span class="line">    image: $&#123;IMAGE&#125;</span><br><span class="line">    env_file:</span><br><span class="line">      - .env</span><br><span class="line">    environment:</span><br><span class="line">      - ACTIVE=docker1</span><br><span class="line">      - PORT=$&#123;EUREKA1_PORT&#125;</span><br><span class="line">      - ADDITIONAL_EUREKA_SERVER_LIST=http://$&#123;SECURITY_NAME&#125;:$&#123;SECURITY_PASSWORD&#125;@docker-eureka2:$&#123;EUREKA2_PORT&#125;/eureka/,http://$&#123;SECURITY_NAME&#125;:$&#123;SECURITY_PASSWORD&#125;@docker-eureka3:$&#123;EUREKA3_PORT&#125;/eureka/</span><br><span class="line">    ports:</span><br><span class="line">      - $&#123;EUREKA1_PORT&#125;:$&#123;EUREKA1_PORT&#125;</span><br><span class="line">    deploy:</span><br><span class="line">      mode: replicated</span><br><span class="line">      replicas: 1</span><br><span class="line">      restart_policy:</span><br><span class="line">        condition: on-failure</span><br><span class="line">        delay: 3s</span><br><span class="line">        max_attempts: 3</span><br><span class="line">        window: 20s</span><br><span class="line">      update_config:</span><br><span class="line">        parallelism: 1</span><br><span class="line">        delay: 20s</span><br><span class="line">    networks:</span><br><span class="line">      eureka-net:</span><br><span class="line">        aliases:</span><br><span class="line">          - eureka</span><br><span class="line">    healthcheck:</span><br><span class="line">      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-fs&quot;, &quot;http://localhost:$&#123;EUREKA1_PORT&#125;/health/&quot;]</span><br><span class="line">      interval: 1m30s</span><br><span class="line">      timeout: 15s</span><br><span class="line">      retries: 3</span><br><span class="line"></span><br><span class="line">  docker-eureka2:</span><br><span class="line">    image: $&#123;IMAGE&#125;</span><br><span class="line">    env_file:</span><br><span class="line">      - .env</span><br><span class="line">    environment:</span><br><span class="line">      - ACTIVE=docker2</span><br><span class="line">      - PORT=$&#123;EUREKA2_PORT&#125;</span><br><span class="line">      - ADDITIONAL_EUREKA_SERVER_LIST=http://$&#123;SECURITY_NAME&#125;:$&#123;SECURITY_PASSWORD&#125;@docker-eureka1:$&#123;EUREKA1_PORT&#125;/eureka/,http://$&#123;SECURITY_NAME&#125;:$&#123;SECURITY_PASSWORD&#125;@docker-eureka3:$&#123;EUREKA3_PORT&#125;/eureka/</span><br><span class="line">    ports:</span><br><span class="line">      - $&#123;EUREKA2_PORT&#125;:$&#123;EUREKA2_PORT&#125;</span><br><span class="line">    deploy:</span><br><span class="line">      mode: replicated</span><br><span class="line">      replicas: 1</span><br><span class="line">      restart_policy:</span><br><span class="line">        condition: on-failure</span><br><span class="line">        delay: 3s</span><br><span class="line">        max_attempts: 3</span><br><span class="line">        window: 20s</span><br><span class="line">      update_config:</span><br><span class="line">        parallelism: 1</span><br><span class="line">        delay: 20s</span><br><span class="line">    networks:</span><br><span class="line">      eureka-net:</span><br><span class="line">        aliases:</span><br><span class="line">          - eureka</span><br><span class="line">    healthcheck:</span><br><span class="line">      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-fs&quot;, &quot;http://localhost:$&#123;EUREKA2_PORT&#125;/health/&quot;]</span><br><span class="line">      interval: 1m30s</span><br><span class="line">      timeout: 15s</span><br><span class="line">      retries: 3</span><br><span class="line"></span><br><span class="line">  docker-eureka3:</span><br><span class="line">    image: $&#123;IMAGE&#125;</span><br><span class="line">    env_file:</span><br><span class="line">      - .env</span><br><span class="line">    environment:</span><br><span class="line">      - ACTIVE=docker3</span><br><span class="line">      - PORT=$&#123;EUREKA3_PORT&#125;</span><br><span class="line">      - ADDITIONAL_EUREKA_SERVER_LIST=http://$&#123;SECURITY_NAME&#125;:$&#123;SECURITY_PASSWORD&#125;@docker-eureka2:$&#123;EUREKA2_PORT&#125;/eureka/,http://$&#123;SECURITY_NAME&#125;:$&#123;SECURITY_PASSWORD&#125;@docker-eureka1:$&#123;EUREKA1_PORT&#125;/eureka/</span><br><span class="line">    ports:</span><br><span class="line">      - $&#123;EUREKA3_PORT&#125;:$&#123;EUREKA3_PORT&#125;</span><br><span class="line">    deploy:</span><br><span class="line">      mode: replicated</span><br><span class="line">      replicas: 1</span><br><span class="line">      restart_policy:</span><br><span class="line">        condition: on-failure</span><br><span class="line">        delay: 3s</span><br><span class="line">        max_attempts: 3</span><br><span class="line">        window: 20s</span><br><span class="line">      update_config:</span><br><span class="line">        parallelism: 1</span><br><span class="line">        delay: 20s</span><br><span class="line">    networks:</span><br><span class="line">      eureka-net:</span><br><span class="line">        aliases:</span><br><span class="line">          - eureka</span><br><span class="line">    healthcheck:</span><br><span class="line">      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-fs&quot;, &quot;http://localhost:$&#123;EUREKA3_PORT&#125;/health/&quot;]</span><br><span class="line">      interval: 1m30s</span><br><span class="line">      timeout: 15s</span><br><span class="line">      retries: 3</span><br><span class="line"></span><br><span class="line"># docker network create --opt encrypted -d=overlay --attachable --subnet 10.10.0.0/16 name</span><br><span class="line">networks:</span><br><span class="line">  eureka-net:</span><br><span class="line">    external:</span><br><span class="line">      name: $&#123;BACKEND_NETWORK:-backend&#125;</span><br></pre></td></tr></table></figure>
<p><code>.env</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">IMAGE=192.168.6.113:8888/discover-server/eureka-center-server</span><br><span class="line">PREFERRED_NETWORKS=10.10</span><br><span class="line">LEASE_RENEWAL_INTERVAL_INSECONDS=15</span><br><span class="line">SECURITY_NAME=admin</span><br><span class="line">SECURITY_PASSWORD=admin123</span><br><span class="line">EUREKA1_PORT=5001</span><br><span class="line">EUREKA2_PORT=5002</span><br><span class="line">EUREKA3_PORT=5003</span><br></pre></td></tr></table></figure>
<p>从部署模版中可以看出这三个Eureka实例在网络上的别名(alias)都是<code>eureka</code>，对于客户端可以在配置文件中指定这个别名即可，不必指定三个示例的名字。</p>
<p><code>application.yml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.client.serviceUrl.defaultZone=http://$&#123;EUREKA_SERVER_ADDRESS&#125;:5001/eureka/</span><br></pre></td></tr></table></figure>
<p>Eureka Server的地址通过<code>${EUREKA_SERVER_ADDRESS}</code> 环境变量传入。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">services:</span><br><span class="line">  web:</span><br><span class="line">    image: demo-web</span><br><span class="line">    networks:</span><br><span class="line">      - eureka-net</span><br><span class="line">    environment:</span><br><span class="line">      - EUREKA_SERVER_ADDRESS=eureka</span><br></pre></td></tr></table></figure>
<p>另外要注意的是所有依赖于Eureka的应用服务都要挂到<code>eureka-net</code>网络上，否则无法和Eureka Server通信。</p>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>启动前确保创建好了网络：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker network create --opt encrypted -d=overlay --attachable --subnet 10.10.0.0/16 backend</span><br><span class="line">docker-compse up -d</span><br></pre></td></tr></table></figure>
<p>此时在<code>Portainer</code>中可以看到三个容器已经启动：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/portainer-eureka.png" alt=""></p>
<p>随意一个eureka端口都能看到另外两个服务：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/compose-up03.png" alt=""></p>
<p>如果使用swarm mode：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export $(cat .env) &amp;&amp; docker stack deploy --compose-file=docker-compose.yml eureka-stack</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：目前使用stack方式启动是无法加载<code>env_file</code>的，所以需要预先加载一下。</p>
<p>我们的app通过合适的<code>network</code>交互应该是这样的：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-cloud-docker-integration/cnm-demo.png" alt=""></p>
<h2 id="Eureka-Edgware-RELEASE版本注册优化"><a href="#Eureka-Edgware-RELEASE版本注册优化" class="headerlink" title="Eureka Edgware.RELEASE版本注册优化"></a>Eureka Edgware.RELEASE版本注册优化</h2><p>在<code>Edgware.RELEASE</code>版本中相比之前的步骤，省略了在主函数上添加<code>@EnableDiscoveryClient</code>注解这一过程。Spring Cloud默认认为客户端是要完成向注册中心进行注册的。</p>
<ul>
<li>添加对应的<code>pom</code>依赖.</li>
<li><code>properties</code>文件进行配置</li>
</ul>
<p><strong>添加pom依赖</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">   &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p><strong>properties文件进行配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=EUREKA-CLIENT</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:8761/eureka</span><br></pre></td></tr></table></figure>
<p>启动Eureka Client客户端，访问<a href="http://localhost:8761/eureka" rel="external nofollow noopener noreferrer" target="_blank">http://localhost:8761/eureka</a><br>可以看到EUEREKA-CLIENT已经注册到Eureka Server服务上了。</p>
<p><strong>关闭自动注册功能</strong></p>
<p>spring cloud提供了一个参数，该参数的作用是控制是否要向Eureka Server发起注册。具体参数为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//默认为true,如果控制不需要向Eureka Server发起注册将该值设置为false.</span><br><span class="line">spring.cloud.service-registry.auto-registration.enabled = xxx</span><br></pre></td></tr></table></figure>
<h1 id="Finally"><a href="#Finally" class="headerlink" title="Finally"></a>Finally</h1><blockquote>
<p>参考</p>
<p><strong><em><a href="http://blueskykong.com/2017/11/02/dockermaven/" rel="external nofollow noopener noreferrer" target="_blank">http://blueskykong.com/2017/11/02/dockermaven/</a></em></strong></p>
<p><strong><em><a href="http://blog.csdn.net/timedifier2/article/details/78135970" rel="external nofollow noopener noreferrer" target="_blank">http://blog.csdn.net/timedifier2/article/details/78135970</a></em></strong></p>
<p>源码</p>
<p><a href="https://github.com/masteranthoneyd/spring-boot-docker-demo" rel="external nofollow noopener noreferrer" target="_blank"><strong><em>https://github.com/masteranthoneyd/spring-boot-docker-demo</em></strong></a></p></blockquote>
      
    </div>

<div style="text-align:center;color:#ccc;font-size:14px">---------------- The End ----------------</div>

    <div>
      
        
<div id="wechat_subscriber" style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center">
    <img id="wechat_subscriber_qcode" src="/images/wechat/gongzhonghao.jpg" alt="ookamiAntD wechat" style="width:200px;max-width:100%">
    <div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div>
</div>


      
    </div>

    <div>
      
        


  <div style="padding:10px 0;margin:20px auto;width:90%;text-align:center">
    <div>谢谢大爷～</div>
    <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'>
      <span>赏</span>
    </button>
    <div id="QR" style="display:none">
      
        <div id="wechat" style="display:inline-block">
          <img id="wechat_qr" src="/images/donate/wechat.png" alt="ookamiAntD WeChat Pay">
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display:inline-block">
          <img id="alipay_qr" src="/images/donate/alipay.jpg" alt="ookamiAntD Alipay">
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>
<div>
	  
	    <p id="div-border-left-red">
		Author：<b>ookamiAntD Yang</b><br>
		Link：<a href="/2018/spring-cloud-docker-integration/" title="基于Docker构建高可用Eureka并提交到私有仓库">http://yangbingdong.com/2018/spring-cloud-docker-integration/</a><br>
		Contact：<a>yangbingdong1994@gmail.com</a><br>
	   <b>本文基于<a target="_blank" title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href="http://creativecommons.org/licenses/by-sa/4.0/" rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br>
	    <b>转载请注明出处，谢谢！</b>
	    </p>
	  
	</div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
            <a href="/tags/Docker/" rel="tag"># Docker</a>
          
            <a href="/tags/Spring-Cloud/" rel="tag"># Spring Cloud</a>
          
            <a href="/tags/Spring/" rel="tag"># Spring</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/docker-visual-management-and-orchestrate-tools/" rel="next" title="Docker可视化与管理工具">
                <i class="fa fa-chevron-left"></i> Docker可视化与管理工具
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/disruptor-learning/" rel="prev" title="极致的追求：高性能并发框架 Disruptor">
                极致的追求：高性能并发框架 Disruptor <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        
<div class="-hoofoo-share-title">分享到：</div>
<div class="-hoofoo-share-buttons">
    <div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden="true"></i></div>
    <div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden="true"></i></div>
    <div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden="true"></i></div>
    <div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden="true"></i></div>
    <div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden="true"></i></div>
</div>
<div class="-mob-share-ui" style="display:none">
    <ul class="-mob-share-list">
        <li class="-mob-share-weibo"><p>新浪微博</p></li>
        <li class="-mob-share-weixin"><p>微信</p></li>
        <li class="-mob-share-qzone"><p>QQ空间</p></li>
        <li class="-mob-share-qq"><p>QQ好友</p></li>
        <li class="-mob-share-tencentweibo"><p>腾讯微博</p></li>
        <li class="-mob-share-renren"><p>人人网</p></li>
        <li class="-mob-share-kaixin"><p>开心网</p></li>
        <li class="-mob-share-douban"><p>豆瓣</p></li>
        <li class="-mob-share-youdao"><p>有道云笔记</p></li>
        <li class="-mob-share-mingdao"><p>明道</p></li>
        <li class="-mob-share-pengyou"><p>朋友网</p></li>
        <li class="-mob-share-facebook"><p>Facebook</p></li>
        <li class="-mob-share-twitter"><p>Twitter</p></li>
        <li class="-mob-share-pocket"><p>Pocket</p></li>
        <li class="-mob-share-google"><p>Google+</p></li>
        <li class="-mob-share-tumblr"><p>Tumblr</p></li>
        <li class="-mob-share-instapaper"><p>Instapaper</p></li>
        <li class="-mob-share-linkedin"><p>Linkedin</p></li>
    </ul>
    <div class="-mob-share-close">取消</div>
</div>
<div class="-mob-share-ui-bg"></div>
<script id="-mob-share" src="http://f1.webshare.mob.com/code/mob-share.js?appkey=21aa3b13ad233"></script>


      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
<div style="text-align:center">
  

</div>
      <div id="disqus_proxy_thread"></div>
      <div id="disqus_thread"></div>
      
          <script type="text/javascript">window.disqusProxy={username:"ookamiantd",server:"disqus-proxy.yangbingdong.com",port:"5509",defaultAvatar:"/images/avatar/avatar-default.jpg",adminAvatar:"/images/avatar/avatar-admin.jpg",identifier:"2018/spring-cloud-docker-integration/"},window.disqus_config=function(){this.page.url="http://yangbingdong.com/2018/spring-cloud-docker-integration/",this.page.identifier="2018/spring-cloud-docker-integration/"},window.onload=function(){var a=document.createElement("script");a.src="/static/js/main.0d0338ae.js",a.async=!0,document.body.appendChild(a)}</script>
          <link rel="stylesheet" href="/static/css/main.0603c539.css">
      

    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar/avatar-admin.jpg" alt="ookamiAntD">
          <p class="site-author-name" itemprop="name">ookamiAntD</p>
          <p class="site-description motion-element" itemprop="description">码渣 | rocker | 二次元 | 美剧 | 宅</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">27</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/masteranthoneyd" target="_blank" rel="external nofollow noopener noreferrer" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/profile.php?id=100014869064462" target="_blank" rel="external nofollow noopener noreferrer" title="Facebook">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                  Facebook
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/ookamiAntD" target="_blank" rel="external nofollow noopener noreferrer" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="cc-opacity" target="_blank" rel="external nofollow noopener noreferrer">
              <img src="/images/cc-by-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa fa-fw fa-globe"></i>
              大神们的博客
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://ycwalker.com/" title="ciqulover" target="_blank" rel="external nofollow noopener noreferrer">ciqulover</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://codepub.cn" title="IT草根" target="_blank" rel="external nofollow noopener noreferrer">IT草根</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://crossoverjie.top/" title="crossoverJie's Blog" target="_blank" rel="external nofollow noopener noreferrer">crossoverJie's Blog</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://yemengying.com/" title="Giraffe's Home" target="_blank" rel="external nofollow noopener noreferrer">Giraffe's Home</a>
                </li>
              
            </ul>
          </div>
        

        <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="300" height="80" src="//music.163.com/outchain/player?type=2&id=32364704&auto=0&height=66" style="margin-top:20px"></iframe>


      </section>

      
      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#准备工作"><span class="nav-number">1.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Maven-setting-xml配置"><span class="nav-number">2.</span> <span class="nav-text">Maven setting.xml配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#构建基础镜像"><span class="nav-number">3.</span> <span class="nav-text">构建基础镜像</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step1、利用IDEA的Spring-Initializr构建高可用Eureka工程"><span class="nav-number">4.</span> <span class="nav-text">Step1、利用IDEA的Spring Initializr构建高可用Eureka工程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step2、创建Dockerfile"><span class="nav-number">5.</span> <span class="nav-text">Step2、创建Dockerfile</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step3、添加插件"><span class="nav-number">6.</span> <span class="nav-text">Step3、添加插件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step4、构建"><span class="nav-number">7.</span> <span class="nav-text">Step4、构建</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step5、运行"><span class="nav-number">8.</span> <span class="nav-text">Step5、运行</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#高可用Eureka-Server"><span class="nav-number">9.</span> <span class="nav-text">高可用Eureka Server</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#application-yml"><span class="nav-number">9.1.</span> <span class="nav-text">application.yml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-compose-yml"><span class="nav-number">9.2.</span> <span class="nav-text">docker-compose.yml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动"><span class="nav-number">9.3.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Eureka-Edgware-RELEASE版本注册优化"><span class="nav-number">9.4.</span> <span class="nav-text">Eureka Edgware.RELEASE版本注册优化</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Finally"><span class="nav-number">10.</span> <span class="nav-text">Finally</span></a></li></ol></div>
            

          </div>
        </section>
      
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
	
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-flash"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a></span>
</div>


<div class="powered-by">
    Personal Site
</div>

<div class="theme-info">
  Blog -
ookamiAntD | <span class="post-count">共171.7k字</span>
</div>



        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user">本站访客数</i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span>人次</span>
  

  
    <span class="site-pv"><i class="fa fa-eye">本站总访问量</i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span>次</span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">function run_disqus_script(e){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//"+disqus_shortname+".disqus.com/"+e,(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)}var disqus_shortname="ookamiantd",disqus_identifier="2018/spring-cloud-docker-integration/",disqus_title="基于Docker构建高可用Eureka并提交到私有仓库",disqus={load:function(){"object"!=typeof DISQUS&&(!function(){var e=document.createElement("script");e.async=!0,e.type="text/javascript",e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(e)}(),$("#load-disqus").html("评论加载中，请确保你有梯子，若评论长时间未加载则你可能翻墙失败...").fadeOut(9e3))}}</script>
  









  
  
  <script type="text/javascript">function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),n=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);n.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!1,n=r.title.trim().toLowerCase(),s=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),o=decodeURIComponent(r.url),i=-1,l=-1,p=-1;if(""!=n&&a.forEach(function(e,t){i=n.indexOf(e),l=s.indexOf(e),(i>=0||l>=0)&&(c=!0,0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+o+"' class='search-result-title'>"+n+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;u<0&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),n.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("usE0s6JGUeOiMcsVoRuHuv2B-gzGzoHsz","ewm6NEF07r83HbnOr63ptuKH")</script>
  <script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){if(0!==e.length){for(c=0;c<e.length;c++){var t=e[c],i=t.get("url"),s=t.get("time"),l=document.getElementById(i);$(l).find(".leancloud-visitors-count").text(s)}for(var c=0;c<n.length;c++){var i=n[c],l=document.getElementById(i),r=$(l).find(".leancloud-visitors-count");""==r.text()&&r.text(0)}}else o.find(".leancloud-visitors-count").text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){$(document.getElementById(n)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var s=new e,l=new AV.ACL;l.setPublicReadAccess(!0),l.setPublicWriteAccess(!0),s.setACL(l),s.set("title",o),s.set("url",n),s.set("time",1),s.save(null,{success:function(e){$(document.getElementById(n)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script>



  
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>


  


  <script type="text/javascript" color="255,0,204" opacity="0.5" zindex="-2" count="80" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script>



<script type="text/javascript">$("body").delegate(".-mob-share-weixin-qrcode-bg","click",function(){$(".-mob-share-weixin-qrcode-close").trigger("click")})</script></body></html>