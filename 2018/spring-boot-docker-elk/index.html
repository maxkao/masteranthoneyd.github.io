<!doctype html><html class="theme-next muse use-motion" lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta http-equiv="content-language" content="zh-cn"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><style>.pace .pace-progress{background:#ff009e;height:2px}.pace .pace-progress-inner{box-shadow:0 0 10px #e6006b,0 0 5px #ff009e}.pace .pace-activity{border-top-color:#ff009e;border-left-color:#ff009e}</style><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css"><meta name="keywords" content="Java,Spring Boot,Spring,Docker,Elasticsearch,"><link rel="alternate" href="/atom.xml" title="ookamiAntD's Blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.png?v=5.1.0"><meta name="description" content="Preface微服务架构下，微服务在带来良好的设计和架构理念的同时，也带来了运维上的额外复杂性，尤其是在服务部署和服务监控上。单体应用是集中式的，就一个单体跑在一起，部署和管理的时候非常简单，而微服务是一个网状分布的，有很多服务需要维护和管理，对它进行部署和维护的时候则比较复杂。集成Docker之后，我们可以很方便地部"><meta name="keywords" content="Java,Spring Boot,Spring,Docker,Elasticsearch"><meta property="og:type" content="article"><meta property="og:title" content="Spring Boot应用集成Docker并结合Log4j2、Kafka、ELK管理Docker日志"><meta property="og:url" content="http://yangbingdong.com/2018/spring-boot-docker-elk/index.html"><meta property="og:site_name" content="ookamiAntD&#39;s Blog"><meta property="og:description" content="Preface微服务架构下，微服务在带来良好的设计和架构理念的同时，也带来了运维上的额外复杂性，尤其是在服务部署和服务监控上。单体应用是集中式的，就一个单体跑在一起，部署和管理的时候非常简单，而微服务是一个网状分布的，有很多服务需要维护和管理，对它进行部署和维护的时候则比较复杂。集成Docker之后，我们可以很方便地部署以及编排服务，ELK的集中式日志管理可以让我们很方便地聚合Docker日志。"><meta property="og:locale" content="en"><meta property="og:image" content="http://img.yangbingdong.com/img/spring-cloud-docker-integration/java-docker.png"><meta property="og:image" content="http://img.yangbingdong.com/img/spring-boot-learning/log4j2-performance.png"><meta property="og:image" content="http://img.yangbingdong.com/img/spring-cloud-docker-integration/portainer.png"><meta property="og:image" content="http://img.yangbingdong.com/img/spring-cloud-docker-integration/harbor.png"><meta property="og:image" content="http://img.yangbingdong.com/img/spring-cloud-docker-integration/duplicate01.png"><meta property="og:image" content="http://img.yangbingdong.com/img/spring-cloud-docker-integration/duplicate02.png"><meta property="og:image" content="http://img.yangbingdong.com/img/docker-logs-collect/elk-arch1.png"><meta property="og:image" content="http://img.yangbingdong.com/img/docker-logs-collect/luyten.png"><meta property="og:image" content="http://img.yangbingdong.com/img/docker-logs-collect/jar-archive.png"><meta property="og:image" content="http://img.yangbingdong.com/kibana-license.png"><meta property="og:image" content="http://img.yangbingdong.com/img/docker-logs-collect/kibana02.png"><meta property="og:image" content="http://img.yangbingdong.com/img/docker-logs-collect/kibana-full-plugin-button.png"><meta property="og:image" content="http://img.yangbingdong.com/img/docker-logs-collect/kibana-admin-setting.png"><meta property="og:image" content="http://img.yangbingdong.com/img/docker-logs-collect/kibana-page-size.png"><meta property="og:image" content="http://img.yangbingdong.com/img/docker-logs-collect/kibana-timezone.png"><meta property="og:image" content="http://img.yangbingdong.com/img/docker-logs-collect/apm.png"><meta property="og:updated_time" content="2018-11-05T10:17:52.428Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Spring Boot应用集成Docker并结合Log4j2、Kafka、ELK管理Docker日志"><meta name="twitter:description" content="Preface微服务架构下，微服务在带来良好的设计和架构理念的同时，也带来了运维上的额外复杂性，尤其是在服务部署和服务监控上。单体应用是集中式的，就一个单体跑在一起，部署和管理的时候非常简单，而微服务是一个网状分布的，有很多服务需要维护和管理，对它进行部署和维护的时候则比较复杂。集成Docker之后，我们可以很方便地部署以及编排服务，ELK的集中式日志管理可以让我们很方便地聚合Docker日志。"><meta name="twitter:image" content="http://img.yangbingdong.com/img/spring-cloud-docker-integration/java-docker.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",sidebar:{position:"right",display:"always"},fancybox:!0,motion:!0,duoshuo:{userId:"undefined",author:"Author"},algolia:{applicationID:"RI3NF6GUI0",apiKey:"3d33fa60ba30d3b17f37220bb1a36749",indexName:"blogIndex",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://yangbingdong.com/2018/spring-boot-docker-elk/"><title>Spring Boot应用集成Docker并结合Log4j2、Kafka、ELK管理Docker日志 | ookamiAntD's Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e9505ac4e11d464329d615553a72b526";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class="headband"></div><a href="https://github.com/masteranthoneyd/blog" rel="external nofollow noopener noreferrer" target="_blank"><img style="position:absolute;top:0;left:0;border:0" src="https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png"></a><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">ookamiAntD's Blog</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Easy coding,easy life.</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook" rel="section"><i class="menu-item-icon fa fa-fw fa-commenting"></i><br>Message</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div><span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://yangbingdong.com/2018/spring-boot-docker-elk/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ookamiAntD"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar/avatar-admin.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="ookamiAntD's Blog"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="ookamiAntD's Blog" src=""></span></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Spring Boot应用集成Docker并结合Log4j2、Kafka、ELK管理Docker日志</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-02T13:00:19+08:00">2018-04-02 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Programming/" itemprop="url" rel="index"><span itemprop="name">Programming</span> </a></span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Programming/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span> </a></span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Programming/Java/Spring-Boot/" itemprop="url" rel="index"><span itemprop="name">Spring Boot</span> </a></span></span><span id="/2018/spring-boot-docker-elk/" class="leancloud_visitors" data-flag-title="Spring Boot应用集成Docker并结合Log4j2、Kafka、ELK管理Docker日志"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">Visitors </span><span class="leancloud-visitors-count"></span></span><br><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-edit"></i> </span><span class="post-meta-item-text">WordCount:</span> <span class="post-count">7,109字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-text">min2read:</span> <span class="post-count">36分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><img src="http://img.yangbingdong.com/img/spring-cloud-docker-integration/java-docker.png" alt=""></p><h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><blockquote><p>微服务架构下，微服务在带来良好的设计和架构理念的同时，也带来了运维上的额外复杂性，尤其是在服务部署和服务监控上。单体应用是集中式的，就一个单体跑在一起，部署和管理的时候非常简单，而微服务是一个网状分布的，有很多服务需要维护和管理，对它进行部署和维护的时候则比较复杂。集成Docker之后，我们可以很方便地部署以及编排服务，ELK的集中式日志管理可以让我们很方便地聚合Docker日志。</p></blockquote><a id="more"></a><h1 id="Log4j2-Related"><a href="#Log4j2-Related" class="headerlink" title="Log4j2 Related"></a>Log4j2 Related</h1><h2 id="使用Log4j2"><a href="#使用Log4j2" class="headerlink" title="使用Log4j2"></a>使用Log4j2</h2><p>下面是 Log4j2 官方性能测试结果：</p><p><img src="http://img.yangbingdong.com/img/spring-boot-learning/log4j2-performance.png" alt=""></p><h3 id="Maven配置"><a href="#Maven配置" class="headerlink" title="Maven配置"></a>Maven配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring Boot 依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 去除 logback 依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 日志 Log4j2 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Log4j2 异步支持 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lmax<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>disruptor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：</p>
<ul>
<li>需要单独把<code>spring-boot-starter</code>里面的<code>logging</code>去除再引入<code>spring-boot-starter-web</code>，否则后面引入的<code>starter</code>模块带有的<code>logging</code>不会自动去除</li>
<li><code>Disruptor</code>需要<strong>3.3.8</strong>以及以上版本</li>
</ul>
<h3 id="开启全局异步以及Disruptor参数设置"><a href="#开启全局异步以及Disruptor参数设置" class="headerlink" title="开启全局异步以及Disruptor参数设置"></a>开启全局异步以及Disruptor参数设置</h3><blockquote>
<p>官方说明： <strong><em><a href="https://logging.apache.org/log4j/2.x/manual/async.html#AllAsync" rel="external nofollow noopener noreferrer" target="_blank">https://logging.apache.org/log4j/2.x/manual/async.html#AllAsync</a></em></strong></p>
</blockquote>
<p>添加<code>Disruptor</code>依赖后只需要添加启动参数：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dlog4j2.contextSelector=org<span class="selector-class">.apache</span><span class="selector-class">.logging</span><span class="selector-class">.log4j</span><span class="selector-class">.core</span><span class="selector-class">.async</span><span class="selector-class">.AsyncLoggerContextSelector</span></span><br></pre></td></tr></table></figure>
<p>也可以在程序启动时添加系统参数。</p>
<blockquote>
<p>若想知道Disruptor是否生效，可以在<code>AsyncLogger#logMessage</code>中断点</p>
</blockquote>
<p>加大队列参数：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-DAsyncLogger.<span class="attribute">RingBufferSize</span>=262144</span><br><span class="line">-DAsyncLoggerConfig.<span class="attribute">RingBufferSize</span>=262144</span><br></pre></td></tr></table></figure>
<p>设置队列满了时的处理策略：丢弃，否则默认blocking，异步就与同步无异了：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dlog4j2.<span class="attribute">AsyncQueueFullPolicy</span>=Discard</span><br></pre></td></tr></table></figure>
<h3 id="application-yml简单配置"><a href="#application-yml简单配置" class="headerlink" title="application.yml简单配置"></a>application.yml简单配置</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">logging:</span><br><span class="line">  config: classpath:log4j2.xml <span class="comment"># 指定log4j2配置文件的路径，默认就是这个</span></span><br><span class="line">  pattern:</span><br><span class="line">    console: <span class="string">"%clr&#123;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;&#125;&#123;faint&#125; | %clr&#123;%5p&#125; | %clr&#123;%15.15t&#125;&#123;faint&#125; | %clr&#123;%-50.50c&#123;1.&#125;&#125;&#123;cyan&#125; | %5L | %clr&#123;%M&#125;&#123;magenta&#125; | %msg%n%xwEx"</span> <span class="comment"># 控制台日志输出格式</span></span><br></pre></td></tr></table></figure>
<h3 id="log4j2-xml完整配置"><a href="#log4j2-xml完整配置" class="headerlink" title="log4j2.xml完整配置"></a>log4j2.xml完整配置</h3><p>上面是简单的打印，生产环境需要采用以下xml的配置：</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">status</span>=<span class="string">"OFF"</span> <span class="attr">monitorInterval</span>=<span class="string">"30"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"UNKNOWN"</span> <span class="attr">value</span>=<span class="string">"????"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"KAFKA_SERVERS"</span> <span class="attr">value</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;spring:ybd.kafka.bootstrap&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"SERVER_NAME"</span> <span class="attr">value</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;spring:spring.application.name&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"LOG_PATTERN"</span> <span class="attr">value</span>=<span class="string">"%d</span></span></span><span class="template-variable">&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;</span><span class="xml"><span class="tag"><span class="string"> | $</span></span></span><span class="template-variable">&#123;SERVER_NAME&#125;</span><span class="xml"><span class="tag"><span class="string"> | %5p | %X</span></span></span><span class="template-variable">&#123;IP&#125;</span><span class="xml"><span class="tag"><span class="string"> | %X</span></span></span><span class="template-variable">&#123;UA&#125;</span><span class="xml"><span class="tag"><span class="string"> | %t -&gt; %c</span></span></span><span class="template-variable">&#123;1&#125;</span><span class="xml"><span class="tag"><span class="string">#%M:%L | %msg%n%xwEx"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"console"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_OUT"</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"info"</span> <span class="attr">onMatch</span>=<span class="string">"ACCEPT"</span> <span class="attr">onMismatch</span>=<span class="string">"DENY"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;LOG_PATTERN&#125;</span><span class="xml"><span class="tag"><span class="string">"</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Kafka</span> <span class="attr">name</span>=<span class="string">"kafka"</span> <span class="attr">topic</span>=<span class="string">"log-collect"</span> <span class="attr">ignoreExceptions</span>=<span class="string">"false"</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"INFO"</span> <span class="attr">onMatch</span>=<span class="string">"ACCEPT"</span> <span class="attr">onMismatch</span>=<span class="string">"DENY"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;LOG_PATTERN&#125;</span><span class="xml"><span class="tag"><span class="string">"</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"bootstrap.servers"</span>&gt;</span>$</span><span class="template-variable">&#123;KAFKA_SERVERS&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"request.timeout.ms"</span>&gt;</span>5000<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"transaction.timeout.ms"</span>&gt;</span>5000<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"max.block.ms"</span>&gt;</span>3000<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Kafka</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">RollingFile</span> <span class="attr">name</span>=<span class="string">"failoverKafkaLog"</span> <span class="attr">fileName</span>=<span class="string">"./failoverKafka/$</span></span></span><span class="template-variable">&#123;SERVER_NAME&#125;</span><span class="xml"><span class="tag"><span class="string">.log"</span></span></span></span><br><span class="line"><span class="xml">                     filePattern="./failoverKafka/$</span><span class="template-variable">&#123;SERVER_NAME&#125;</span><span class="xml">.%d</span><span class="template-variable">&#123;yyyy-MM-dd&#125;</span><span class="xml">.log"&gt;</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"INFO"</span> <span class="attr">onMatch</span>=<span class="string">"ACCEPT"</span> <span class="attr">onMismatch</span>=<span class="string">"DENY"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">PatternLayout</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Pattern</span>&gt;</span>$</span><span class="template-variable">&#123;LOG_PATTERN&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">Pattern</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">Policies</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">TimeBasedTriggeringPolicy</span> /&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">Policies</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">RollingFile</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Failover</span> <span class="attr">name</span>=<span class="string">"failover"</span> <span class="attr">primary</span>=<span class="string">"kafka"</span> <span class="attr">retryIntervalSeconds</span>=<span class="string">"300"</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">Failovers</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"failoverKafkaLog"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">Failovers</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Failover</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"INFO"</span> <span class="attr">includeLocation</span>=<span class="string">"true"</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"failover"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"console"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>bootstrap.servers</code>是kafka的地址，接入Docker network之后可以配置成<code>kafka:9092</code></li>
<li><code>topic</code>要与Logstash中配置的一致</li>
<li>启用了全局异步需要将<code>includeLocation</code>设为<code>true</code>才能打印路径之类的信息</li>
<li>Kafka地址通过<code>${spring:ybd.kafka.bootstrap}</code>读取配置文件获取，这个需要自己拓展Log4j，具体请看下面的获取Application配置</li>
<li><code>LOG_PATTERN</code>中的<code>%X{IP}</code>、<code>%X{UA}</code>，通过<code>MDC.put(key, value)</code>放进去，同时在<code>&lt;Root&gt;</code>中设置<code>includeLocation=&quot;true&quot;</code>才能获取<code>%t</code>、<code>%c</code>等信息</li>
<li><code>KafkaAppender</code>结合<code>FailoverAppender</code>确保当Kafka Crash时，日志触发Failover，写到文件中，不阻塞程序，进而保证了吞吐。<code>retryIntervalSeconds</code>的默认值是1分钟，是通过异常来切换的，所以可以适量加大间隔。</li>
<li><code>KafkaAppender</code> <code>ignoreExceptions</code> 必须设置为<code>false</code>，否则无法触发Failover</li>
<li><code>KafkaAppender</code> <code>max.block.ms</code>默认是1分钟，当Kafka宕机时，尝试写Kafka需要1分钟才能返回Exception，之后才会触发Failover，当请求量大时，log4j2 队列很快就会打满，之后写日志就Blocking，严重影响到主服务响应</li>
<li>日志的格式采用<code>&quot; | &quot;</code>作为分割符方便后面Logstash进行切分字段</li>
</ul>
<h3 id="也可以使用log4j2-yml"><a href="#也可以使用log4j2-yml" class="headerlink" title="也可以使用log4j2.yml"></a>也可以使用log4j2.yml</h3><p>需要引入依赖以识别：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 加上这个才能辨认到log4j2.yml文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-yaml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>log4j2.yml</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Configuration:</span></span><br><span class="line"><span class="attr">  status:</span> <span class="string">"OFF"</span></span><br><span class="line"><span class="attr">  monitorInterval:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  Properties:</span></span><br><span class="line"><span class="attr">    Property:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">log.level.console</span></span><br><span class="line"><span class="attr">        value:</span> <span class="string">debug</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">PID</span></span><br><span class="line"><span class="attr">        value:</span> <span class="string">????</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">LOG_PATTERN</span></span><br><span class="line"><span class="attr">        value:</span> <span class="string">"%clr&#123;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;&#125;&#123;faint&#125; | %clr&#123;%5p&#125; | %clr&#123;$&#123;sys:PID&#125;&#125;&#123;magenta&#125; | %clr&#123;%15.15t&#125;&#123;faint&#125; | %clr&#123;%-50.50c&#123;1.&#125;&#125;&#123;cyan&#125; | %5L | %clr&#123;%M&#125;&#123;magenta&#125; | %msg%n%xwEx"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  Appenders:</span></span><br><span class="line"><span class="attr">    Console:</span>  <span class="comment">#输出到控制台</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">CONSOLE</span></span><br><span class="line"><span class="attr">      target:</span> <span class="string">SYSTEM_OUT</span></span><br><span class="line"><span class="attr">      ThresholdFilter:</span></span><br><span class="line"><span class="attr">        level:</span> <span class="string">$&#123;sys:log.level.console&#125;</span> <span class="comment"># “sys:”表示：如果VM参数中没指定这个变量值，则使用本文件中定义的缺省全局变量值</span></span><br><span class="line"><span class="attr">        onMatch:</span> <span class="string">ACCEPT</span></span><br><span class="line"><span class="attr">        onMismatch:</span> <span class="string">DENY</span></span><br><span class="line"><span class="attr">      PatternLayout:</span></span><br><span class="line"><span class="attr">        pattern:</span> <span class="string">$&#123;LOG_PATTERN&#125;</span></span><br><span class="line"><span class="attr">        charset:</span> <span class="string">UTF-8</span></span><br><span class="line"><span class="attr">  Loggers:</span></span><br><span class="line"><span class="attr">    Root:</span></span><br><span class="line"><span class="attr">      level:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">      includeLocation:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      AppenderRef:</span></span><br><span class="line"><span class="attr">        - ref:</span> <span class="string">CONSOLE</span></span><br><span class="line"><span class="attr">    AsyncRoot:</span></span><br><span class="line"><span class="attr">      level:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">      includeLocation:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      AppenderRef:</span></span><br><span class="line"><span class="attr">        - ref:</span> <span class="string">CONSOLE</span></span><br></pre></td></tr></table></figure>
<p>更多配置请参照：<em><a href="http://logging.apache.org/log4j/2.x/manual/layouts.html" rel="external nofollow noopener noreferrer" target="_blank">http://logging.apache.org/log4j/2.x/manual/layouts.html</a></em></p>
<h2 id="日志配置文件中获取Application配置"><a href="#日志配置文件中获取Application配置" class="headerlink" title="日志配置文件中获取Application配置"></a>日志配置文件中获取Application配置</h2><h3 id="Logback"><a href="#Logback" class="headerlink" title="Logback"></a>Logback</h3><p>方法1: 使用<code>logback-spring.xml</code>，因为<code>logback.xml</code>加载早于<code>application.properties</code>，所以如果你在<code>logback.xml</code>使用了变量时，而恰好这个变量是写在<code>application.properties</code>时，那么就会获取不到，只要改成<code>logback-spring.xml</code>就可以解决。</p>
<p>方法2: 使用<code>&lt;springProperty&gt;</code>标签，例如：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;springProperty <span class="attribute">scope</span>=<span class="string">"context"</span> <span class="attribute">name</span>=<span class="string">"LOG_HOME"</span> <span class="attribute">source</span>=<span class="string">"logback.file"</span>/&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Log4j2"><a href="#Log4j2" class="headerlink" title="Log4j2"></a>Log4j2</h3><p>只能写一个Lookup：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author ybd</span></span><br><span class="line"><span class="comment"> * @date 18-5-11</span></span><br><span class="line"><span class="comment"> * @contact yangbingdong1994@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Plugin(name = LOOK_UP_PREFIX, category = StrLookup.CATEGORY)</span><br><span class="line"><span class="keyword">public</span> class SpringEnvironmentLookup extends AbstractLookup &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> LOOK_UP_PREFIX = <span class="string">"spring"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> LinkedHashMap profileYmlData;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> LinkedHashMap metaYmlData;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">boolean</span> profileExist;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; <span class="built_in">map</span> = <span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> PROFILE_PREFIX = <span class="string">"application"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> PROFILE_SUFFIX = <span class="string">".yml"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> META_PROFILE = PROFILE_PREFIX + PROFILE_SUFFIX;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> SPRING_PROFILES_ACTIVE = <span class="string">"spring.profiles.active"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			metaYmlData = <span class="keyword">new</span> Yaml().loadAs(<span class="keyword">new</span> ClassPathResource(META_PROFILE).getInputStream(), LinkedHashMap.class);</span><br><span class="line">			Properties properties = System.getProperties();</span><br><span class="line">			<span class="keyword">String</span> active = properties.getProperty(SPRING_PROFILES_ACTIVE);</span><br><span class="line">			<span class="keyword">if</span> (isBlank(active)) &#123;</span><br><span class="line">				active = getValueFromData(SPRING_PROFILES_ACTIVE, metaYmlData);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (isNotBlank(active)) &#123;</span><br><span class="line">				<span class="keyword">String</span> configName = PROFILE_PREFIX + <span class="string">"-"</span> + active + PROFILE_SUFFIX;</span><br><span class="line">				ClassPathResource classPathResource = <span class="keyword">new</span> ClassPathResource(configName);</span><br><span class="line">				profileExist = classPathResource.exists();</span><br><span class="line">				<span class="keyword">if</span> (profileExist) &#123;</span><br><span class="line">					profileYmlData = <span class="keyword">new</span> Yaml().loadAs(classPathResource.getInputStream(), LinkedHashMap.class);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"SpringEnvironmentLookup initialize fail"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">String</span> lookup(LogEvent event, <span class="keyword">String</span> <span class="built_in">key</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">map</span>.computeIfAbsent(<span class="built_in">key</span>, SpringEnvironmentLookup::resolveYmlMapByKey);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">String</span> resolveYmlMapByKey(<span class="keyword">String</span> <span class="built_in">key</span>) &#123;</span><br><span class="line">		Assert.isTrue(isNotBlank(<span class="built_in">key</span>), <span class="string">"key can not be blank!"</span>);</span><br><span class="line">		<span class="keyword">String</span>[] keyChain = <span class="built_in">key</span>.<span class="built_in">split</span>(<span class="string">"\\."</span>);</span><br><span class="line">		<span class="keyword">String</span> value = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (profileExist) &#123;</span><br><span class="line">			value = getValueFromData(<span class="built_in">key</span>, profileYmlData);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (isBlank(value)) &#123;</span><br><span class="line">			value = getValueFromData(<span class="built_in">key</span>, metaYmlData);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> value;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">String</span> getValueFromData(<span class="keyword">String</span> <span class="built_in">key</span>, LinkedHashMap dataMap) &#123;</span><br><span class="line">		<span class="keyword">String</span>[] keyChain = <span class="built_in">key</span>.<span class="built_in">split</span>(<span class="string">"\\."</span>);</span><br><span class="line">		<span class="built_in">int</span> length = keyChain.length;</span><br><span class="line">		<span class="keyword">if</span> (length == <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> getFinalValue(<span class="built_in">key</span>, dataMap);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">String</span> k;</span><br><span class="line">		LinkedHashMap[] mapChain = <span class="keyword">new</span> LinkedHashMap[length];</span><br><span class="line">		mapChain[<span class="number">0</span>] = dataMap;</span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (i == length - <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> getFinalValue(keyChain[i], mapChain[i]);</span><br><span class="line">			&#125;</span><br><span class="line">			k = keyChain[i];</span><br><span class="line">			<span class="keyword">Object</span> o = mapChain[i].<span class="built_in">get</span>(k);</span><br><span class="line">			<span class="keyword">if</span> (Objects.isNull(o)) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (o <span class="keyword">instanceof</span> LinkedHashMap) &#123;</span><br><span class="line">				mapChain[i + <span class="number">1</span>] = (LinkedHashMap) o;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">String</span> getFinalValue(<span class="keyword">String</span> k, LinkedHashMap ymlData) &#123;</span><br><span class="line">		<span class="keyword">return</span> defaultIfNull((<span class="keyword">String</span>) ymlData.<span class="built_in">get</span>(k), <span class="string">""</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在<code>log4j2.xml</code>中这样使用 <code>${spring:spring.application.name}</code></p>
<h2 id="自定义字段"><a href="#自定义字段" class="headerlink" title="自定义字段"></a>自定义字段</h2><p>可以利用<code>MDC</code>实现当前线程自定义字段</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MDC.<span class="keyword">put</span>(<span class="string">"IP"</span>, IpUtil.getIpAddr(request));</span><br></pre></td></tr></table></figure>
<p><code>log4j2.xml</code>中这样获取<code>%X{IP}</code></p>
<h1 id="Spring-Boot-Docker-Integration"><a href="#Spring-Boot-Docker-Integration" class="headerlink" title="Spring Boot Docker Integration"></a>Spring Boot Docker Integration</h1><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ul>
<li>Docker</li>
<li>IDE（使用IDEA）</li>
<li>Maven环境</li>
<li>Docker私有仓库，可以使用Harbor(<strong><em><a href="/2018/docker-visual-management-and-orchestrate-tools/#Harbor">Ubuntu中安装Harbor</a></em></strong>)</li>
</ul>
<p>集成Docker需要的插件<code>docker-maven-plugin</code>：<em><a href="https://github.com/spotify/docker-maven-plugin" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/spotify/docker-maven-plugin</a></em></p>
<h2 id="安全认证配置"><a href="#安全认证配置" class="headerlink" title="安全认证配置"></a>安全认证配置</h2><blockquote>
<p>当我们 push 镜像到 Docker 仓库中时，不管是共有还是私有，经常会需要安全认证，登录完成之后才可以进行操作。当然，我们可以通过命令行 <code>docker login -u user_name -p password docker_registry_host</code> 登录，但是对于自动化流程来说，就不是很方便了。使用 docker-maven-plugin 插件我们可以很容易实现安全认证。</p>
</blockquote>
<h3 id="普通配置"><a href="#普通配置" class="headerlink" title="普通配置"></a>普通配置</h3><p><code>settings.xml</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>docker-registry<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>12345678<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">email</span>&gt;</span>yangbingdong1994@gmail.com<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Maven-密码加密配置"><a href="#Maven-密码加密配置" class="headerlink" title="Maven 密码加密配置"></a>Maven 密码加密配置</h3><p><code>settings.xml</code>配置私有库的访问：</p>
<p>首先使用你的私有仓库访问密码生成主密码：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn <span class="comment">--encrypt-master-password &lt;password&gt;</span></span><br></pre></td></tr></table></figure>
<p>其次在<code>settings.xml</code>文件的同级目录创建<code>settings-security.xml</code>文件，将主密码写入：</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">settingsSecurity</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">master</span>&gt;</span></span><span class="template-variable">&#123;Ns0JM49fW9gHMTZ44n*****************=&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">master</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">settingsSecurity</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>最后使用你的私有仓库访问密码生成服务密码，将生成的密码写入到<code>settings.xml</code>的<code>&lt;services&gt;</code>中（可能会提示目录不存在，解决方法是创建一个<code>.m2</code>目录并把<code>settings-security.xml</code>复制进去）</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn --encrypt-password <span class="xml"><span class="tag">&lt;<span class="name">password</span>&gt;</span></span></span><br><span class="line">&#123;D9YIyWYvtYsHayLjIenj<span class="strong">*****</span><span class="strong">*****</span>*=&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>docker-registry<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">password</span>&gt;</span></span><span class="template-variable">&#123;gKLNhblk/SQHBMooM******************=&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">password</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">email</span>&gt;</span>yangbingdong1994@gmail.com<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h2 id="构建基础镜像"><a href="#构建基础镜像" class="headerlink" title="构建基础镜像"></a>构建基础镜像</h2><p>Dockerfile：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> frolvlad/alpine-oraclejdk8:slim</span><br><span class="line">MAINTAINER ybd &lt;yangbingdong1994@gmail.com&gt;</span><br><span class="line">ARG TZ </span><br><span class="line">ARG HTTP_PROXY</span><br><span class="line">ENV <span class="attribute">TZ</span>=<span class="variable">$&#123;TZ:-"Asia/Shanghai"&#125;</span> <span class="attribute">http_proxy</span>=<span class="variable">$&#123;HTTP_PROXY&#125;</span> <span class="attribute">https_proxy</span>=<span class="variable">$&#123;HTTP_PROXY&#125;</span></span><br><span class="line"><span class="builtin-name">RUN</span> apk update &amp;&amp; \</span><br><span class="line">    apk <span class="builtin-name">add</span> --no-cache &amp;&amp; \</span><br><span class="line">    apk <span class="builtin-name">add</span> curl bash tree tzdata &amp;&amp; \</span><br><span class="line">    ln -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; \</span><br><span class="line">    echo <span class="variable">$TZ</span> &gt; /etc/timezone </span><br><span class="line">ENV http_proxy=</span><br><span class="line">ENV https_proxy=</span><br></pre></td></tr></table></figure>
<p>构建：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">docker</span> <span class="keyword">build </span>--<span class="keyword">build-arg </span>HTTP_PROXY<span class="number">=192</span>.<span class="number">168</span>.<span class="number">6</span>.<span class="number">113</span>:<span class="number">8118</span> -t yangbingdong/docker-oraclejdk8 .</span><br></pre></td></tr></table></figure>
<p>其中<code>HTTP_PROXY</code>是http代理，通过<code>--build-arg</code>参数传入，注意<strong>不能</strong>是<code>127.0.0.1</code>或<code>localhost</code>。</p>
<h2 id="开始集成"><a href="#开始集成" class="headerlink" title="开始集成"></a>开始集成</h2><h3 id="编写Dockerfile"><a href="#编写Dockerfile" class="headerlink" title="编写Dockerfile"></a>编写Dockerfile</h3><p>在<code>src/main</code>下面新建<code>docker</code>文件夹，并创建<code>Dockerfile</code>：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FROM yangbingdong/docker-oraclejdk8:latest</span><br><span class="line">MAINTAINER yangbingdong &lt;yangbingdong1994@gmail.com&gt;</span><br><span class="line">ENV PROJECT_NAME=<span class="string">"@project.build.finalName@.@project.packaging@"</span> JAVA_OPTS=<span class="string">""</span></span><br><span class="line">ADD <span class="variable">$PROJECT_NAME</span> app.jar</span><br><span class="line">RUN sh -c <span class="string">'touch /app.jar'</span></span><br><span class="line">ENTRYPOINT exec java <span class="variable">$JAVA_OPTS</span> -Djava<span class="selector-class">.security</span><span class="selector-class">.egd</span>=file:/dev/./urandom -DLog4jContextSelector=org<span class="selector-class">.apache</span><span class="selector-class">.logging</span><span class="selector-class">.log4j</span><span class="selector-class">.core</span><span class="selector-class">.async</span><span class="selector-class">.AsyncLoggerContextSelector</span> -Dspring<span class="selector-class">.profiles</span><span class="selector-class">.active</span>=$&#123;ACTIVE:-docker&#125; -jar /app.jar</span><br></pre></td></tr></table></figure>
<ul>
<li>通过<code>@@</code>动态获取打包后的项目名（需要插件，下面会介绍）</li>
<li><code>Dspring.profiles.active=${ACTIVE:-docker}</code>可以通过docker启动命令<code>-e ACTIVE=docker</code>参数修改配置</li>
</ul>
<h4 id="注意PID"><a href="#注意PID" class="headerlink" title="注意PID"></a>注意PID</h4><p>如果需要Java程序监听到<code>sigterm</code>信号，那么Java程序的<code>PID</code>必须是1，可以使用<code>ENTRYPOINT exec java -jar ...</code>这种方式实现。 </p>
<h3 id="pom文件添加构建Docker镜像的相关插件"><a href="#pom文件添加构建Docker镜像的相关插件" class="headerlink" title="pom文件添加构建Docker镜像的相关插件"></a>pom文件添加构建Docker镜像的相关插件</h3><blockquote>
<p>继承<code>spring-boot-starter-parent</code>，除了<code>docker-maven-plugin</code>，下面的3个插件都不用填写版本号，因为parent中已经定义版本号</p>
</blockquote>
<h4 id="spring-boot-maven-plugin"><a href="#spring-boot-maven-plugin" class="headerlink" title="spring-boot-maven-plugin"></a>spring-boot-maven-plugin</h4><p>这个不用多介绍了，打包Spring Boot Jar包的</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="maven-resources-plugin"><a href="#maven-resources-plugin" class="headerlink" title="maven-resources-plugin"></a>maven-resources-plugin</h4><p>resources插件，使用<code>@变量@</code>形式获取Maven变量到Dockerfile中（同时拷贝构建的Jar包到Dockerfile同一目录中，这种方式是方便手动构建镜像）</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resources-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>prepare-dockerfile<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>validate<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>copy-resources<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="comment">&lt;!-- 编译后Dockerfile的输出位置 --&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>$</span><span class="template-variable">&#123;dockerfile.compiled.position&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span></span><br><span class="line"><span class="xml">                	<span class="comment">&lt;!-- Dockerfile位置 --&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$</span><span class="template-variable">&#123;project.basedir&#125;</span><span class="xml">/src/main/docker<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 将Jar复制到target的docker目录中，因为真正的Dockerfile也是在里面，方便使用docker build命令构建Docker镜像 --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>copy-jar<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>copy-resources<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>$</span><span class="template-variable">&#123;dockerfile.compiled.position&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$</span><span class="template-variable">&#123;project.build.directory&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">include</span>&gt;</span>*.jar<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h4 id="build-helper-maven-plugin"><a href="#build-helper-maven-plugin" class="headerlink" title="build-helper-maven-plugin"></a>build-helper-maven-plugin</h4><p>这个是为了给镜像添加基于时间戳的版本号，maven也有自带的获取时间戳的变量<code>maven.build.timestamp.format</code> + <code>maven.build.timestamp</code>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;maven.build.timestamp.format&gt;yyyy-MM-dd_HH-mm-ss&lt;maven.build.timestamp.format&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取时间戳</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;maven.build.timestamp&#125;</span></span><br></pre></td></tr></table></figure>
<p>但是这个时区是<code>UTC</code>，接近于格林尼治标准时间，所以出来的时间会比但前的时间慢8个小时。</p>
<p>如果要使用<code>GMT+8</code>，就需要<code>build-helper-maven-plugin</code>插件，当然也有其他的实现方式，这里不做展开。</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.mojo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>build-helper-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>timestamp-property<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>timestamp-property<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    	<span class="comment">&lt;!-- 其他地方可通过$</span></span><span class="template-variable">&#123;timestamp&#125;</span><span class="xml"><span class="comment">获取时间戳 --&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">name</span>&gt;</span>timestamp<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>yyyyMMddHHmm<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">timeZone</span>&gt;</span>GMT+8<span class="tag">&lt;/<span class="name">timeZone</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>然后可以在pom中使用<code>${timestamp}</code>获取时间戳。</p>
<p>当然，也可以使用<strong>另外一种方式实现</strong>，打包前<code>export</code>一个格式化日期的环境变量，<code>pom.xml</code>中获取这个变量：</p>
<ul>
<li><code>export DOCKER_IMAGE_TAGE_DATE=yyyy-MM-dd_HH-mm</code></li>
<li><code>mvn help:system</code>可查看所有环境变量</li>
<li>所有的环境变量都可以用以<code>env.</code>开头的Maven属性引用: <code>${env.DOCKER_IMAGE_TAGE_DATE}</code></li>
</ul>
<h4 id="docker-maven-plugin"><a href="#docker-maven-plugin" class="headerlink" title="docker-maven-plugin"></a>docker-maven-plugin</h4><p>这也是集成并构建Docker镜像的关键</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;docker-maven-plugin.version&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!--  --&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- 绑定打包阶段执行Docker镜像操作 --&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="comment">&lt;!-- 打包阶段构建镜像 --&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>build<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="comment">&lt;!-- 部署阶段Push镜像 --&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>push-image<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>deploy<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>push<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="comment">&lt;!-- Push指定镜像 --&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="comment">&lt;!--&lt;imageName&gt;$</span></span><span class="template-variable">&#123;docker.registry.url&#125;</span><span class="xml"><span class="comment">/$</span></span><span class="template-variable">&#123;docker.registry.name&#125;</span><span class="xml"><span class="comment">/$</span></span><span class="template-variable">&#123;project.artifactId&#125;</span><span class="xml"><span class="comment">:$</span></span><span class="template-variable">&#123;docker-latest-tag&#125;</span><span class="xml"><span class="comment">&lt;/imageName&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="comment">&lt;!--suppress UnresolvedMavenProperty --&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">imageName</span>&gt;</span>$</span><span class="template-variable">&#123;docker.registry.url&#125;</span><span class="xml">/$</span><span class="template-variable">&#123;docker.registry.name&#125;</span><span class="xml">/$</span><span class="template-variable">&#123;project.artifactId&#125;</span><span class="xml">:$</span><span class="template-variable">&#123;timestamp&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">imageName</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 是否跳过所有构建Docker镜像阶段 --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">skipDocker</span>&gt;</span>$</span><span class="template-variable">&#123;docker.skip.build&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">skipDocker</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 是否跳过Push阶段 --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">skipDockerPush</span>&gt;</span>$</span><span class="template-variable">&#123;docker.skip.push&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">skipDockerPush</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">forceTags</span>&gt;</span>true<span class="tag">&lt;/<span class="name">forceTags</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 最大重试次数 --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">retryPushCount</span>&gt;</span>2<span class="tag">&lt;/<span class="name">retryPushCount</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">imageTags</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="comment">&lt;!-- 使用时间戳版本号 --&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="comment">&lt;!--suppress UnresolvedMavenProperty --&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">imageTag</span>&gt;</span>$</span><span class="template-variable">&#123;timestamp&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">imageTag</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">imageTags</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 配置镜像名称，遵循Docker的命名规范： springio/image --&gt;</span><span class="tag">&lt;<span class="name">imageName</span>&gt;</span>$</span><span class="template-variable">&#123;docker.registry.url&#125;</span><span class="xml">/$</span><span class="template-variable">&#123;docker.registry.name&#125;</span><span class="xml">/$</span><span class="template-variable">&#123;project.artifactId&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">imageName</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- Dockerfile位置，由于配置了编译时动态获取Maven变量，真正的Dockerfile位于位于编译后位置 --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dockerDirectory</span>&gt;</span>$</span><span class="template-variable">&#123;dockerfile.compiled.position&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">dockerDirectory</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>/<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$</span><span class="template-variable">&#123;project.build.directory&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>$</span><span class="template-variable">&#123;project.build.finalName&#125;</span><span class="xml">.jar<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 被推送服务器的配置ID，与setting中的一直 --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">serverId</span>&gt;</span>docker-registry<span class="tag">&lt;/<span class="name">serverId</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!--&lt;registryUrl&gt;$</span></span><span class="template-variable">&#123;docker.registry.url&#125;</span><span class="xml"><span class="comment">&lt;/registryUrl&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>主要<code>properties</code>:</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- ########## Docker 相关变量 ########## --&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">docker-maven-plugin.version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">docker-maven-plugin.version</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- resource插件编译Dockerfile后的位置--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">dockerfile.compiled.position</span>&gt;</span>$</span><span class="template-variable">&#123;project.build.directory&#125;</span><span class="xml">/docker<span class="tag">&lt;/<span class="name">dockerfile.compiled.position</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">docker.skip.build</span>&gt;</span>false<span class="tag">&lt;/<span class="name">docker.skip.build</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">docker.skip.push</span>&gt;</span>false<span class="tag">&lt;/<span class="name">docker.push.image</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">docker.registry.url</span>&gt;</span>192.168.0.202:8080<span class="tag">&lt;/<span class="name">docker.registry.url</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">docker.registry.name</span>&gt;</span>dev-images<span class="tag">&lt;/<span class="name">docker.registry.name</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">docker-latest-tag</span>&gt;</span>latest<span class="tag">&lt;/<span class="name">docker-latest-tag</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>说明</strong>：</p>
<ul>
<li>这里的<code>serverId</code>要与maven <code>setting.xml</code>里面的一样</li>
</ul>
<ul>
<li>Dockerfile构建文件在<code>src/main/docker</code>中</li>
<li>如果Dockerfile文件需要maven构建参数（比如需要构建后的打包文件名等），则使用<code>@@</code>占位符（如<code>@project.build.finalName@</code>）原因是Sping Boot 的pom将resource插件的占位符由<code>${}</code>改为<code>@@</code>，非继承Spring Boot 的pom文件，则使用<code>${}</code>占位符</li>
<li>如果不需要动态生成Dockerfile文件，则可以将Dockerfile资源拷贝部分放入<code>docker-maven-plugin</code>插件的<code>&lt;resources&gt;</code>配置里</li>
<li><strong><code>spring-boot-maven-plugin</code>插件一定要在其他构建插件之上，否则打包文件会有问题。</strong></li>
</ul>
<p><code>docker-maven-plugin</code> 插件还提供了很多很实用的配置，稍微列举几个参数吧。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;forceTags&gt;true&lt;/forceTags&gt;</code></td>
<td>build 时强制覆盖 tag，配合 imageTags 使用</td>
<td>false</td>
</tr>
<tr>
<td><code>&lt;noCache&gt;true&lt;/noCache&gt;</code></td>
<td>build 时，指定 –no-cache 不使用缓存</td>
<td>false</td>
</tr>
<tr>
<td><code>&lt;pullOnBuild&gt;true&lt;/pullOnBuild&gt;</code></td>
<td>build 时，指定 –pull=true 每次都重新拉取基础镜像</td>
<td>false</td>
</tr>
<tr>
<td><code>&lt;pushImage&gt;true&lt;/pushImage&gt;</code></td>
<td>build 完成后 push 镜像</td>
<td>false</td>
</tr>
<tr>
<td><code>&lt;pushImageTag&gt;true&lt;/pushImageTag&gt;</code></td>
<td>build 完成后，push 指定 tag 的镜像，配合 imageTags 使用</td>
<td>false</td>
</tr>
<tr>
<td><code>&lt;retryPushCount&gt;5&lt;/retryPushCount&gt;</code></td>
<td>push 镜像失败，重试次数</td>
<td>5</td>
</tr>
<tr>
<td><code>&lt;retryPushTimeout&gt;10&lt;/retryPushTimeout&gt;</code></td>
<td>push 镜像失败，重试时间</td>
<td>10s</td>
</tr>
<tr>
<td><code>&lt;rm&gt;true&lt;/rm&gt;</code></td>
<td>build 时，指定 –rm=true 即 build 完成后删除中间容器</td>
<td>false</td>
</tr>
<tr>
<td><code>&lt;useGitCommitId&gt;true&lt;/useGitCommitId&gt;</code></td>
<td>build 时，使用最近的 git commit id 前7位作为tag，例如：image:b50b604，前提是不配置 newName</td>
<td>false</td>
</tr>
</tbody>
</table>
<p>更多参数可查看插件中的定义。</p>
<h3 id="命令构建"><a href="#命令构建" class="headerlink" title="命令构建"></a>命令构建</h3><p>如果<code>&lt;skipDockerPush&gt;false&lt;/skipDockerPush&gt;</code>则install阶段将不提交Docker镜像，只有maven的<code>deploy</code>阶段才提交。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mvn </span>clean install</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[INFO] <span class="comment">--- spring-boot-maven-plugin:1.5.9.RELEASE:repackage (default) @ eureka-center-server ---</span></span><br><span class="line">[INFO] </span><br><span class="line">[INFO] <span class="comment">--- docker-maven-plugin:1.0.0:build (default) @ eureka-center-server ---</span></span><br><span class="line">[INFO] Using authentication suppliers: [ConfigFileRegistryAuthSupplier, NoOpRegistryAuthSupplier]</span><br><span class="line">[WARNING] Ignoring run because dockerDirectory is <span class="keyword">set</span></span><br><span class="line">[INFO] Copying /home/ybd/<span class="keyword">data</span>/git-repo/bitbucket/ms-iba/eureka-center-<span class="keyword">server</span>/target/eureka-center-<span class="keyword">server</span><span class="number">-0.0</span><span class="number">.1</span>-SNAPSHOT.jar -&gt; /home/ybd/<span class="keyword">data</span>/git-repo/bitbucket/ms-iba/eureka-center-<span class="keyword">server</span>/target/docker/eureka-center-<span class="keyword">server</span><span class="number">-0.0</span><span class="number">.1</span>-SNAPSHOT.jar</span><br><span class="line">[INFO] Copying /home/ybd/<span class="keyword">data</span>/git-repo/bitbucket/ms-iba/eureka-center-<span class="keyword">server</span>/target/docker/eureka-center-<span class="keyword">server</span><span class="number">-0.0</span><span class="number">.1</span>-SNAPSHOT.jar -&gt; /home/ybd/<span class="keyword">data</span>/git-repo/bitbucket/ms-iba/eureka-center-<span class="keyword">server</span>/target/docker/eureka-center-<span class="keyword">server</span><span class="number">-0.0</span><span class="number">.1</span>-SNAPSHOT.jar</span><br><span class="line">[INFO] Copying /home/ybd/<span class="keyword">data</span>/git-repo/bitbucket/ms-iba/eureka-center-<span class="keyword">server</span>/target/docker/Dockerfile -&gt; /home/ybd/<span class="keyword">data</span>/git-repo/bitbucket/ms-iba/eureka-center-<span class="keyword">server</span>/target/docker/Dockerfile</span><br><span class="line">[INFO] Building image <span class="number">192.168</span><span class="number">.6</span><span class="number">.113</span>:<span class="number">8888</span>/discover-<span class="keyword">server</span>/eureka-center-<span class="keyword">server</span></span><br><span class="line">Step <span class="number">1</span>/<span class="number">7</span> : <span class="keyword">FROM</span> frolvlad/alpine-oraclejdk8:slim</span><br><span class="line"></span><br><span class="line"> <span class="comment">---&gt; 491f45037124</span></span><br><span class="line">Step <span class="number">2</span>/<span class="number">7</span> : MAINTAINER ybd &lt;yangbingdong1994@gmail.com&gt;</span><br><span class="line"></span><br><span class="line"> <span class="comment">---&gt; Using cache</span></span><br><span class="line"> <span class="comment">---&gt; 016c2033bd32</span></span><br><span class="line">Step <span class="number">3</span>/<span class="number">7</span> : VOLUME /tmp</span><br><span class="line"></span><br><span class="line"> <span class="comment">---&gt; Using cache</span></span><br><span class="line"> <span class="comment">---&gt; d2a287b6ed52</span></span><br><span class="line">Step <span class="number">4</span>/<span class="number">7</span> : ENV PROJECT_NAME=<span class="string">"eureka-center-server-0.0.1-SNAPSHOT.jar"</span> JAVA_OPTS=<span class="string">""</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">---&gt; Using cache</span></span><br><span class="line"> <span class="comment">---&gt; 34565a7de714</span></span><br><span class="line">Step <span class="number">5</span>/<span class="number">7</span> : <span class="keyword">ADD</span> $PROJECT_NAME app.jar</span><br><span class="line"></span><br><span class="line"> <span class="comment">---&gt; 64d9055ce969</span></span><br><span class="line">Step <span class="number">6</span>/<span class="number">7</span> : RUN sh -c <span class="string">'touch /app.jar'</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">---&gt; Running in 66f4eb550a57</span></span><br><span class="line">Removing intermediate <span class="keyword">container</span> <span class="number">66</span>f4eb550a57</span><br><span class="line"> <span class="comment">---&gt; 93486965cad9</span></span><br><span class="line">Step <span class="number">7</span>/<span class="number">7</span> : CMD [<span class="string">"sh"</span>, <span class="string">"-c"</span>, <span class="string">"java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -Dspring.profiles.active=$&#123;ACTIVE:-docker&#125;  -jar /app.jar"</span>]</span><br><span class="line"></span><br><span class="line"> <span class="comment">---&gt; Running in 8b42c471791f</span></span><br><span class="line">Removing intermediate <span class="keyword">container</span> <span class="number">8</span>b42c471791f</span><br><span class="line"> <span class="comment">---&gt; 2eb3dbbab6c5</span></span><br><span class="line">ProgressMessage&#123;<span class="keyword">id</span>=<span class="literal">null</span>, <span class="keyword">status</span>=<span class="literal">null</span>, stream=<span class="literal">null</span>, <span class="keyword">error</span>=<span class="literal">null</span>, progress=<span class="literal">null</span>, progressDetail=<span class="literal">null</span>&#125;</span><br><span class="line">Successfully built <span class="number">2</span>eb3dbbab6c5</span><br><span class="line">Successfully tagged <span class="number">192.168</span><span class="number">.6</span><span class="number">.113</span>:<span class="number">8888</span>/discover-<span class="keyword">server</span>/eureka-center-<span class="keyword">server</span>:latest</span><br><span class="line">[INFO] Built <span class="number">192.168</span><span class="number">.6</span><span class="number">.113</span>:<span class="number">8888</span>/discover-<span class="keyword">server</span>/eureka-center-<span class="keyword">server</span></span><br><span class="line">[INFO] Tagging <span class="number">192.168</span><span class="number">.6</span><span class="number">.113</span>:<span class="number">8888</span>/discover-<span class="keyword">server</span>/eureka-center-<span class="keyword">server</span> <span class="keyword">with</span> <span class="number">0.0</span><span class="number">.1</span>-<span class="keyword">SNAPSHOT</span></span><br><span class="line">[INFO] Tagging <span class="number">192.168</span><span class="number">.6</span><span class="number">.113</span>:<span class="number">8888</span>/discover-<span class="keyword">server</span>/eureka-center-<span class="keyword">server</span> <span class="keyword">with</span> latest</span><br><span class="line">[INFO] Pushing <span class="number">192.168</span><span class="number">.6</span><span class="number">.113</span>:<span class="number">8888</span>/discover-<span class="keyword">server</span>/eureka-center-<span class="keyword">server</span></span><br><span class="line">The push refers <span class="keyword">to</span> repository [<span class="number">192.168</span><span class="number">.6</span><span class="number">.113</span>:<span class="number">8888</span>/discover-<span class="keyword">server</span>/eureka-center-<span class="keyword">server</span>]</span><br><span class="line"><span class="number">40566</span>d372b69: Pushed </span><br><span class="line"><span class="number">40566</span>d372b69: Layer already <span class="keyword">exists</span> </span><br><span class="line"><span class="number">4</span>fd38f0d6712: Layer already <span class="keyword">exists</span> </span><br><span class="line">d7cd646c41bd: Layer already <span class="keyword">exists</span> </span><br><span class="line">ced237d13962: Layer already <span class="keyword">exists</span> </span><br><span class="line"><span class="number">2</span>aebd096e0e2: Layer already <span class="keyword">exists</span> </span><br><span class="line"><span class="literal">null</span>: <span class="literal">null</span> </span><br><span class="line"><span class="literal">null</span>: <span class="literal">null</span> </span><br><span class="line">[INFO] </span><br><span class="line">[INFO] <span class="comment">--- maven-install-plugin:2.4:install (default-install) @ eureka-center-server ---</span></span><br><span class="line">[INFO] Installing /home/ybd/<span class="keyword">data</span>/git-repo/bitbucket/ms-iba/eureka-center-<span class="keyword">server</span>/target/eureka-center-<span class="keyword">server</span><span class="number">-0.0</span><span class="number">.1</span>-SNAPSHOT.jar <span class="keyword">to</span> /home/ybd/<span class="keyword">data</span>/application/maven/maven-repo/com/iba/<span class="keyword">server</span>/eureka-center-<span class="keyword">server</span>/<span class="number">0.0</span><span class="number">.1</span>-<span class="keyword">SNAPSHOT</span>/eureka-center-<span class="keyword">server</span><span class="number">-0.0</span><span class="number">.1</span>-SNAPSHOT.jar</span><br><span class="line">[INFO] Installing /home/ybd/<span class="keyword">data</span>/git-repo/bitbucket/ms-iba/eureka-center-<span class="keyword">server</span>/pom.xml <span class="keyword">to</span> /home/ybd/<span class="keyword">data</span>/application/maven/maven-repo/com/iba/<span class="keyword">server</span>/eureka-center-<span class="keyword">server</span>/<span class="number">0.0</span><span class="number">.1</span>-<span class="keyword">SNAPSHOT</span>/eureka-center-<span class="keyword">server</span><span class="number">-0.0</span><span class="number">.1</span>-SNAPSHOT.pom</span><br><span class="line">[INFO] <span class="comment">------------------------------------------------------------------------</span></span><br><span class="line">[INFO] <span class="keyword">BUILD</span> <span class="keyword">SUCCESS</span></span><br><span class="line">[INFO] <span class="comment">------------------------------------------------------------------------</span></span><br><span class="line">[INFO] Total <span class="keyword">time</span>: <span class="number">15.962</span> s</span><br><span class="line">[INFO] Finished <span class="keyword">at</span>: <span class="number">2017</span><span class="number">-12</span><span class="number">-25</span>T13:<span class="number">33</span>:<span class="number">39</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line">[INFO] <span class="keyword">Final</span> <span class="keyword">Memory</span>: <span class="number">55</span>M/<span class="number">591</span>M</span><br><span class="line">[INFO] <span class="comment">------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>
<p>可以看到本地以及私有仓库都多了一个镜像：</p>
<p><img src="http://img.yangbingdong.com/img/spring-cloud-docker-integration/portainer.png" alt=""></p>
<p><img src="http://img.yangbingdong.com/img/spring-cloud-docker-integration/harbor.png" alt=""></p>
<p><strong>此处有个疑问</strong>，很明显看得出来这里上传了两个一样大小的包，不知道是不是同一个jar包，但id又不一样：</p>
<p><img src="http://img.yangbingdong.com/img/spring-cloud-docker-integration/duplicate01.png" alt=""></p>
<p><img src="http://img.yangbingdong.com/img/spring-cloud-docker-integration/duplicate02.png" alt=""></p>
<h3 id="运行Docker"><a href="#运行Docker" class="headerlink" title="运行Docker"></a>运行Docker</h3><p>运行程序</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="builtin-name">run</span> --name some-server -e <span class="attribute">ACTIVE</span>=docker -p 8080:8080 -d [IMAGE]</span><br></pre></td></tr></table></figure>
<h3 id="添加运行时JVM参数"><a href="#添加运行时JVM参数" class="headerlink" title="添加运行时JVM参数"></a>添加运行时JVM参数</h3><p>只需要在Docker启动命令中加上<code>-e &quot;JAVA_OPTS=-Xmx128m&quot;</code>即可</p>
<h2 id="Docker-Swarm环境下获取ClientIp"><a href="#Docker-Swarm环境下获取ClientIp" class="headerlink" title="Docker Swarm环境下获取ClientIp"></a>Docker Swarm环境下获取ClientIp</h2><p>在Docker Swarm环境中，服务中获取到的ClientIp永远是<code>10.255.0.X</code>这样的Ip，搜索了一大圈，最终的解决方安是通过Nginx转发中添加参数，后端再获取。</p>
<p>在<code>location</code>中添加</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_set_header    X-Forwarded-<span class="keyword">For</span>  $proxy_add_x_forwarded_for<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>后端获取第一个Ip。</p>
<h2 id="Demo地址"><a href="#Demo地址" class="headerlink" title="Demo地址"></a>Demo地址</h2><p><strong><em><a href="https://github.com/masteranthoneyd/spring-boot-learning/tree/master/spring-boot-docker" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/masteranthoneyd/spring-boot-learning/tree/master/spring-boot-docker</a></em></strong></p>
<h1 id="Kafka、ELK-collect-logs"><a href="#Kafka、ELK-collect-logs" class="headerlink" title="Kafka、ELK collect logs"></a>Kafka、ELK collect logs</h1><p><img src="http://img.yangbingdong.com/img/docker-logs-collect/elk-arch1.png" alt=""></p>
<p>传统的应用可以将日志存到日志中，但集成Docker之后，日志怎么处理？放到容器的某个目录然后挂在出来？这样也可以，但这样就相当于给容器与外界绑定了一个状态，弹性伸缩怎么办？个人还是觉得通过队列与ELK管理Docker日志比较合理，而且Log4j2<strong>原生支持Kafka的Appender</strong>。</p>
<h2 id="镜像准备"><a href="#镜像准备" class="headerlink" title="镜像准备"></a>镜像准备</h2><p>Docker Hub中的ELK镜像并不是最新版本的，我们需要到官方的网站获取最新的镜像：<strong><em><a href="https://www.docker.elastic.co" rel="external nofollow noopener noreferrer" target="_blank">https://www.docker.elastic.co</a></em></strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker pull zookeeper</span><br><span class="line">docker pull wurstmeister/kafka:<span class="number">1.1</span>.<span class="number">0</span></span><br><span class="line">docker pull docker<span class="selector-class">.elastic</span><span class="selector-class">.co</span>/elasticsearch/elasticsearch:<span class="number">6.3</span>.<span class="number">0</span></span><br><span class="line">docker pull docker<span class="selector-class">.elastic</span><span class="selector-class">.co</span>/kibana/kibana:<span class="number">6.3</span>.<span class="number">0</span></span><br><span class="line">docker pull docker<span class="selector-class">.elastic</span><span class="selector-class">.co</span>/logstash/logstash:<span class="number">6.3</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>注意ELK版本最好保持一致</p>
<h2 id="启动Kafka与Zookeeper"><a href="#启动Kafka与Zookeeper" class="headerlink" title="启动Kafka与Zookeeper"></a>启动Kafka与Zookeeper</h2><p>这里直接使用docker-compose（需要先创建外部网络）:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.4'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  zoo:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">zookeeper:latest</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"2181:2181"</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      backend:</span></span><br><span class="line"><span class="attr">        aliases:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">zoo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  kafka:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">wurstmeister/kafka:1.1.0</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"9092:9092"</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">KAFKA_PORT=9092</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">KAFKA_ADVERTISED_HOST_NAME=192.168.6.113</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">KAFKA_ZOOKEEPER_CONNECT=zoo:2181</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">KAFKA_ADVERTISED_PORT=9092</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">zoo</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      backend:</span></span><br><span class="line"><span class="attr">        aliases:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">kafka</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  backend:</span></span><br><span class="line"><span class="attr">    external:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">backend</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>KAFKA_ADVERTISED_HOST_NAME</code>是内网IP，本地调试用，Docker环境下换成<code>kafka</code>（与别名<code>aliases的值保持一致</code>），其他Docker应用可通过<code>kafka:9092</code>这个域名访问到Kafka。</li>
</ul>
<h2 id="ELK配置以及启动"><a href="#ELK配置以及启动" class="headerlink" title="ELK配置以及启动"></a>ELK配置以及启动</h2><h3 id="X-Pack-破解"><a href="#X-Pack-破解" class="headerlink" title="X-Pack 破解"></a>X-Pack 破解</h3><h4 id="复制Jar包"><a href="#复制Jar包" class="headerlink" title="复制Jar包"></a>复制Jar包</h4><p>先启动一个Elasticsearch的容器，将Jar包copy出来：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export CONTAINER_NAME=elk_elk-elasticsearch_1</span><br><span class="line">docker cp <span class="variable">$&#123;</span>CONTAINER_NAME&#125;<span class="symbol">:/usr/share/elasticsearch/modules/x-pack-core/x-pack-core-</span><span class="number">6.4</span>.<span class="number">0</span>.jar ./</span><br><span class="line">docker cp <span class="variable">$&#123;</span>CONTAINER_NAME&#125;<span class="symbol">:/usr/share/elasticsearch/lib</span> ./lib</span><br></pre></td></tr></table></figure>
<h4 id="反编译并修改源码"><a href="#反编译并修改源码" class="headerlink" title="反编译并修改源码"></a>反编译并修改源码</h4><p>找到下面两个类：<br></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org<span class="selector-class">.elasticsearch</span><span class="selector-class">.license</span><span class="selector-class">.LicenseVerifier</span><span class="selector-class">.class</span> org<span class="selector-class">.elasticsearch</span><span class="selector-class">.xpack</span><span class="selector-class">.core</span><span class="selector-class">.XPackBuild</span><span class="selector-class">.class</span></span><br></pre></td></tr></table></figure><p></p>
<p>使用 <strong><em><a href="https://github.com/deathmarine/Luyten" rel="external nofollow noopener noreferrer" target="_blank">Luyten</a></em></strong> 进行反编译</p>
<p><img src="http://img.yangbingdong.com/img/docker-logs-collect/luyten.png" alt=""></p>
<p>将两个类复制IDEA（<strong>需要引入上面copy出来的lib以及<code>x-pack-core-6.4.0.jar</code>本身</strong>），修改为如下样子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.elasticsearch.license;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LicenseVerifier</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">verifyLicense</span><span class="params">(<span class="keyword">final</span> License license, <span class="keyword">final</span> <span class="keyword">byte</span>[] publicKeyData)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">verifyLicense</span><span class="params">(<span class="keyword">final</span> License license)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.elasticsearch.xpack.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.SuppressForbidden;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.io.PathUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> class XPackBuild</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> XPackBuild CURRENT;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> shortHash;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> date;</span><br><span class="line"></span><br><span class="line">	@SuppressForbidden(reason = <span class="string">"looks up path of xpack.jar directly"</span>)</span><br><span class="line">	<span class="keyword">static</span> Path getElasticsearchCodebase() &#123;</span><br><span class="line">		<span class="keyword">final</span> URL url = XPackBuild.class.getProtectionDomain().getCodeSource().getLocation();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> PathUtils.<span class="built_in">get</span>(url.toURI());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (URISyntaxException bogus) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(bogus);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	XPackBuild(<span class="keyword">final</span> <span class="keyword">String</span> shortHash, <span class="keyword">final</span> <span class="keyword">String</span> date) &#123;</span><br><span class="line">		<span class="keyword">this</span>.shortHash = shortHash;</span><br><span class="line">		<span class="keyword">this</span>.date = date;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">String</span> shortHash() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.shortHash;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">String</span> date() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.date;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		<span class="keyword">final</span> Path path = getElasticsearchCodebase();</span><br><span class="line">		<span class="keyword">String</span> shortHash = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">String</span> date = <span class="keyword">null</span>;</span><br><span class="line">		Label_0157: &#123;  <span class="comment">// 将try-catch去掉</span></span><br><span class="line">			shortHash = <span class="string">"Unknown"</span>;</span><br><span class="line">			date = <span class="string">"Unknown"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		CURRENT = <span class="keyword">new</span> XPackBuild(shortHash, date);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再编译放回jar包中:</p>
<p><img src="http://img.yangbingdong.com/img/docker-logs-collect/jar-archive.png" alt=""></p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><h4 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h4><p><code>elasticsearch.yml</code>:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">cluster</span><span class="selector-class">.name</span>: "<span class="selector-tag">docker-cluster</span>"</span><br><span class="line"><span class="selector-tag">network</span><span class="selector-class">.host</span>: 0<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.0</span></span><br><span class="line"><span class="selector-tag">discovery</span><span class="selector-class">.zen</span><span class="selector-class">.minimum_master_nodes</span>: 1</span><br><span class="line"><span class="selector-tag">xpack</span><span class="selector-class">.security</span><span class="selector-class">.enabled</span>: <span class="selector-tag">false</span> # 不启用密码登陆</span><br><span class="line"><span class="selector-tag">xpack</span><span class="selector-class">.monitoring</span><span class="selector-class">.collection</span><span class="selector-class">.enabled</span>: <span class="selector-tag">true</span></span><br></pre></td></tr></table></figure>
<h4 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h4><p><code>logstash.conf</code>配置文件(<strong>注意下面的topics要与上面log4j2.xml中的一样</strong>):</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line">    kafka &#123;</span><br><span class="line">        <span class="attr">bootstrap_servers</span> =&gt; [<span class="string">"kafka:9092"</span>]</span><br><span class="line">        <span class="attr">auto_offset_reset</span> =&gt; <span class="string">"latest"</span></span><br><span class="line">        <span class="attr">consumer_threads</span> =&gt; <span class="number">3</span> <span class="comment"># 3个消费线程，默认是1个</span></span><br><span class="line">        <span class="attr">topics</span> =&gt; [<span class="string">"log-collect"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">filter</span> &#123;</span><br><span class="line">  mutate&#123;  <span class="comment"># 切分日志信息并添加相应字段</span></span><br><span class="line">    <span class="attr">split</span> =&gt; [ <span class="string">"message"</span>,<span class="string">" | "</span> ]</span><br><span class="line"></span><br><span class="line">    <span class="attr">add_field</span> =&gt; &#123;</span><br><span class="line">      <span class="string">"timestamp"</span> =&gt; <span class="string">"%&#123;[message][0]&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">add_field</span> =&gt; &#123;</span><br><span class="line">      <span class="string">"level"</span> =&gt; <span class="string">"%&#123;[message][2]&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add_field =&gt; &#123;</span><br><span class="line">      <span class="string">"server_name"</span> =&gt; <span class="string">"%&#123;[message][1]&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add_field =&gt; &#123;</span><br><span class="line">      <span class="string">"ip"</span> =&gt; <span class="string">"%&#123;[message][3]&#125;"</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add_field =&gt; &#123;</span><br><span class="line">      <span class="string">"device"</span> =&gt; <span class="string">"%&#123;[message][4]&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add_field =&gt; &#123;</span><br><span class="line">      <span class="string">"thread_class_method"</span> =&gt; <span class="string">"%&#123;[message][5]&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add_field =&gt; &#123;</span><br><span class="line">      <span class="string">"content"</span> =&gt; <span class="string">"%&#123;[message][6]&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remove_field =&gt; [ <span class="string">"message"</span> ]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">date</span> &#123;  <span class="comment"># 将上面得到的日期信息，也就是日志打印的时间作为时间戳</span></span><br><span class="line">    <span class="attr">match</span> =&gt; [ <span class="string">"timestamp"</span>, <span class="string">"yyyy-MM-dd HH:mm:ss.SSS"</span> ]</span><br><span class="line">    <span class="attr">locale</span> =&gt; <span class="string">"en"</span></span><br><span class="line">    <span class="attr">target</span> =&gt; [ <span class="string">"@timestamp"</span> ]</span><br><span class="line">    <span class="attr">timezone</span> =&gt; <span class="string">"Asia/Shanghai"</span> <span class="comment"># 这里如果不设置时区，在Kibana中展示的时候会多了8个小时</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">geoip</span> &#123; <span class="comment"># 分析ip</span></span><br><span class="line">    <span class="attr">source</span> =&gt; <span class="string">"ip"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">useragent</span> &#123; <span class="comment"># 分析User-Agent</span></span><br><span class="line">    <span class="attr">source</span> =&gt; <span class="string">"device"</span></span><br><span class="line">    <span class="attr">target</span> =&gt; <span class="string">"userDevice"</span></span><br><span class="line">    <span class="attr">remove_field</span> =&gt; [ <span class="string">"device"</span> ]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">output</span> &#123;</span><br><span class="line">    stdout&#123; <span class="attr">codec</span> =&gt; rubydebug &#125; # 输出到控制台</span><br><span class="line">    <span class="keyword">elasticsearch</span> &#123; <span class="comment"># 输出到 Elasticsearch</span></span><br><span class="line">        <span class="attr">action</span> =&gt; <span class="string">"index"</span></span><br><span class="line">        <span class="attr">hosts</span>  =&gt; [<span class="string">"elk-elasticsearch:9200"</span>]</span><br><span class="line">        <span class="attr">index</span>  =&gt; <span class="string">"logstash-%&#123;server_name&#125;-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">        <span class="attr">document_type</span> =&gt; <span class="string">"%&#123;server_name&#125;"</span></span><br><span class="line">        <span class="comment"># user =&gt; "elastic" # 如果选择开启xpack security需要输入帐号密码</span></span><br><span class="line">        <span class="comment"># password =&gt; "changeme"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>logstash.yml</code>:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http.host</span>: "0.0.0.0"</span><br><span class="line"><span class="attribute">xpack.monitoring.elasticsearch.url</span>: http://elk-elasticsearch:9200 # Docker版的Logstash此配置的默认地址是http://elasticsearch:9200</span><br><span class="line"></span><br><span class="line"># xpack.monitoring.elasticsearch.username: "elastic" # 如果选择开启xpack security需要输入帐号密码</span><br><span class="line"># xpack.monitoring.elasticsearch.password: "changeme"</span><br></pre></td></tr></table></figure>
<h4 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h4><p><code>kibana.yml</code>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server<span class="selector-class">.name</span>: kibana</span><br><span class="line">server<span class="selector-class">.host</span>: <span class="string">"0"</span></span><br><span class="line">elasticsearch<span class="selector-class">.url</span>: http:<span class="comment">//elk-elasticsearch:9200</span></span><br><span class="line">xpack<span class="selector-class">.monitoring</span><span class="selector-class">.ui</span><span class="selector-class">.container</span><span class="selector-class">.elasticsearch</span><span class="selector-class">.enabled</span>: true</span><br><span class="line"><span class="selector-id">#elasticsearch</span><span class="selector-class">.username</span>: <span class="string">"elastic"</span></span><br><span class="line"><span class="selector-id">#elasticsearch</span><span class="selector-class">.password</span>: <span class="string">"changeme"</span></span><br></pre></td></tr></table></figure>
<h3 id="申请License"><a href="#申请License" class="headerlink" title="申请License"></a>申请License</h3><p>转到 <strong><em><a href="https://license.elastic.co/registration" rel="external nofollow noopener noreferrer" target="_blank">License申请地址</a></em></strong> ，下载之后然后修改license中的<code>type</code>、<code>max_nodes</code>、<code>expiry_date_in_millis</code>：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"license"</span>: &#123;</span><br><span class="line">    <span class="string">"uid"</span>: <span class="string">"fe8c9a81-6651-4327-89a3-c9a33bfd8e3f"</span>,</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"platinum"</span>,  <span class="comment">// 这个类型是白金会员</span></span><br><span class="line">    <span class="string">"issue_date_in_millis"</span>: <span class="number">1536883200000</span>,</span><br><span class="line">    <span class="string">"expiry_date_in_millis"</span>: <span class="number">2855980923000</span>, <span class="comment">// 过期时间</span></span><br><span class="line">    <span class="string">"max_nodes"</span>: <span class="number">100</span>,  <span class="comment">// 集群节点数量</span></span><br><span class="line">    <span class="string">"issued_to"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">    <span class="string">"issuer"</span>: <span class="string">"Web Form"</span>,</span><br><span class="line">    <span class="string">"signature"</span>: <span class="string">"AAAAAwAAAA0imCa5T/HVBQyiUbSBAAABmC9ZN0hjZDBGYnVyRXpCOW5Bb3FjZDAxOWpSbTVoMVZwUzRxVk1PSmkxaktJRVl5MUYvUWh3bHZVUTllbXNPbzBUemtnbWpBbmlWRmRZb25KNFlBR2x0TXc2K2p1Y1VtMG1UQU9TRGZVSGRwaEJGUjE3bXd3LzRqZ05iLzRteWFNekdxRGpIYlFwYkJiNUs0U1hTVlJKNVlXekMrSlVUdFIvV0FNeWdOYnlESDc3MWhlY3hSQmdKSjJ2ZTcvYlBFOHhPQlV3ZHdDQ0tHcG5uOElCaDJ4K1hob29xSG85N0kvTWV3THhlQk9NL01VMFRjNDZpZEVXeUtUMXIyMlIveFpJUkk2WUdveEZaME9XWitGUi9WNTZVQW1FMG1DenhZU0ZmeXlZakVEMjZFT2NvOWxpZGlqVmlHNC8rWVVUYzMwRGVySHpIdURzKzFiRDl4TmM1TUp2VTBOUlJZUlAyV0ZVL2kvVk10L0NsbXNFYVZwT3NSU082dFNNa2prQ0ZsclZ4NTltbU1CVE5lR09Bck93V2J1Y3c9PQAAAQAWq5AoReLA+uTiRhQ8M0qYERXNidAAsVw0LeN5H7qRXFBAvB+rId4vZNj2DN5W5GuaxuiUhiytvV6maf4ArTsROCMUKGyO9RH24bYgnRbbf6MwB8EBHjSZ6+D8ysCVgfyqAAEKURGSMWszi2mR9R+DINtaeFJnb4B1GeAppbwl7qGGetAQm0vbF7ncyojIfjFthmMUomwo3vs0his5e3UPumItGc57LEk2s5gx95NNP8aFsJXSSFHgWDWwJs18XSl3NZItnEWNfy9lEJeAkR+LWISfizZIfViOTlcDBVGKR7w8u8D5QXFUVdsTi2XU5qfIWFb78BOtpCHIlU+AjB6m"</span>,</span><br><span class="line">    <span class="string">"start_date_in_millis"</span>: <span class="number">1536883200000</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="启动ELK"><a href="#启动ELK" class="headerlink" title="启动ELK"></a>启动ELK</h3><p><code>docker-compose.yml</code>:</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line">  elk-elasticsearch:</span><br><span class="line"><span class="symbol">    image:</span> docker.elastic.co<span class="meta-keyword">/elasticsearch/</span>elasticsearch:<span class="number">6.4</span><span class="number">.0</span></span><br><span class="line"><span class="meta">#    ports:</span></span><br><span class="line"><span class="meta">#      - <span class="string">"9200:9200"</span></span></span><br><span class="line"><span class="symbol">    restart:</span> always</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line">      - discovery.type=single-node</span><br><span class="line">      - ES_JAVA_OPTS=-Xms512m -Xmx512m</span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">    - .<span class="meta-keyword">/crack/</span>x-pack-core<span class="number">-6.4</span><span class="number">.0</span>.jar:<span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/elasticsearch/</span>modules<span class="meta-keyword">/x-pack-core/</span>x-pack-core<span class="number">-6.4</span><span class="number">.0</span>.jar</span><br><span class="line">    - .<span class="meta-keyword">/config/</span>elasticsearch.yml:<span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/elasticsearch/</span>config/elasticsearch.yml</span><br><span class="line">    - .<span class="meta-keyword">/config/</span>license.json:<span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/elasticsearch/</span>license.json</span><br><span class="line"><span class="symbol">    deploy:</span></span><br><span class="line"><span class="symbol">      placement:</span></span><br><span class="line"><span class="symbol">        constraints:</span></span><br><span class="line">        - node.role == manager</span><br><span class="line"><span class="symbol">    networks:</span></span><br><span class="line"><span class="symbol">      backend:</span></span><br><span class="line"><span class="symbol">        aliases:</span></span><br><span class="line">          - elk-elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="symbol">  kibana:</span></span><br><span class="line"><span class="symbol">    image:</span> docker.elastic.co<span class="meta-keyword">/kibana/</span>kibana:<span class="number">6.4</span><span class="number">.0</span></span><br><span class="line"><span class="symbol">    ports:</span></span><br><span class="line">      - <span class="string">"5601:5601"</span></span><br><span class="line"><span class="symbol">    restart:</span> always</span><br><span class="line"><span class="symbol">    deploy:</span></span><br><span class="line"><span class="symbol">      placement:</span></span><br><span class="line"><span class="symbol">        constraints:</span></span><br><span class="line">        - node.role == manager</span><br><span class="line"><span class="symbol">    networks:</span></span><br><span class="line"><span class="symbol">      backend:</span></span><br><span class="line"><span class="symbol">        aliases:</span></span><br><span class="line">          - kibana</span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">    - .<span class="meta-keyword">/config/</span>kibana.yml:<span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/kibana/</span>config/kibana.yml</span><br><span class="line"><span class="symbol">    depends_on:</span></span><br><span class="line">      - elk-elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="symbol">  logstash:</span></span><br><span class="line"><span class="symbol">    image:</span> docker.elastic.co<span class="meta-keyword">/logstash/</span>logstash:<span class="number">6.4</span><span class="number">.0</span></span><br><span class="line"><span class="meta">#    ports:</span></span><br><span class="line"><span class="meta">#      - <span class="string">"4560:4560"</span></span></span><br><span class="line"><span class="symbol">    restart:</span> always</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line">      - LS_JAVA_OPTS=-Xmx512m -Xms512m</span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - .<span class="meta-keyword">/config/</span>logstash.conf:<span class="meta-keyword">/etc/</span>logstash.conf</span><br><span class="line">      - .<span class="meta-keyword">/config/</span>logstash.yml:<span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/logstash/</span>config/logstash.yml</span><br><span class="line"><span class="symbol">    deploy:</span></span><br><span class="line"><span class="symbol">      placement:</span></span><br><span class="line"><span class="symbol">        constraints:</span></span><br><span class="line">        - node.role == manager</span><br><span class="line"><span class="symbol">    networks:</span></span><br><span class="line"><span class="symbol">      backend:</span></span><br><span class="line"><span class="symbol">        aliases:</span></span><br><span class="line">          - logstash</span><br><span class="line"><span class="symbol">    depends_on:</span></span><br><span class="line">      - elk-elasticsearch</span><br><span class="line"><span class="symbol">    entrypoint:</span></span><br><span class="line">      - logstash</span><br><span class="line">      - -f</span><br><span class="line">      - <span class="meta-keyword">/etc/</span>logstash.conf</span><br><span class="line"></span><br><span class="line"><span class="meta"># docker network create -d=overlay --attachable backend</span></span><br><span class="line"><span class="meta"># docker network create --opt encrypted -d=overlay --attachable --subnet 10.10.0.0/16 backend</span></span><br><span class="line"><span class="symbol">networks:</span></span><br><span class="line"><span class="symbol">  backend:</span></span><br><span class="line"><span class="symbol">    external:</span></span><br><span class="line"><span class="symbol">      name:</span> backend</span><br></pre></td></tr></table></figure>
<p>启动后需要手动请求更新License：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br><span class="line">docker <span class="keyword">exec</span> $&#123;CONTAINER_NAME&#125; curl -XPUT <span class="string">'http://0.0.0.0:9200/_xpack/license'</span> -H <span class="string">"Content-Type: application/json"</span> -d @license.json</span><br></pre></td></tr></table></figure>
<p>大概是下面这个样子：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ybd @ ybd-PC in ~/data/git-repo/bitbucket/ms-base/docker-compose/elk on git:master x [20:52:51] </span></span><br><span class="line"><span class="variable">$ </span>docker-compose up -d                                                   </span><br><span class="line"></span><br><span class="line">Creating elk_elk-elasticsearch_1 ... done</span><br><span class="line"></span><br><span class="line">Creating elk_elk-elasticsearch_1 ... </span><br><span class="line">Creating elk_logstash_1          ... done</span><br><span class="line">Creating elk_kibana_1            ... done</span><br><span class="line"></span><br><span class="line"><span class="comment"># ybd @ ybd-PC in ~/data/git-repo/bitbucket/ms-base/docker-compose/elk on git:master x [20:53:58] </span></span><br><span class="line"><span class="variable">$ </span>docker exec elk_elk-elasticsearch_1 curl -XPUT <span class="string">'http://0.0.0.0:9200/_xpack/license'</span> -H <span class="string">"Content-Type: application/json"</span> -d <span class="variable">@license</span>.json</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line"><span class="number">100</span>  <span class="number">1278</span>  <span class="number">100</span>    <span class="number">46</span>  <span class="number">100</span>  <span class="number">1232</span>    <span class="number">328</span>   <span class="number">8786</span> --<span class="symbol">:--</span><span class="symbol">:--</span> --<span class="symbol">:--</span><span class="symbol">:--</span> --<span class="symbol">:--</span><span class="symbol">:--</span>  <span class="number">8800</span></span><br><span class="line">&#123;<span class="string">"acknowledged"</span><span class="symbol">:true</span>,<span class="string">"license_status"</span><span class="symbol">:<span class="string">"valid"</span></span>&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.yangbingdong.com/kibana-license.png" alt=""></p>
<p><img src="http://img.yangbingdong.com/img/docker-logs-collect/kibana02.png" alt=""></p>
<h2 id="Kibana相关设置"><a href="#Kibana相关设置" class="headerlink" title="Kibana相关设置"></a>Kibana相关设置</h2><h3 id="显示所有插件"><a href="#显示所有插件" class="headerlink" title="显示所有插件"></a>显示所有插件</h3><p>在Kibana首页最下面找到：</p>
<p><img src="http://img.yangbingdong.com/img/docker-logs-collect/kibana-full-plugin-button.png" alt=""></p>
<h3 id="Discover每页显示行数"><a href="#Discover每页显示行数" class="headerlink" title="Discover每页显示行数"></a>Discover每页显示行数</h3><p>找到Advanced Setting<img src="http://img.yangbingdong.com/img/docker-logs-collect/kibana-admin-setting.png" alt=""></p>
<p>点进去找到 <code>discover:sampleSize</code>再点击Edit修改:</p>
<p><img src="http://img.yangbingdong.com/img/docker-logs-collect/kibana-page-size.png" alt=""></p>
<h3 id="时区"><a href="#时区" class="headerlink" title="时区"></a>时区</h3><p>Kibana默认读取浏览器时区，可通过<code>dateFormat:tz</code>进行修改：</p>
<p><img src="http://img.yangbingdong.com/img/docker-logs-collect/kibana-timezone.png" alt=""></p>
<h1 id="Spring-Boot-集成-Elastic-APM"><a href="#Spring-Boot-集成-Elastic-APM" class="headerlink" title="Spring Boot 集成 Elastic APM"></a>Spring Boot 集成 Elastic APM</h1><h2 id="运行APM-Server"><a href="#运行APM-Server" class="headerlink" title="运行APM Server"></a>运行APM Server</h2><p><code>docker-compose</code>:</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line">  apm-server:</span><br><span class="line"><span class="symbol">    image:</span> docker.elastic.co<span class="meta-keyword">/apm/</span>apm-server:<span class="number">6.4</span><span class="number">.0</span></span><br><span class="line"><span class="symbol">    ports:</span></span><br><span class="line">      - <span class="string">"8200:8200"</span></span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">    - .<span class="meta-keyword">/config/</span>apm-server.yml:<span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/apm-server/</span>apm-server.yml</span><br><span class="line"><span class="symbol">    deploy:</span></span><br><span class="line"><span class="symbol">      placement:</span></span><br><span class="line"><span class="symbol">        constraints:</span></span><br><span class="line">        - node.role == manager</span><br><span class="line"><span class="symbol">    networks:</span></span><br><span class="line">      backend-swarm:</span><br><span class="line"><span class="symbol">        aliases:</span></span><br><span class="line">          - apm-server</span><br><span class="line"></span><br><span class="line"><span class="meta"># docker network create -d=overlay --attachable backend-swarm</span></span><br><span class="line"><span class="meta"># docker network create --opt encrypted -d=overlay --attachable --subnet 10.10.0.0/16 backend-swarm</span></span><br><span class="line"><span class="symbol">networks:</span></span><br><span class="line">  backend-swarm:</span><br><span class="line"><span class="symbol">    external:</span></span><br><span class="line"><span class="symbol">      name:</span> backend-swarm</span><br></pre></td></tr></table></figure>
<p><code>apm-server.yml</code>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">apm-server:</span><br><span class="line">  host: <span class="string">"0.0.0.0:8200"</span></span><br><span class="line"></span><br><span class="line">setup<span class="selector-class">.template</span><span class="selector-class">.settings</span>:</span><br><span class="line"></span><br><span class="line">  index:</span><br><span class="line">    number_of_shards: <span class="number">1</span></span><br><span class="line">    codec: best_compression</span><br><span class="line">    </span><br><span class="line">output<span class="selector-class">.elasticsearch</span>:</span><br><span class="line">  hosts: [<span class="string">"elk-elasticsearch:9200"</span>]</span><br><span class="line"></span><br><span class="line">  indices:</span><br><span class="line">  - index: <span class="string">"apm-%&#123;[beat.version]&#125;-sourcemap"</span></span><br><span class="line">    when<span class="selector-class">.contains</span>:</span><br><span class="line">      processor<span class="selector-class">.event</span>: <span class="string">"sourcemap"</span></span><br><span class="line"></span><br><span class="line">  - index: <span class="string">"apm-%&#123;[beat.version]&#125;-error-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">    when<span class="selector-class">.contains</span>:</span><br><span class="line">      processor<span class="selector-class">.event</span>: <span class="string">"error"</span></span><br><span class="line"></span><br><span class="line">  - index: <span class="string">"apm-%&#123;[beat.version]&#125;-transaction-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">    when<span class="selector-class">.contains</span>:</span><br><span class="line">      processor<span class="selector-class">.event</span>: <span class="string">"transaction"</span></span><br><span class="line"></span><br><span class="line">  - index: <span class="string">"apm-%&#123;[beat.version]&#125;-span-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">    when<span class="selector-class">.contains</span>:</span><br><span class="line">      processor<span class="selector-class">.event</span>: <span class="string">"span"</span></span><br><span class="line"></span><br><span class="line">  - index: <span class="string">"apm-%&#123;[beat.version]&#125;-metric-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">    when<span class="selector-class">.contains</span>:</span><br><span class="line">      processor<span class="selector-class">.event</span>: <span class="string">"metric"</span></span><br><span class="line"></span><br><span class="line">  - index: <span class="string">"apm-%&#123;[beat.version]&#125;-onboarding-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">    when<span class="selector-class">.contains</span>:</span><br><span class="line">      processor<span class="selector-class">.event</span>: <span class="string">"onboarding"</span></span><br><span class="line"></span><br><span class="line">logging<span class="selector-class">.level</span>: warning</span><br><span class="line"></span><br><span class="line">logging<span class="selector-class">.metrics</span><span class="selector-class">.enabled</span>: false</span><br></pre></td></tr></table></figure>
<p>这个配置文件从容器中<code>/usr/share/apm-server/apm-server.yml</code>复制出来稍微改了一下Elasticsearch的Url。</p>
<p>若开启了X-Pack，则需要在yml中配置帐号密码：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">output.elasticsearch:</span><br><span class="line"><span class="symbol">    hosts:</span> [<span class="string">"&lt;es_url&gt;"</span>]</span><br><span class="line"><span class="symbol">    username:</span> <span class="params">&lt;username&gt;</span></span><br><span class="line"><span class="symbol">    password:</span> <span class="params">&lt;password&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="集成到Spring-Boot"><a href="#集成到Spring-Boot" class="headerlink" title="集成到Spring Boot"></a>集成到Spring Boot</h2><p>下载 <strong><em><a href="http://search.maven.org/#search%7Cga%7C1%7Ca%3Aelastic-apm-agent" rel="external nofollow noopener noreferrer" target="_blank">APM代理依赖</a></em></strong></p>
<p>在启动参数中添加:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:/path/to/elastic-apm-agent-&lt;version&gt;<span class="selector-class">.jar</span> \</span><br><span class="line">     -Delastic<span class="selector-class">.apm</span><span class="selector-class">.service_name</span>=my-application \</span><br><span class="line">     -Delastic<span class="selector-class">.apm</span><span class="selector-class">.server_url</span>=http:<span class="comment">//localhost:8200 \ </span></span><br><span class="line">     -Delastic<span class="selector-class">.apm</span><span class="selector-class">.application_packages</span>=org<span class="selector-class">.example</span> \ </span><br><span class="line">     -jar my-application.jar</span><br></pre></td></tr></table></figure>
<p>启动后在Kibana的APM模块中更新一下索引，效果图大概是这样的：</p>
<p><img src="http://img.yangbingdong.com/img/docker-logs-collect/apm.png" alt=""></p>
<h1 id="log-pilot"><a href="#log-pilot" class="headerlink" title="log-pilot"></a>log-pilot</h1><p>Github: <strong><em><a href="https://github.com/AliyunContainerService/log-pilot" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/AliyunContainerService/log-pilot</a></em></strong></p>
<p>更多说明: <strong><em><a href="https://yq.aliyun.com/articles/69382" rel="external nofollow noopener noreferrer" target="_blank">https://yq.aliyun.com/articles/69382</a></em></strong></p>
<p>这个是Ali开源的日志收集组件，通过中间件的方式部署，自动监听其他容器的日志，非常方便：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="builtin-name">run</span> --rm -it -v /var/run/docker.sock:/var/run/docker.sock -v /etc/localtime:/etc/localtime -v /:/host -e <span class="attribute">PILOT_TYPE</span>=fluentd -e <span class="attribute">FLUENTD_OUTPUT</span>=elasticsearch -e <span class="attribute">ELASTICSEARCH_HOST</span>=192.168.6.113 -e <span class="attribute">ELASTICSEARCH_PORT</span>=9200 -e <span class="attribute">TZ</span>=Asia/Chongqing --privileged registry.cn-hangzhou.aliyuncs.com/acs-sample/log-pilot:latest</span><br></pre></td></tr></table></figure>
<p>需要手机日志的容器：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm --<span class="selector-tag">label</span> aliyun<span class="selector-class">.logs</span><span class="selector-class">.demo</span>=stdout -<span class="selector-tag">p</span> <span class="number">8080</span>:<span class="number">8080</span> <span class="number">192.168</span>.<span class="number">0.202</span>:<span class="number">8080</span>/dev-images/demo:latest</span><br></pre></td></tr></table></figure>
<ul>
<li>通过<code>--label aliyun.logs.demo=stdout</code>告诉<code>log-pilot</code>需要收集日志，索引为<code>demo</code></li>
</ul>
<p>然后打开Kibana就可以看到日志了。</p>
<p>问题：</p>
<ul>
<li>日志稍微延迟</li>
<li>日志顺序混乱</li>
<li>异常堆栈不集中</li>
</ul>
<h1 id="Finally"><a href="#Finally" class="headerlink" title="Finally"></a>Finally</h1><blockquote>
<p>参考:</p>
<p><strong><em><a href="https://www.yinchengli.com/2016/09/16/logstash/" rel="external nofollow noopener noreferrer" target="_blank">https://www.yinchengli.com/2016/09/16/logstash/</a></em></strong></p>
<p><strong><em><a href="https://www.jianshu.com/p/ba1aa0c52942" rel="external nofollow noopener noreferrer" target="_blank">https://www.jianshu.com/p/ba1aa0c52942</a></em></strong></p>
<p><strong><em><a href="https://www.jianshu.com/p/eb10c414a93f" rel="external nofollow noopener noreferrer" target="_blank">https://www.jianshu.com/p/eb10c414a93f</a></em></strong></p>
<p><strong><em><a href="https://my.oschina.net/kkrgwbj/blog/734530" rel="external nofollow noopener noreferrer" target="_blank">https://my.oschina.net/kkrgwbj/blog/734530</a></em></strong></p></blockquote>
      
    </div>

<div style="text-align:center;color:#ccc;font-size:14px">---------------- The End ----------------</div>

    <div>
      
        
<div id="wechat_subscriber" style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center">
    <img id="wechat_subscriber_qcode" src="/images/wechat/gongzhonghao.jpg" alt="ookamiAntD wechat" style="width:200px;max-width:100%">
    <div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div>
</div>


      
    </div>

    <div>
      
        


  <div style="padding:10px 0;margin:20px auto;width:90%;text-align:center">
    <div>谢谢大爷～</div>
    <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'>
      <span>赏</span>
    </button>
    <div id="QR" style="display:none">
      
        <div id="wechat" style="display:inline-block">
          <img id="wechat_qr" src="/images/donate/wechat.png" alt="ookamiAntD WeChat Pay">
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display:inline-block">
          <img id="alipay_qr" src="/images/donate/alipay.jpg" alt="ookamiAntD Alipay">
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>
<div>
	  
	    <p id="div-border-left-red">
		Author：<b>ookamiAntD Yang</b><br>
		Link：<a href="/2018/spring-boot-docker-elk/" title="Spring Boot应用集成Docker并结合Log4j2、Kafka、ELK管理Docker日志">http://yangbingdong.com/2018/spring-boot-docker-elk/</a><br>
		Contact：<a>yangbingdong1994@gmail.com</a><br>
	   <b>本文基于<a target="_blank" title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href="http://creativecommons.org/licenses/by-sa/4.0/" rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br>
	    <b>转载请注明出处，谢谢！</b>
	    </p>
	  
	</div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a>
          
            <a href="/tags/Spring-Boot/" rel="tag"><i class="fa fa-tag"></i> Spring Boot</a>
          
            <a href="/tags/Spring/" rel="tag"><i class="fa fa-tag"></i> Spring</a>
          
            <a href="/tags/Docker/" rel="tag"><i class="fa fa-tag"></i> Docker</a>
          
            <a href="/tags/Elasticsearch/" rel="tag"><i class="fa fa-tag"></i> Elasticsearch</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/write-your-own-blockchain/" rel="next" title="转载—自己动手写区块链">
                <i class="fa fa-chevron-left"></i> 转载—自己动手写区块链
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/spring-cloud-stack-learning/" rel="prev" title="Spring Cloud Stack Learning">
                Spring Cloud Stack Learning <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        
<div class="-hoofoo-share-title">分享到：</div>
<div class="-hoofoo-share-buttons">
    <div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden="true"></i></div>
    <div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden="true"></i></div>
    <div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden="true"></i></div>
    <div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden="true"></i></div>
    <div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden="true"></i></div>
</div>
<div class="-mob-share-ui" style="display:none">
    <ul class="-mob-share-list">
        <li class="-mob-share-weibo"><p>新浪微博</p></li>
        <li class="-mob-share-weixin"><p>微信</p></li>
        <li class="-mob-share-qzone"><p>QQ空间</p></li>
        <li class="-mob-share-qq"><p>QQ好友</p></li>
        <li class="-mob-share-tencentweibo"><p>腾讯微博</p></li>
        <li class="-mob-share-renren"><p>人人网</p></li>
        <li class="-mob-share-kaixin"><p>开心网</p></li>
        <li class="-mob-share-douban"><p>豆瓣</p></li>
        <li class="-mob-share-youdao"><p>有道云笔记</p></li>
        <li class="-mob-share-mingdao"><p>明道</p></li>
        <li class="-mob-share-pengyou"><p>朋友网</p></li>
        <li class="-mob-share-facebook"><p>Facebook</p></li>
        <li class="-mob-share-twitter"><p>Twitter</p></li>
        <li class="-mob-share-pocket"><p>Pocket</p></li>
        <li class="-mob-share-google"><p>Google+</p></li>
        <li class="-mob-share-tumblr"><p>Tumblr</p></li>
        <li class="-mob-share-instapaper"><p>Instapaper</p></li>
        <li class="-mob-share-linkedin"><p>Linkedin</p></li>
    </ul>
    <div class="-mob-share-close">取消</div>
</div>
<div class="-mob-share-ui-bg"></div>
<script id="-mob-share" src="http://f1.webshare.mob.com/code/mob-share.js?appkey=21aa3b13ad233"></script>


      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
<div style="text-align:center">
  

</div>
      <div id="disqus_proxy_thread"></div>
      <div id="disqus_thread"></div>
      
          <script type="text/javascript">window.disqusProxy={username:"ookamiantd",server:"disqus-proxy.yangbingdong.com",port:"5509",defaultAvatar:"/images/avatar/avatar-default.jpg",adminAvatar:"/images/avatar/avatar-admin.jpg",identifier:"2018/spring-boot-docker-elk/"},window.disqus_config=function(){this.page.url="http://yangbingdong.com/2018/spring-boot-docker-elk/",this.page.identifier="2018/spring-boot-docker-elk/"},window.onload=function(){var a=document.createElement("script");a.src="/static/js/main.0d0338ae.js",a.async=!0,document.body.appendChild(a)}</script>
          <link rel="stylesheet" href="/static/css/main.0603c539.css">
      

    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar/avatar-admin.jpg" alt="ookamiAntD">
          <p class="site-author-name" itemprop="name">ookamiAntD</p>
          <p class="site-description motion-element" itemprop="description">码渣 | rocker | 二次元 | 美剧 | 宅</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">32</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">34</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/masteranthoneyd" target="_blank" rel="external nofollow noopener noreferrer" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/profile.php?id=100014869064462" target="_blank" rel="external nofollow noopener noreferrer" title="Facebook">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                  Facebook
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/ookamiAntD" target="_blank" rel="external nofollow noopener noreferrer" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="cc-opacity" target="_blank" rel="external nofollow noopener noreferrer">
              <img src="/images/cc-by-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa fa-fw fa-globe"></i>
              大神们的博客
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://ycwalker.com/" title="ciqulover" target="_blank" rel="external nofollow noopener noreferrer">ciqulover</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://codepub.cn" title="IT草根" target="_blank" rel="external nofollow noopener noreferrer">IT草根</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://crossoverjie.top/" title="crossoverJie's Blog" target="_blank" rel="external nofollow noopener noreferrer">crossoverJie's Blog</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://yemengying.com/" title="Giraffe's Home" target="_blank" rel="external nofollow noopener noreferrer">Giraffe's Home</a>
                </li>
              
            </ul>
          </div>
        

        <div id="days"></div>
    <script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("01/10/2017 12:34:56"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script>


      </section>

      
      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Preface"><span class="nav-number">1.</span> <span class="nav-text">Preface</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Log4j2-Related"><span class="nav-number">2.</span> <span class="nav-text">Log4j2 Related</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用Log4j2"><span class="nav-number">2.1.</span> <span class="nav-text">使用Log4j2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Maven配置"><span class="nav-number">2.1.1.</span> <span class="nav-text">Maven配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开启全局异步以及Disruptor参数设置"><span class="nav-number">2.1.2.</span> <span class="nav-text">开启全局异步以及Disruptor参数设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#application-yml简单配置"><span class="nav-number">2.1.3.</span> <span class="nav-text">application.yml简单配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#log4j2-xml完整配置"><span class="nav-number">2.1.4.</span> <span class="nav-text">log4j2.xml完整配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#也可以使用log4j2-yml"><span class="nav-number">2.1.5.</span> <span class="nav-text">也可以使用log4j2.yml</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志配置文件中获取Application配置"><span class="nav-number">2.2.</span> <span class="nav-text">日志配置文件中获取Application配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Logback"><span class="nav-number">2.2.1.</span> <span class="nav-text">Logback</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Log4j2"><span class="nav-number">2.2.2.</span> <span class="nav-text">Log4j2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义字段"><span class="nav-number">2.3.</span> <span class="nav-text">自定义字段</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Boot-Docker-Integration"><span class="nav-number">3.</span> <span class="nav-text">Spring Boot Docker Integration</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#准备工作"><span class="nav-number">3.1.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安全认证配置"><span class="nav-number">3.2.</span> <span class="nav-text">安全认证配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#普通配置"><span class="nav-number">3.2.1.</span> <span class="nav-text">普通配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Maven-密码加密配置"><span class="nav-number">3.2.2.</span> <span class="nav-text">Maven 密码加密配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#构建基础镜像"><span class="nav-number">3.3.</span> <span class="nav-text">构建基础镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开始集成"><span class="nav-number">3.4.</span> <span class="nav-text">开始集成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#编写Dockerfile"><span class="nav-number">3.4.1.</span> <span class="nav-text">编写Dockerfile</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#注意PID"><span class="nav-number">3.4.1.1.</span> <span class="nav-text">注意PID</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pom文件添加构建Docker镜像的相关插件"><span class="nav-number">3.4.2.</span> <span class="nav-text">pom文件添加构建Docker镜像的相关插件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#spring-boot-maven-plugin"><span class="nav-number">3.4.2.1.</span> <span class="nav-text">spring-boot-maven-plugin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#maven-resources-plugin"><span class="nav-number">3.4.2.2.</span> <span class="nav-text">maven-resources-plugin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#build-helper-maven-plugin"><span class="nav-number">3.4.2.3.</span> <span class="nav-text">build-helper-maven-plugin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-maven-plugin"><span class="nav-number">3.4.2.4.</span> <span class="nav-text">docker-maven-plugin</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#命令构建"><span class="nav-number">3.4.3.</span> <span class="nav-text">命令构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#运行Docker"><span class="nav-number">3.4.4.</span> <span class="nav-text">运行Docker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加运行时JVM参数"><span class="nav-number">3.4.5.</span> <span class="nav-text">添加运行时JVM参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-Swarm环境下获取ClientIp"><span class="nav-number">3.5.</span> <span class="nav-text">Docker Swarm环境下获取ClientIp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo地址"><span class="nav-number">3.6.</span> <span class="nav-text">Demo地址</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kafka、ELK-collect-logs"><span class="nav-number">4.</span> <span class="nav-text">Kafka、ELK collect logs</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#镜像准备"><span class="nav-number">4.1.</span> <span class="nav-text">镜像准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动Kafka与Zookeeper"><span class="nav-number">4.2.</span> <span class="nav-text">启动Kafka与Zookeeper</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ELK配置以及启动"><span class="nav-number">4.3.</span> <span class="nav-text">ELK配置以及启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#X-Pack-破解"><span class="nav-number">4.3.1.</span> <span class="nav-text">X-Pack 破解</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#复制Jar包"><span class="nav-number">4.3.1.1.</span> <span class="nav-text">复制Jar包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#反编译并修改源码"><span class="nav-number">4.3.1.2.</span> <span class="nav-text">反编译并修改源码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置文件"><span class="nav-number">4.3.2.</span> <span class="nav-text">配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Elasticsearch"><span class="nav-number">4.3.2.1.</span> <span class="nav-text">Elasticsearch</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Logstash"><span class="nav-number">4.3.2.2.</span> <span class="nav-text">Logstash</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kibana"><span class="nav-number">4.3.2.3.</span> <span class="nav-text">Kibana</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#申请License"><span class="nav-number">4.3.3.</span> <span class="nav-text">申请License</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动ELK"><span class="nav-number">4.3.4.</span> <span class="nav-text">启动ELK</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kibana相关设置"><span class="nav-number">4.4.</span> <span class="nav-text">Kibana相关设置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#显示所有插件"><span class="nav-number">4.4.1.</span> <span class="nav-text">显示所有插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Discover每页显示行数"><span class="nav-number">4.4.2.</span> <span class="nav-text">Discover每页显示行数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#时区"><span class="nav-number">4.4.3.</span> <span class="nav-text">时区</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Boot-集成-Elastic-APM"><span class="nav-number">5.</span> <span class="nav-text">Spring Boot 集成 Elastic APM</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#运行APM-Server"><span class="nav-number">5.1.</span> <span class="nav-text">运行APM Server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集成到Spring-Boot"><span class="nav-number">5.2.</span> <span class="nav-text">集成到Spring Boot</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#log-pilot"><span class="nav-number">6.</span> <span class="nav-text">log-pilot</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Finally"><span class="nav-number">7.</span> <span class="nav-text">Finally</span></a></li></ol></div>
            

          </div>
        </section>
      
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
	
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-flash"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a></span>
</div>



<script type="text/javascript" src="/js/src/dytitle.js"></script></div></footer></div><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":88,"height":88,"position":"left"},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.5},"log":false});</script></body></html>