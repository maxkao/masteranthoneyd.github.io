<!doctype html><html class="theme-next muse use-motion" lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta http-equiv="content-language" content="zh-cn"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><style>.pace .pace-progress{background:#ff009e;height:2px}.pace .pace-progress-inner{box-shadow:0 0 10px #e6006b,0 0 5px #ff009e}.pace .pace-activity{border-top-color:#ff009e;border-left-color:#ff009e}</style><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css"><meta name="keywords" content="Java,Spring Boot,Spring,"><link rel="alternate" href="/atom.xml" title="ookamiAntD's Blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.png?v=5.1.0"><meta name="description" content="PrefaceSpring Boot作为当下最流行的微服务项目构建基础，有的时候我们根本不需要额外的配置就能够干很多的事情，这得益于它的一个核心理念：“习惯优于配置”。。。说白的就是大部分的配置都已经按照最佳实践的编程规范配置好了本文基于 Spring Boot 2的学习杂记，还是与1.X版本还是有一定区别的"><meta name="keywords" content="Java,Spring Boot,Spring"><meta property="og:type" content="article"><meta property="og:title" content="Spring Boot学习之杂记篇"><meta property="og:url" content="http://yangbingdong.com/2018/spring-boot-learning-hodgepodge/index.html"><meta property="og:site_name" content="ookamiAntD&#39;s Blog"><meta property="og:description" content="PrefaceSpring Boot作为当下最流行的微服务项目构建基础，有的时候我们根本不需要额外的配置就能够干很多的事情，这得益于它的一个核心理念：“习惯优于配置”。。。说白的就是大部分的配置都已经按照最佳实践的编程规范配置好了本文基于 Spring Boot 2的学习杂记，还是与1.X版本还是有一定区别的"><meta property="og:locale" content="en"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/spring-boot.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/parent.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/repackage.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/spring-boot-devtools01.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/spring-boot-devtools02.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/tomcat-gatling-test.jpg"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/undertow-gatling-test.jpg"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/log4j2-performance.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/spring-boot-cglib-default.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/spring-reg-bean.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/spring-boot-code.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/spring-boot-code02.png"><meta property="og:updated_time" content="2018-07-30T11:30:59.344Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Spring Boot学习之杂记篇"><meta name="twitter:description" content="PrefaceSpring Boot作为当下最流行的微服务项目构建基础，有的时候我们根本不需要额外的配置就能够干很多的事情，这得益于它的一个核心理念：“习惯优于配置”。。。说白的就是大部分的配置都已经按照最佳实践的编程规范配置好了本文基于 Spring Boot 2的学习杂记，还是与1.X版本还是有一定区别的"><meta name="twitter:image" content="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/spring-boot.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",sidebar:{position:"right",display:"always"},fancybox:!0,motion:!0,duoshuo:{userId:"undefined",author:"Author"},algolia:{applicationID:"RI3NF6GUI0",apiKey:"3d33fa60ba30d3b17f37220bb1a36749",indexName:"blogIndex",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://yangbingdong.com/2018/spring-boot-learning-hodgepodge/"><title>Spring Boot学习之杂记篇 | ookamiAntD's Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e9505ac4e11d464329d615553a72b526";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class="headband"></div><a href="https://github.com/masteranthoneyd/blog" rel="external nofollow noopener noreferrer" target="_blank"><img style="position:absolute;top:0;left:0;border:0" src="https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png"></a><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">ookamiAntD's Blog</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Easy coding,easy life.</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook" rel="section"><i class="menu-item-icon fa fa-fw fa-commenting"></i><br>Message</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div><span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://yangbingdong.com/2018/spring-boot-learning-hodgepodge/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ookamiAntD"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar/avatar-admin.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="ookamiAntD's Blog"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="ookamiAntD's Blog" src=""></span></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Spring Boot学习之杂记篇</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-25T15:25:35+08:00">2018-02-25 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Programming/" itemprop="url" rel="index"><span itemprop="name">Programming</span> </a></span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Programming/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span> </a></span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Programming/Java/Spring-Boot/" itemprop="url" rel="index"><span itemprop="name">Spring Boot</span> </a></span></span><span id="/2018/spring-boot-learning-hodgepodge/" class="leancloud_visitors" data-flag-title="Spring Boot学习之杂记篇"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">Visitors </span><span class="leancloud-visitors-count"></span></span><br><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-edit"></i> </span><span class="post-meta-item-text">WordCount:</span> <span class="post-count">10,890字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-text">min2read:</span> <span class="post-count">51分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/spring-boot.png" alt=""></p><h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><blockquote><p>Spring Boot作为当下最流行的微服务项目构建基础，有的时候我们根本不需要额外的配置就能够干很多的事情，这得益于它的一个核心理念：“习惯优于配置”。。。</p><p>说白的就是大部分的配置都已经按照<del>最佳实践</del>的编程规范配置好了</p><p>本文基于 Spring Boot 2的学习杂记，还是与1.X版本还是有一定区别的</p></blockquote><a id="more"></a><h1 id="构建依赖版本管理工程"><a href="#构建依赖版本管理工程" class="headerlink" title="构建依赖版本管理工程"></a>构建依赖版本管理工程</h1><p>学习Demo：<strong><em><a href="https://github.com/masteranthoneyd/spring-boot-learning" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/masteranthoneyd/spring-boot-learning</a></em></strong></p><blockquote><p>为什么要分开为两个工程？因为考虑到common工程也需要版本控制，但parent工程中依赖了common工程，所以common工程不能依赖parent工程（循环依赖），故例外抽离出一个dependencies的工程，专门用作依赖版本管理，而parent工程用作其他子工程的公共依赖。</p></blockquote><h2 id="依赖版本管理工程"><a href="#依赖版本管理工程" class="headerlink" title="依赖版本管理工程"></a>依赖版本管理工程</h2><p>跟下面父工程一样只有一个<code>pom.xml</code></p><p><em><a href="https://github.com/masteranthoneyd/spring-boot-learning/tree/master/spring-boot-parent-dependencies" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/masteranthoneyd/spring-boot-learning/tree/master/spring-boot-parent-dependencies</a></em></p><h2 id="父工程"><a href="#父工程" class="headerlink" title="父工程"></a>父工程</h2><p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/parent.png" alt=""></p><p><em><a href="https://github.com/masteranthoneyd/spring-boot-learning/blob/master/spring-boot-parent/pom.xml" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/masteranthoneyd/spring-boot-learning/blob/master/spring-boot-parent/pom.xml</a></em></p><p>说明：</p><ul><li><code>&lt;packaging&gt;</code> 为 <code>pom</code> 表示此会被打包成 pom 文件被其他子项目依赖。</li><li>由于 Spring Boot 以及集成了 <code>maven-surefire-plugin</code> 插件，跳过测试只需要在 properties中添加 <code>&lt;maven.test.skip&gt;true&lt;/maven.test.skip&gt;</code>即可，等同 <code>mvn package -Dmaven.test.skip=true</code>，也可使用 <code>&lt;skipTests&gt;true&lt;/skipTests&gt;</code>，两者的区别在于 <code>&lt;maven.test.skip&gt;</code> 标签连 <code>.class</code> 文件都不会生成，而 <code>&lt;skipTests&gt;</code> 会编译生成 <code>.class</code> 文件</li></ul><ul><li>子项目会继承父项目的 <code>properties</code>，若子项目重新定义属性，则会覆盖父项目的属性。</li><li><code>&lt;dependencyManagement&gt;</code> 管理依赖版本，不使用 <code>&lt;parent&gt;</code> 来依赖 Spring Boot，可以使用上面方式，添加 <code>&lt;type&gt;</code> 为 <code>pom</code> 以及 <code>&lt;scope&gt;</code> 为 <code>import</code>。</li><li><code>&lt;pluginManagement&gt;</code> 的功能类似于 <code>&lt;dependencyManagement&gt;</code>，在父项目中设置好插件属性，在子项目中直接依赖就可以，不需要每个子项目都配置一遍，当然了，子项目也可以覆盖插件属性。</li></ul><h1 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h1><h2 id="打包成可执行的Jar"><a href="#打包成可执行的Jar" class="headerlink" title="打包成可执行的Jar"></a>打包成可执行的Jar</h2><p>默认情况下Spring Boot打包出来的jar包是不可执行的，需要这样配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugins&gt;</span><br><span class="line">    &lt;plugin&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;spring-boot.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;executions&gt;</span><br><span class="line">            &lt;execution&gt;</span><br><span class="line">                &lt;goals&gt;</span><br><span class="line">                    &lt;goal&gt;repackage&lt;/goal&gt;</span><br><span class="line">                &lt;/goals&gt;</span><br><span class="line">            &lt;/execution&gt;</span><br><span class="line">        &lt;/executions&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line">&lt;/plugins&gt;</span><br></pre></td></tr></table></figure>
<p>打包之后会发现有<strong>两个</strong>jar，一个是本身的代码，一个是集成了Spring Boot的可运行jar：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/repackage.png" alt=""></p>
<h2 id="打包依赖了Spring-Boot的工具库"><a href="#打包依赖了Spring-Boot的工具库" class="headerlink" title="打包依赖了Spring Boot的工具库"></a>打包依赖了Spring Boot的工具库</h2><p>只需要在打包插件<code>spring-boot-maven-plugin</code>中这样配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;executions&gt;</span><br><span class="line">                &lt;execution&gt;</span><br><span class="line">                    &lt;phase&gt;none&lt;/phase&gt;</span><br><span class="line">                &lt;/execution&gt;</span><br><span class="line">            &lt;/executions&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>
<h2 id="打包契约类"><a href="#打包契约类" class="headerlink" title="打包契约类"></a>打包契约类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;includes&gt;</span><br><span class="line">                    &lt;include&gt;com/yangbingdong/server/**/contract/**/*.class&lt;/include&gt;</span><br><span class="line">                &lt;/includes&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;executions&gt;</span><br><span class="line">                &lt;execution&gt;</span><br><span class="line">                    &lt;phase&gt;none&lt;/phase&gt;</span><br><span class="line">                &lt;/execution&gt;</span><br><span class="line">            &lt;/executions&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>
<p>然后指定该pom文件构建：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn -f pom_own.xml package</span><br></pre></td></tr></table></figure>
<h1 id="配置文件：Properties-和-YAML"><a href="#配置文件：Properties-和-YAML" class="headerlink" title="配置文件：Properties 和 YAML"></a>配置文件：Properties 和 YAML</h1><h2 id="配置文件的生效顺序，会对值进行覆盖"><a href="#配置文件的生效顺序，会对值进行覆盖" class="headerlink" title="配置文件的生效顺序，会对值进行覆盖"></a>配置文件的生效顺序，会对值进行覆盖</h2><ol>
<li><p><code>@TestPropertySource</code> 注解</p>
</li>
<li><p>命令行参数</p>
</li>
<li>Java系统属性（<code>System.getProperties()</code>）</li>
<li>操作系统环境变量</li>
<li>只有在<code>random.*</code>里包含的属性会产生一个<code>RandomValuePropertySource</code></li>
<li>在打包的jar外的应用程序配置文件（<code>application.properties</code>，包含YAML和profile变量）</li>
<li>在打包的jar内的应用程序配置文件（<code>application.properties</code>，包含YAML和profile变量）</li>
<li>在<code>@Configuration</code>类上的<code>@PropertySource</code>注解</li>
<li>默认属性（使用<code>SpringApplication.setDefaultProperties</code>指定）</li>
</ol>
<h2 id="配置随机值"><a href="#配置随机值" class="headerlink" title="配置随机值"></a>配置随机值</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">roncoo.secret=$&#123;random.value&#125;</span><br><span class="line">roncoo.number=$&#123;random.int&#125;</span><br><span class="line">roncoo.bignumber=$&#123;random.long&#125;</span><br><span class="line">roncoo.number.less.than.ten=$&#123;random.int(10)&#125;</span><br><span class="line">roncoo.number.in.range=$&#123;random.int[1024,65536]&#125;</span><br><span class="line"></span><br><span class="line">读取使用注解：@Value(value = &quot;$&#123;roncoo.secret&#125;&quot;)</span><br></pre></td></tr></table></figure>
<h2 id="应用简单配置"><a href="#应用简单配置" class="headerlink" title="应用简单配置"></a>应用简单配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#端口配置：</span><br><span class="line">server.port=8090</span><br><span class="line">#应用名</span><br><span class="line">spring.application.name=test-demo</span><br><span class="line">#时间格式化</span><br><span class="line">spring.jackson.date-format=yyyy-MM-dd HH:mm:ss</span><br><span class="line">#时区设置</span><br><span class="line">spring.jackson.time-zone=Asia/Chongqing</span><br></pre></td></tr></table></figure>
<h2 id="配置文件-多环境配置"><a href="#配置文件-多环境配置" class="headerlink" title="配置文件-多环境配置"></a>配置文件-多环境配置</h2><h3 id="多环境配置的好处"><a href="#多环境配置的好处" class="headerlink" title="多环境配置的好处"></a>多环境配置的好处</h3><blockquote>
<ul>
<li>不同环境配置可以配置不同的参数</li>
<li>便于部署，提高效率，减少出错</li>
</ul>
</blockquote>
<h3 id="Properties多环境配置"><a href="#Properties多环境配置" class="headerlink" title="Properties多环境配置"></a>Properties多环境配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1. 配置激活选项</span><br><span class="line">spring.profiles.active=dev</span><br><span class="line"></span><br><span class="line">2.添加其他配置文件</span><br><span class="line">application.properties</span><br><span class="line">application-dev.properties</span><br><span class="line">application-prod.properties</span><br><span class="line">application-test.properties</span><br></pre></td></tr></table></figure>
<h3 id="YAML多环境配置"><a href="#YAML多环境配置" class="headerlink" title="YAML多环境配置"></a>YAML多环境配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.配置激活选项</span><br><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: dev</span><br><span class="line">2.在配置文件添加三个英文状态下的短横线即可区分</span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  profiles: dev</span><br></pre></td></tr></table></figure>
<h3 id="两种配置方式的比较"><a href="#两种配置方式的比较" class="headerlink" title="两种配置方式的比较"></a>两种配置方式的比较</h3><ul>
<li>Properties配置多环境，需要添加多个配置文件，YAML只需要一个配件文件</li>
<li>书写格式的差异，yaml相对比较简洁，优雅</li>
<li>YAML的缺点：不能通过<code>@PropertySource</code>注解加载。如果需要使用<code>@PropertySource</code>注解的方式加载值，那就要使用properties文件。</li>
</ul>
<h3 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dspring.profiles.active=dev -jar myapp.jar</span><br></pre></td></tr></table></figure>
<h1 id="热部署"><a href="#热部署" class="headerlink" title="热部署"></a>热部署</h1><p><code>pom.xml</code>添加依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!--支持热启动jar包--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;</span><br><span class="line">        &lt;!-- optional=true,依赖不会传递，该项目依赖devtools；之后依赖该项目的项目如果想要使用devtools，需要重新引入 --&gt;</span><br><span class="line">        &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;fork&gt;true&lt;/fork&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>
<p><code>application.yml</code>配置文件中添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  devtools:</span><br><span class="line">    restart:</span><br><span class="line">      #热部署生效 默认就是为true</span><br><span class="line">      enabled: true</span><br><span class="line">      #classpath目录下的WEB-INF文件夹内容修改不重启</span><br><span class="line">      exclude: WEB-INF/**</span><br></pre></td></tr></table></figure>
<p>关于DevTools的键值如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># DEVTOOLS (DevToolsProperties)</span><br><span class="line">spring.devtools.livereload.enabled=true # Enable a livereload.com compatible server.</span><br><span class="line">spring.devtools.livereload.port=35729 # Server port.</span><br><span class="line">spring.devtools.restart.additional-exclude= # Additional patterns that should be excluded from triggering a full restart.</span><br><span class="line">spring.devtools.restart.additional-paths= # Additional paths to watch for changes.</span><br><span class="line">spring.devtools.restart.enabled=true # Enable automatic restart.</span><br><span class="line">spring.devtools.restart.exclude=META-INF/maven/**,META-INF/resources/**,resources/**,static/**,public/**,templates/**,**/*Test.class,**/*Tests.class,git.properties # Patterns that should be excluded from triggering a full restart.</span><br><span class="line">spring.devtools.restart.poll-interval=1000 # Amount of time (in milliseconds) to wait between polling for classpath changes.</span><br><span class="line">spring.devtools.restart.quiet-period=400 # Amount of quiet time (in milliseconds) required without any classpath changes before a restart is triggered.</span><br><span class="line">spring.devtools.restart.trigger-file= # Name of a specific file that when changed will trigger the restart check. If not specified any classpath file change will trigger the restart.</span><br><span class="line"></span><br><span class="line"># REMOTE DEVTOOLS (RemoteDevToolsProperties)</span><br><span class="line">spring.devtools.remote.context-path=/.~~spring-boot!~ # Context path used to handle the remote connection.</span><br><span class="line">spring.devtools.remote.debug.enabled=true # Enable remote debug support.</span><br><span class="line">spring.devtools.remote.debug.local-port=8000 # Local remote debug server port.</span><br><span class="line">spring.devtools.remote.proxy.host= # The host of the proxy to use to connect to the remote application.</span><br><span class="line">spring.devtools.remote.proxy.port= # The port of the proxy to use to connect to the remote application.</span><br><span class="line">spring.devtools.remote.restart.enabled=true # Enable remote restart.</span><br><span class="line">spring.devtools.remote.secret= # A shared secret required to establish a connection (required to enable remote support).</span><br><span class="line">spring.devtools.remote.secret-header-name=X-AUTH-TOKEN # HTTP header used to transfer the shared secret.</span><br></pre></td></tr></table></figure><p></p>
<p>当我们修改了java类后，IDEA默认是不自动编译的，而<code>spring-boot-devtools</code>又是监测<code>classpath</code>下的文件发生变化才会重启应用，所以需要设置IDEA的自动编译：</p>
<p>（1）<strong>File-Settings-Compiler-Build Project automatically</strong></p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/spring-boot-devtools01.png" alt=""></p>
<p>（2）<strong>ctrl + shift + alt + /,选择Registry,勾上 Compiler autoMake allow when app running</strong></p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/spring-boot-devtools02.png" alt=""></p>
<p>OK了，重启一下项目，然后改一下类里面的内容，IDEA就会自动去make了。</p>
<blockquote>
<p><strong>热部署可能会牺牲一定的系统性能，因为是动态的编译</strong></p>
</blockquote>
<h1 id="使用为Undertow作为Web容器"><a href="#使用为Undertow作为Web容器" class="headerlink" title="使用为Undertow作为Web容器"></a>使用为Undertow作为Web容器</h1><blockquote>
<p>Spring Boot内嵌容器支持Tomcat、Jetty、Undertow。<br>根据 <a href="https://link.jianshu.com/?t=https://examples.javacodegeeks.com/enterprise-java/spring/tomcat-vs-jetty-vs-undertow-comparison-of-spring-boot-embedded-servlet-containers/" rel="external nofollow noopener noreferrer" target="_blank">Tomcat vs. Jetty vs. Undertow: Comparison of Spring Boot Embedded Servlet Containers</a> 这篇文章统计，Undertow的综合性能更好。</p>
<p>在Spring Boot 2中，已经把netty作为webflux的默认容器</p>
</blockquote>
<h2 id="与Tomcat性能对比"><a href="#与Tomcat性能对比" class="headerlink" title="与Tomcat性能对比"></a>与Tomcat性能对比</h2><p>以下是Undertow与Tomcat简单的性能测试（同样是默认配置）</p>
<p>Tomcat:</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/tomcat-gatling-test.jpg" alt=""></p>
<p>Undertow:</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/undertow-gatling-test.jpg" alt=""></p>
<p>显然Undertow的吞吐量要比Tomcat高</p>
<h2 id="Maven配置"><a href="#Maven配置" class="headerlink" title="Maven配置"></a>Maven配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;!-- 移除默认web容器，使用undertow --&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">    &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">如果是webflux，默认的容器的netty</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;!-- 移除默认web容器，使用undertow --&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-reactor-netty&lt;/artifactId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">    &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 使用高性能 Web 容器 undertow --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-undertow&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h2 id="监听多个端口与HTTP2支持"><a href="#监听多个端口与HTTP2支持" class="headerlink" title="监听多个端口与HTTP2支持"></a>监听多个端口与HTTP2支持</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 在@Configuration的类中添加@bean</span><br><span class="line">@Bean</span><br><span class="line">UndertowEmbeddedServletContainerFactory embeddedServletContainerFactory() &#123;</span><br><span class="line">    </span><br><span class="line">    UndertowEmbeddedServletContainerFactory factory = new UndertowEmbeddedServletContainerFactory();</span><br><span class="line">    </span><br><span class="line">    // 这里也可以做其他配置</span><br><span class="line">	// 支持HTTP2</span><br><span class="line">	factory.addBuilderCustomizers(builder -&gt; &#123;</span><br><span class="line">		builder.setServerOption(UndertowOptions.ENABLE_HTTP2, true);</span><br><span class="line">		// 监听多个端口</span><br><span class="line">		builder.addHttpListener(8080, &quot;0.0.0.0&quot;);</span><br><span class="line">	&#125;);</span><br><span class="line">    return factory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Undertow相关配置"><a href="#Undertow相关配置" class="headerlink" title="Undertow相关配置"></a>Undertow相关配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># Undertow 日志存放目录</span><br><span class="line">server.undertow.accesslog.dir</span><br><span class="line"># 是否启动日志</span><br><span class="line">server.undertow.accesslog.enabled=false </span><br><span class="line"># 日志格式</span><br><span class="line">server.undertow.accesslog.pattern=common</span><br><span class="line"># 日志文件名前缀</span><br><span class="line">server.undertow.accesslog.prefix=access_log</span><br><span class="line"># 日志文件名后缀</span><br><span class="line">server.undertow.accesslog.suffix=log</span><br><span class="line"># HTTP POST请求最大的大小</span><br><span class="line">server.undertow.max-http-post-size=0 </span><br><span class="line"># 设置IO线程数, 它主要执行非阻塞的任务,它们会负责多个连接, 默认设置每个CPU核心一个线程</span><br><span class="line">server.undertow.io-threads=4</span><br><span class="line"># 阻塞任务线程池, 当执行类似servlet请求阻塞操作, undertow会从这个线程池中取得线程,它的值设置取决于系统的负载，默认数量为 CPU核心*8</span><br><span class="line">server.undertow.worker-threads=20</span><br><span class="line"># 以下的配置会影响buffer,这些buffer会用于服务器连接的IO操作,有点类似netty的池化内存管理</span><br><span class="line"># 每块buffer的空间大小,越小的空间被利用越充分</span><br><span class="line">server.undertow.buffer-size=1024</span><br><span class="line"># 每个区分配的buffer数量 , 所以pool的大小是buffer-size * buffers-per-region</span><br><span class="line">server.undertow.buffers-per-region=1024</span><br><span class="line"># 是否分配的直接内存</span><br><span class="line">server.undertow.direct-buffers=true</span><br></pre></td></tr></table></figure>
<h1 id="日志相关"><a href="#日志相关" class="headerlink" title="日志相关"></a>日志相关</h1><h2 id="使用Log4j2"><a href="#使用Log4j2" class="headerlink" title="使用Log4j2"></a>使用Log4j2</h2><blockquote>
<p>更多Log4j2配置请看：<strong><em><a href="https://my.oschina.net/kkrgwbj/blog/734530" rel="external nofollow noopener noreferrer" target="_blank">https://my.oschina.net/kkrgwbj/blog/734530</a></em></strong></p>
</blockquote>
<p>下面是 Log4j2  官方性能测试结果：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/log4j2-performance.png" alt=""></p>
<h3 id="Maven配置-1"><a href="#Maven配置-1" class="headerlink" title="Maven配置"></a>Maven配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Spring Boot 依赖--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;!-- 去除 logback 依赖 --&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">    &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 日志 Log4j2 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-log4j2&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- Log4j2 异步支持 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.lmax&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;disruptor&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.3.8&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：需要单独把<code>spring-boot-starter</code>里面的<code>logging</code>去除再引入<code>spring-boot-starter-web</code>，否则后面引入的<code>starter</code>模块带有的<code>logging</code>不会自动去除</p>
<h3 id="开启全局异步"><a href="#开启全局异步" class="headerlink" title="开启全局异步"></a>开启全局异步</h3><blockquote>
<p>官方说明： <strong><em><a href="https://logging.apache.org/log4j/2.x/manual/async.html#AllAsync" rel="external nofollow noopener noreferrer" target="_blank">https://logging.apache.org/log4j/2.x/manual/async.html#AllAsync</a></em></strong></p>
</blockquote>
<p>添加Disruptor依赖后只需要添加启动参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dlog4j2.contextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector</span><br></pre></td></tr></table></figure>
<p>也可以在程序启动时添加系统参数。</p>
<blockquote>
<p>若想知道Disruptor是否生效，可以在<code>AsyncLogger#logMessage</code>中断点</p>
</blockquote>
<h3 id="application-yml简单配置"><a href="#application-yml简单配置" class="headerlink" title="application.yml简单配置"></a>application.yml简单配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">logging:</span><br><span class="line">  config: classpath:log4j2.xml # 指定log4j2配置文件的路径，默认就是这个</span><br><span class="line">  pattern:</span><br><span class="line">    console: &quot;%clr&#123;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;&#125;&#123;faint&#125; | %clr&#123;%5p&#125; | %clr&#123;%15.15t&#125;&#123;faint&#125; | %clr&#123;%-50.50c&#123;1.&#125;&#125;&#123;cyan&#125; | %5L | %clr&#123;%M&#125;&#123;magenta&#125; | %msg%n%xwEx&quot; # 控制台日志输出格式</span><br></pre></td></tr></table></figure>
<h3 id="log4j2-xml配置"><a href="#log4j2-xml配置" class="headerlink" title="log4j2.xml配置"></a>log4j2.xml配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!-- Configuration后面的status，这个用于设置log4j2自身内部的信息输出，可以不设置，当设置成trace时，</span><br><span class="line">     你会看到log4j2内部各种详细输出。可以设置成OFF(关闭) 或 Error(只输出错误信息)。</span><br><span class="line">     30s 刷新此配置</span><br><span class="line">--&gt;</span><br><span class="line">&lt;configuration status=&quot;OFF&quot; monitorInterval=&quot;30&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 日志文件目录、压缩文件目录、日志格式配置 --&gt;</span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;Property name=&quot;fileName&quot;&gt;/home/ybd/logs&lt;/Property&gt;</span><br><span class="line">        &lt;Property name=&quot;fileGz&quot;&gt;/home/ybd/logs/7z&lt;/Property&gt;</span><br><span class="line">        &lt;Property name=&quot;PID&quot;&gt;????&lt;/Property&gt;</span><br><span class="line">        &lt;!--&lt;Property name=&quot;LOG_PATTERN&quot;&gt;%clr&#123;%d&#123;yyyy-MM-dd HH:mm:ss.SSS z&#125;&#125;&#123;faint&#125; %clr&#123;%5p&#125; %clr&#123;$&#123;sys:PID&#125;&#125;&#123;magenta&#125;</span><br><span class="line">            %clr&#123;-&amp;#45;&amp;#45;&#125;&#123;faint&#125; %clr&#123;[%t]&#125;&#123;faint&#125; %clr&#123;%-40.40c&#123;1.&#125;&#125;&#123;cyan&#125; %clr&#123;:&#125;&#123;faint&#125; %m%n%xwEx</span><br><span class="line">        &lt;/Property&gt;--&gt;</span><br><span class="line">        &lt;Property name=&quot;LOG_PATTERN&quot;&gt;%clr&#123;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;&#125;&#123;faint&#125; | %clr&#123;%5p&#125; | %clr&#123;$&#123;sys:PID&#125;&#125;&#123;magenta&#125; | %clr&#123;%15.15t&#125;&#123;faint&#125; | %clr&#123;%-50.50c&#123;1.&#125;&#125;&#123;cyan&#125; | %5L | %clr&#123;%M&#125;&#123;magenta&#125; | %msg%n%xwEx</span><br><span class="line">        &lt;/Property&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Appenders&gt;</span><br><span class="line">        &lt;!-- 输出控制台日志的配置 --&gt;</span><br><span class="line">        &lt;Console name=&quot;console&quot; target=&quot;SYSTEM_OUT&quot;&gt;</span><br><span class="line">            &lt;!--控制台只输出level及以上级别的信息（onMatch），其他的直接拒绝（onMismatch）--&gt;</span><br><span class="line">            &lt;ThresholdFilter level=&quot;info&quot; onMatch=&quot;ACCEPT&quot; onMismatch=&quot;DENY&quot;/&gt;</span><br><span class="line">            &lt;!-- 输出日志的格式 --&gt;</span><br><span class="line">            &lt;PatternLayout pattern=&quot;$&#123;LOG_PATTERN&#125;&quot; charset=&quot;UTF-8&quot;/&gt;</span><br><span class="line">        &lt;/Console&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 打印出所有的信息，每次大小超过size，则这size大小的日志会自动存入按年份-月份建立的文件夹下面并进行压缩，作为存档 --&gt;</span><br><span class="line">        &lt;RollingRandomAccessFile name=&quot;infoFile&quot; fileName=&quot;$&#123;fileName&#125;/web-info.log&quot; immediateFlush=&quot;false&quot;</span><br><span class="line">                                 filePattern=&quot;$&#123;fileGz&#125;/$$&#123;date:yyyy-MM&#125;/%d&#123;yyyy-MM-dd&#125;-%i.web-info.gz&quot;&gt;</span><br><span class="line">            &lt;PatternLayout pattern=&quot;$&#123;LOG_PATTERN&#125;&quot; charset=&quot;UTF-8&quot;/&gt;</span><br><span class="line"></span><br><span class="line">            &lt;Policies&gt;</span><br><span class="line">                &lt;SizeBasedTriggeringPolicy size=&quot;20 MB&quot;/&gt;</span><br><span class="line">            &lt;/Policies&gt;</span><br><span class="line"></span><br><span class="line">            &lt;Filters&gt;</span><br><span class="line">                &lt;!-- 只记录info和warn级别信息 --&gt;</span><br><span class="line">                &lt;ThresholdFilter level=&quot;error&quot; onMatch=&quot;DENY&quot; onMismatch=&quot;NEUTRAL&quot;/&gt;</span><br><span class="line">                &lt;ThresholdFilter level=&quot;info&quot; onMatch=&quot;ACCEPT&quot; onMismatch=&quot;DENY&quot;/&gt;</span><br><span class="line">            &lt;/Filters&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!-- 指定每天的最大压缩包个数，默认7个，超过了会覆盖之前的 --&gt;</span><br><span class="line">            &lt;DefaultRolloverStrategy max=&quot;50&quot;/&gt;</span><br><span class="line">        &lt;/RollingRandomAccessFile&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 存储所有error信息 --&gt;</span><br><span class="line">        &lt;RollingRandomAccessFile name=&quot;errorFile&quot; fileName=&quot;$&#123;fileName&#125;/web-error.log&quot; immediateFlush=&quot;false&quot;</span><br><span class="line">                                 filePattern=&quot;$&#123;fileGz&#125;/$$&#123;date:yyyy-MM&#125;/%d&#123;yyyy-MM-dd&#125;-%i.web-error.gz&quot;&gt;</span><br><span class="line">            &lt;PatternLayout pattern=&quot;$&#123;LOG_PATTERN&#125;&quot; charset=&quot;UTF-8&quot;/&gt;</span><br><span class="line"></span><br><span class="line">            &lt;Policies&gt;</span><br><span class="line">                &lt;SizeBasedTriggeringPolicy size=&quot;50 MB&quot;/&gt;</span><br><span class="line">            &lt;/Policies&gt;</span><br><span class="line"></span><br><span class="line">            &lt;Filters&gt;</span><br><span class="line">                &lt;!-- 只记录error级别信息 --&gt;</span><br><span class="line">                &lt;ThresholdFilter level=&quot;error&quot; onMatch=&quot;ACCEPT&quot; onMismatch=&quot;DENY&quot;/&gt;</span><br><span class="line">            &lt;/Filters&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!-- 指定每天的最大压缩包个数，默认7个，超过了会覆盖之前的 --&gt;</span><br><span class="line">            &lt;DefaultRolloverStrategy max=&quot;50&quot;/&gt;</span><br><span class="line">        &lt;/RollingRandomAccessFile&gt;</span><br><span class="line">    &lt;/Appenders&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- Mixed sync/async --&gt;</span><br><span class="line">    &lt;Loggers&gt;</span><br><span class="line">    </span><br><span class="line">        &lt;!--&lt;logger name=&quot;org.apache.http&quot; level=&quot;warn&quot;/&gt;</span><br><span class="line">        &lt;logger name=&quot;org.springframework&quot; level=&quot;WARN&quot;/&gt;</span><br><span class="line">        &lt;logger name=&quot;com.ibatis&quot; level=&quot;DEBUG&quot;/&gt;</span><br><span class="line">        &lt;logger name=&quot;com.ibatis.common.jdbc.SimpleDataSource&quot; level=&quot;DEBUG&quot;/&gt;</span><br><span class="line">        &lt;logger name=&quot;com.ibatis.common.jdbc.ScriptRunner&quot; level=&quot;DEBUG&quot;/&gt;</span><br><span class="line">        &lt;logger name=&quot;com.ibatis.sqlmap.engine.impl.SqlMapClientDelegate&quot; level=&quot;DEBUG&quot;/&gt;</span><br><span class="line">        &lt;logger name=&quot;java.sql.Connection&quot; level=&quot;DEBUG&quot; additivity=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;logger name=&quot;java.sql.Statement&quot; level=&quot;DEBUG&quot; additivity=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;logger name=&quot;java.sql.PreparedStatement&quot; level=&quot;=debug,stdout&quot; additivity=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;logger name=&quot;java.sql.ResultSet&quot; level=&quot;DEBUG&quot; additivity=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;logger name=&quot;org.apache&quot; level=&quot;WARN&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &amp;lt;!&amp;ndash; 对包进行更详细的配置 &amp;ndash;&amp;gt;</span><br><span class="line">        &amp;lt;!&amp;ndash; additivity表示是否追加,防止重复,因为root已经接收过一次了 &amp;ndash;&amp;gt;</span><br><span class="line">        &lt;logger name=&quot;com.my.blog.website.dao&quot; level=&quot;DEBUG&quot; additivity=&quot;true&quot;&gt;</span><br><span class="line">            &lt;appender-ref ref=&quot;db_log&quot;/&gt;</span><br><span class="line">        &lt;/logger&gt;</span><br><span class="line">        &lt;logger name=&quot;com.my.blog.website.controller&quot; level=&quot;DEBUG&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">            &lt;appender-ref ref=&quot;service_log&quot;/&gt;</span><br><span class="line">        &lt;/logger&gt;</span><br><span class="line">        &lt;logger name=&quot;com.my.blog.website.service&quot; level=&quot;DEBUG&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">            &lt;appender-ref ref=&quot;service_log&quot;/&gt;</span><br><span class="line">        &lt;/logger&gt;--&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Root level=&quot;debug&quot; includeLocation=&quot;true&quot;&gt;</span><br><span class="line">            &lt;AppenderRef ref=&quot;console&quot;/&gt;</span><br><span class="line">            &lt;AppenderRef ref=&quot;infoFile&quot;/&gt;</span><br><span class="line">            &lt;AppenderRef ref=&quot;errorFile&quot;/&gt;</span><br><span class="line">        &lt;/Root&gt;</span><br><span class="line">    &lt;/Loggers&gt;</span><br><span class="line"></span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>启用了全局异步需要将<code>includeLocation</code>设为<code>true</code>才能打印路径之类的信息</li>
</ul>
<h3 id="也可以使用log4j2-yml"><a href="#也可以使用log4j2-yml" class="headerlink" title="也可以使用log4j2.yml"></a>也可以使用log4j2.yml</h3><p>需要引入依赖以识别：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 加上这个才能辨认到log4j2.yml文件 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.fasterxml.jackson.dataformat&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jackson-dataformat-yaml&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p><code>log4j2.yml</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Configuration:</span><br><span class="line">  status: &quot;OFF&quot;</span><br><span class="line">  monitorInterval: 10</span><br><span class="line"></span><br><span class="line">  Properties:</span><br><span class="line">    Property:</span><br><span class="line">      - name: log.level.console</span><br><span class="line">        value: debug</span><br><span class="line">      - name: PID</span><br><span class="line">        value: ????</span><br><span class="line">      - name: LOG_PATTERN</span><br><span class="line">        value: &quot;%clr&#123;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;&#125;&#123;faint&#125; | %clr&#123;%5p&#125; | %clr&#123;$&#123;sys:PID&#125;&#125;&#123;magenta&#125; | %clr&#123;%15.15t&#125;&#123;faint&#125; | %clr&#123;%-50.50c&#123;1.&#125;&#125;&#123;cyan&#125; | %5L | %clr&#123;%M&#125;&#123;magenta&#125; | %msg%n%xwEx&quot;</span><br><span class="line"></span><br><span class="line">  Appenders:</span><br><span class="line">    Console:  #输出到控制台</span><br><span class="line">      name: CONSOLE</span><br><span class="line">      target: SYSTEM_OUT</span><br><span class="line">      ThresholdFilter:</span><br><span class="line">        level: $&#123;sys:log.level.console&#125; # “sys:”表示：如果VM参数中没指定这个变量值，则使用本文件中定义的缺省全局变量值</span><br><span class="line">        onMatch: ACCEPT</span><br><span class="line">        onMismatch: DENY</span><br><span class="line">      PatternLayout:</span><br><span class="line">        pattern: $&#123;LOG_PATTERN&#125;</span><br><span class="line">        charset: UTF-8</span><br><span class="line">  Loggers:</span><br><span class="line">    Root:</span><br><span class="line">      level: info</span><br><span class="line">      includeLocation: true</span><br><span class="line">      AppenderRef:</span><br><span class="line">        - ref: CONSOLE</span><br><span class="line">    AsyncRoot:</span><br><span class="line">      level: info</span><br><span class="line">      includeLocation: true</span><br><span class="line">      AppenderRef:</span><br><span class="line">        - ref: CONSOLE</span><br></pre></td></tr></table></figure>
<p>更多配置请参照：<em><a href="http://logging.apache.org/log4j/2.x/manual/layouts.html" rel="external nofollow noopener noreferrer" target="_blank">http://logging.apache.org/log4j/2.x/manual/layouts.html</a></em></p>
<h2 id="日志配置文件中获取Application配置项"><a href="#日志配置文件中获取Application配置项" class="headerlink" title="日志配置文件中获取Application配置项"></a>日志配置文件中获取Application配置项</h2><h3 id="Logback"><a href="#Logback" class="headerlink" title="Logback"></a>Logback</h3><p>方法1: 使用<code>logback-spring.xml</code>，因为<code>logback.xml</code>加载早于<code>application.properties</code>，所以如果你在<code>logback.xml</code>使用了变量时，而恰好这个变量是写在<code>application.properties</code>时，那么就会获取不到，只要改成<code>logback-spring.xml</code>就可以解决。</p>
<p>方法2: 使用<code>&lt;springProperty&gt;</code>标签，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;springProperty scope=&quot;context&quot; name=&quot;LOG_HOME&quot; source=&quot;logback.file&quot;/&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Log4j2"><a href="#Log4j2" class="headerlink" title="Log4j2"></a>Log4j2</h3><p>只能写一个Lookup：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unused&quot;)</span><br><span class="line">@Plugin(name = &quot;spring&quot;, category = StrLookup.CATEGORY)</span><br><span class="line">public class SpringEnvironmentLookup extends AbstractLookup &#123;</span><br><span class="line">	private static LinkedHashMap profileYmlData;</span><br><span class="line">	private static LinkedHashMap metaYmlData;</span><br><span class="line">	private static boolean profileExist;</span><br><span class="line">	private static Map&lt;String, String&gt; map = new HashMap&lt;&gt;(16);</span><br><span class="line">	private static final String META_PROFILE = &quot;application.yml&quot;;</span><br><span class="line">	private static final String PROFILE_PREFIX = &quot;application&quot;;</span><br><span class="line">	private static final String PROFILE_SUFFIX = &quot;.yml&quot;;</span><br><span class="line">	private static final String DEFAULT_PROFILE = &quot;application-dev.yml&quot;;</span><br><span class="line">	private static final String SPRING_PROFILES_ACTIVE = &quot;spring.profiles.active&quot;;</span><br><span class="line"></span><br><span class="line">	static &#123;</span><br><span class="line">		try &#123;</span><br><span class="line">			metaYmlData = new Yaml().loadAs(new ClassPathResource(META_PROFILE).getInputStream(), LinkedHashMap.class);</span><br><span class="line">			Properties properties = System.getProperties();</span><br><span class="line">			String active = properties.getProperty(SPRING_PROFILES_ACTIVE);</span><br><span class="line">			if (isBlank(active)) &#123;</span><br><span class="line">				active = getValueFromData(SPRING_PROFILES_ACTIVE, metaYmlData);</span><br><span class="line">			&#125;</span><br><span class="line">			String configName = isNotBlank(active) ? PROFILE_PREFIX + &quot;-&quot; + active + PROFILE_SUFFIX : DEFAULT_PROFILE;</span><br><span class="line">			ClassPathResource classPathResource = new ClassPathResource(configName);</span><br><span class="line">			profileExist = classPathResource.exists();</span><br><span class="line">			if (profileExist) &#123;</span><br><span class="line">				profileYmlData = new Yaml().loadAs(classPathResource.getInputStream(), LinkedHashMap.class);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			throw new RuntimeException(&quot;SpringEnvironmentLookup initialize fail&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public String lookup(LogEvent event, String key) &#123;</span><br><span class="line">		return map.computeIfAbsent(key, SpringEnvironmentLookup::resolveYmlMapByKey);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private static String resolveYmlMapByKey(String key) &#123;</span><br><span class="line">		Assert.isTrue(isNotBlank(key), &quot;key can not be blank!&quot;);</span><br><span class="line">		String[] keyChain = key.split(&quot;\\.&quot;);</span><br><span class="line">		String value = null;</span><br><span class="line">		if (profileExist) &#123;</span><br><span class="line">			value = getValueFromData(key, profileYmlData);</span><br><span class="line">		&#125;</span><br><span class="line">		if (isBlank(value)) &#123;</span><br><span class="line">			value = getValueFromData(key, metaYmlData);</span><br><span class="line">		&#125;</span><br><span class="line">		return value;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private static String getValueFromData(String key, LinkedHashMap dataMap) &#123;</span><br><span class="line">		String[] keyChain = key.split(&quot;\\.&quot;);</span><br><span class="line">		int length = keyChain.length;</span><br><span class="line">		if (length == 1) &#123;</span><br><span class="line">			return getFinalValue(key, dataMap);</span><br><span class="line">		&#125;</span><br><span class="line">		String k;</span><br><span class="line">		LinkedHashMap[] mapChain = new LinkedHashMap[length];</span><br><span class="line">		mapChain[0] = dataMap;</span><br><span class="line">		for (int i = 0; i &lt; length; i++) &#123;</span><br><span class="line">			if (i == length - 1) &#123;</span><br><span class="line">				return getFinalValue(keyChain[i], mapChain[i]);</span><br><span class="line">			&#125;</span><br><span class="line">			k = keyChain[i];</span><br><span class="line">			Object o = mapChain[i].get(k);</span><br><span class="line">			if (Objects.isNull(o)) &#123;</span><br><span class="line">				return &quot;&quot;;</span><br><span class="line">			&#125;</span><br><span class="line">			if (o instanceof LinkedHashMap) &#123;</span><br><span class="line">				mapChain[i + 1] = (LinkedHashMap) o;</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">				throw new IllegalArgumentException();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return &quot;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private static String getFinalValue(String k, LinkedHashMap ymlData) &#123;</span><br><span class="line">		return defaultIfNull((String) ymlData.get(k), &quot;&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在<code>log4j2.xml</code>中这样使用 <code>${spring:spring.application.name}</code></p>
<h2 id="自定义字段"><a href="#自定义字段" class="headerlink" title="自定义字段"></a>自定义字段</h2><p>可以利用<code>MDC</code>实现当前线程自定义字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MDC.put(&quot;IP&quot;, IpUtil.getIpAddr(request));</span><br></pre></td></tr></table></figure>
<p><code>log4j2.xml</code>中这样获取<code>%X{IP}</code></p>
<h1 id="查看依赖树"><a href="#查看依赖树" class="headerlink" title="查看依赖树"></a>查看依赖树</h1><p>如果引入了某些jar包带有<code>logback</code>依赖，log4j2会失效，需要通过IDEA或Maven查找排除依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn dependency:tree</span><br></pre></td></tr></table></figure>
<h1 id="创建异步方法"><a href="#创建异步方法" class="headerlink" title="创建异步方法"></a>创建异步方法</h1><h2 id="启动异步"><a href="#启动异步" class="headerlink" title="启动异步"></a>启动异步</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@EnableAsync</span><br><span class="line">public class SpringAsyncConfig &#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置完这个就已经具备异步方法功能了，只需要在方法上面添加<code>@Async</code>即可</p>
<p>如果被<code>@Async</code>注解的方法所在类是基于接口实现的，想要直接注入实现类，需要添加：<code>@EnableAsync(proxyTargetClass = true)</code> 以使用CGLIB代理</p>
<h2 id="编写异步方法"><a href="#编写异步方法" class="headerlink" title="编写异步方法"></a>编写异步方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Async</span><br><span class="line">public void asyncMethodWithVoidReturnType() throws InterruptedException &#123;</span><br><span class="line">	System.out.println(&quot;Execute method asynchronously. &quot; + Thread.currentThread().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="配置线程池"><a href="#配置线程池" class="headerlink" title="配置线程池"></a>配置线程池</h2><p>在不配置线程池的情况下，Spring<strong>默认使用</strong><code>SimpleAsyncTaskExecutor</code>，每一次的执行任务都会使用新的线程，性能不太好，所以我们可以自定义线程池</p>
<h3 id="直接声明线程池"><a href="#直接声明线程池" class="headerlink" title="直接声明线程池"></a>直接声明线程池</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@EnableAsync</span><br><span class="line">public class SpringAsyncConfig &#123;</span><br><span class="line">	@Bean</span><br><span class="line">	public Executor threadPoolTaskExecutor() &#123;</span><br><span class="line">		ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();</span><br><span class="line">		executor.setCorePoolSize(10);</span><br><span class="line">		executor.setMaxPoolSize(20);</span><br><span class="line">		executor.setQueueCapacity(500);</span><br><span class="line">		executor.setKeepAliveSeconds(60);</span><br><span class="line">		executor.setThreadNamePrefix(&quot;asyncExecutor-&quot;);</span><br><span class="line">		executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());</span><br><span class="line">		executor.initialize();</span><br><span class="line">		return executor;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过使用<code>ThreadPoolTaskExecutor</code>创建了一个线程池，同时设置了以下这些参数：</p>
<ul>
<li>核心线程数10：线程池创建时候初始化的线程数</li>
<li>最大线程数20：线程池最大的线程数，只有在缓冲队列满了之后才会申请超过核心线程数的线程</li>
<li>缓冲队列500：用来缓冲执行任务的队列</li>
<li>允许线程的空闲时间60秒：当超过了核心线程出之外的线程在空闲时间到达之后会被销毁</li>
<li>线程池名的前缀：设置好了之后可以方便我们定位处理任务所在的线程池</li>
<li>线程池对拒绝任务的处理策略：这里采用了<code>CallerRunsPolicy</code>策略，当线程池没有处理能力的时候，该策略会直接在 execute 方法的调用线程中运行被拒绝的任务；如果执行程序已关闭，则会丢弃该任务</li>
</ul>
<h3 id="实现AsyncConfigurer"><a href="#实现AsyncConfigurer" class="headerlink" title="实现AsyncConfigurer"></a>实现AsyncConfigurer</h3><blockquote>
<p>通过这种方式，可以<strong>对异常进行处理</strong></p>
</blockquote>
<p><code>AsyncConfigurer</code>接口有两个方法：</p>
<ul>
<li><code>getAsyncExecutor()</code>: 提供线程池</li>
<li><code>getAsyncUncaughtExceptionHandler()</code>: 异步任务异常处理</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@EnableAsync</span><br><span class="line">public class SpringAsyncConfig implements AsyncConfigurer &#123;</span><br><span class="line">	@Override</span><br><span class="line">	public Executor getAsyncExecutor() &#123;</span><br><span class="line">		ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();</span><br><span class="line">		executor.setCorePoolSize(8);</span><br><span class="line">		executor.setMaxPoolSize(42);</span><br><span class="line">		executor.setQueueCapacity(500);</span><br><span class="line">		executor.setThreadNamePrefix(&quot;MyExecutor-&quot;);</span><br><span class="line">		executor.initialize();</span><br><span class="line">		return executor;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	@Override</span><br><span class="line">	public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler()&#123;</span><br><span class="line">		return (ex, method, params) -&gt; &#123;</span><br><span class="line">			ExceptionUtils.printRootCauseStackTrace(ex);</span><br><span class="line">			System.out.println(&quot;Exception message - &quot; + ex.getMessage());</span><br><span class="line">			System.out.println(&quot;Method name - &quot; + method.getName());</span><br><span class="line">			for (Object param : params) &#123;</span><br><span class="line">				System.out.println(&quot;Parameter value - &quot; + param);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="优雅关闭线程池"><a href="#优雅关闭线程池" class="headerlink" title="优雅关闭线程池"></a>优雅关闭线程池</h3><p>有时候，存在关闭程序但还有异步任务在执行的情况，这时候，我们需要优雅地关闭线程池，只需要两个参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">executor.setWaitForTasksToCompleteOnShutdown(true);</span><br><span class="line">executor.setAwaitTerminationSeconds(60);</span><br></pre></td></tr></table></figure>
<h2 id="Async使用指定线程池"><a href="#Async使用指定线程池" class="headerlink" title="Async使用指定线程池"></a>Async使用指定线程池</h2><p>如果同时实现了<code>AsyncConfigurer</code>以及配置线程池，那么<code>@Async</code>默认使用<code>AsyncConfigurer.getAsyncExecutor</code>的线程池。</p>
<p>如果需要指定线程池可以这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Async(&quot;threadPoolTaskExecutor&quot;)</span><br><span class="line">public void someMethod()&#123;...&#125;</span><br></pre></td></tr></table></figure>
<h2 id="获取异步执行结果"><a href="#获取异步执行结果" class="headerlink" title="获取异步执行结果"></a>获取异步执行结果</h2><p>Service：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Async(&quot;threadPoolTaskExecutor&quot;)</span><br><span class="line">@Override</span><br><span class="line">public Future&lt;String&gt; asyncMethodWithVoidReturnType() throws InterruptedException &#123;</span><br><span class="line">	Thread.sleep(2000L);</span><br><span class="line">	return AsyncResult.forValue(&quot;Execute method asynchronously. &quot; + Thread.currentThread().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Controller：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/hello&quot;)</span><br><span class="line">public Mono&lt;String&gt; syaHello() throws InterruptedException, ExecutionException &#123;</span><br><span class="line">	Future&lt;String&gt; stringFuture = someService.asyncMethodWithVoidReturnType();</span><br><span class="line">	while (!stringFuture.isDone())&#123;</span><br><span class="line">		System.out.println(&quot;wait...&quot;);</span><br><span class="line">		Thread.sleep(500L);</span><br><span class="line">	&#125;</span><br><span class="line">	System.out.println(stringFuture.get());</span><br><span class="line">	return Mono.just(&quot;Hello World&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wait...</span><br><span class="line">wait...</span><br><span class="line">wait...</span><br><span class="line">wait...</span><br><span class="line">wait...</span><br><span class="line">Execute method asynchronously. asyncExecutor-1</span><br></pre></td></tr></table></figure>
<h1 id="Spring定时任务"><a href="#Spring定时任务" class="headerlink" title="Spring定时任务"></a>Spring定时任务</h1><p>启用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@EnableScheduling</span><br><span class="line">public class SpringScheduleConfig implements SchedulingConfigurer &#123;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void configureTasks(ScheduledTaskRegistrar taskRegistrar) &#123;</span><br><span class="line">		taskRegistrar.setScheduler(taskExecutor());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	@Bean</span><br><span class="line">	public Executor taskExecutor() &#123;</span><br><span class="line">		return new ScheduledThreadPoolExecutor(4,</span><br><span class="line">				new BasicThreadFactory</span><br><span class="line">						.Builder()</span><br><span class="line">						.namingPattern(&quot;schedule-pool-thread-%d&quot;)</span><br><span class="line">						.daemon(true)</span><br><span class="line">						.build());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定时任务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private int i = 0;</span><br><span class="line"></span><br><span class="line">@Scheduled(fixedDelay=1000)</span><br><span class="line">public void doScheduled() &#123;</span><br><span class="line">	System.out.println(Thread.currentThread().getName() + &quot;  &quot; + ++i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">schedule-pool-thread-1  2</span><br><span class="line">schedule-pool-thread-2  3</span><br><span class="line">schedule-pool-thread-1  4</span><br><span class="line">schedule-pool-thread-3  5</span><br><span class="line">schedule-pool-thread-2  6</span><br></pre></td></tr></table></figure>
<h1 id="Spring启动后执行程序的几种方式"><a href="#Spring启动后执行程序的几种方式" class="headerlink" title="Spring启动后执行程序的几种方式"></a>Spring启动后执行程序的几种方式</h1><h2 id="PostConstruct-或-InitializingBean"><a href="#PostConstruct-或-InitializingBean" class="headerlink" title="@PostConstruct 或 InitializingBean"></a>@PostConstruct 或 InitializingBean</h2><p>通过<code>@PostConstruct</code>或实现<code>InitializingBean</code>实现初始化<code>bean</code>的时候干一些事情，两者区别在于<code>InitializingBean</code>是在属性设置完之后执行的，所以执行顺序是在<code>@PostConstruct</code>之前</p>
<blockquote>
<p>由于此接口的方法<code>afterPropertiesSet</code>是在对象的所有属性被初始化后才会调用。当Spring的配置文件中设置类初始默认为”延迟初始”（<code>default-lazy-init=&quot;true&quot;</code>，此值默认为<code>false</code>）时，</p>
<p>类对象如果不被使用，则不会实例化该类对象。所以 <code>InitializingBean</code>子类不能用于在容器启动时进行初始化的工作，则应使用Spring提供的<code>ApplicationListener</code>接口来进行程序的初始化工作。</p>
<p>另外，如果需要<code>InitializingBean</code>子类对象在Spring容器启动时就初始化并则容器调用<code>afterPropertiesSet</code>方法则需要在类上增加<code>org.springframework.context.annotation.Lazy</code>注解并设置为false即可（也可通过spring配置bean时添加<code>lazy-init=&quot;false&quot;</code>)。</p>
</blockquote>
<h2 id="监听ContextRefreshedEvent"><a href="#监听ContextRefreshedEvent" class="headerlink" title="监听ContextRefreshedEvent"></a>监听ContextRefreshedEvent</h2><p>通过监听<code>ContextRefreshedEvent</code>事件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class ApplicationContextRefreshedEventListener implements ApplicationListener&lt;ContextRefreshedEvent&gt; &#123;</span><br><span class="line">	@Override</span><br><span class="line">	public void onApplicationEvent(ContextRefreshedEvent event) &#123;</span><br><span class="line">		System.out.println(&quot;ContextRefreshedEvent process...&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line">@EventListener</span><br><span class="line">public void processContextRefreshedEvent(ContextRefreshedEvent event) throws InterruptedException &#123;</span><br><span class="line">	log.info(&quot;ContextRefreshedEvent process...&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring的事件处理是单线程的，所以如果一个事件被触发，除非所有的接收者得到消息，否则这些进程被阻止，流程将不会继续。因此，如果要使用事件处理，在设计应用程序时应小心。</p>
<h3 id="Spring内置事件"><a href="#Spring内置事件" class="headerlink" title="Spring内置事件"></a>Spring内置事件</h3><p>以下是Spring的内置事件</p>
<table>
<thead>
<tr>
<th>Spring 内置事件</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ContextRefreshedEvent</strong></td>
<td><code>ApplicationContext</code>被初始化或刷新时，该事件被发布。这也可以在<code>ConfigurableApplicationContext</code>接口中使用<code>refresh()</code>方法来发生。</td>
</tr>
<tr>
<td><strong>ContextStartedEvent</strong></td>
<td>当使用<code>ConfigurableApplicationContext</code>接口中的<code>start()</code>方法启动<code>ApplicationContext</code>时，该事件被触发。你可以查询你的数据库，或者你可以在接受到这个事件后重启任何停止的应用程序。</td>
</tr>
<tr>
<td><strong>ContextStoppedEvent</strong></td>
<td>当使用<code>ConfigurableApplicationContext</code>接口中的<code>stop()</code>方法停止<code>ApplicationContext</code>时，该事件被触发。你可以在接受到这个事件后做必要的清理的工作。</td>
</tr>
<tr>
<td><strong>ContextClosedEvent</strong></td>
<td>当使用<code>ConfigurableApplicationContext</code>接口中的<code>close()</code>方法关闭<code>ApplicationContext</code>时，该事件被触发。一个已关闭的上下文到达生命周期末端；它不能被刷新或重启。</td>
</tr>
<tr>
<td><strong>RequestHandledEvent</strong></td>
<td>这是一个<code>web-specific</code>事件，告诉所有<code>bean</code> HTTP请求已经被服务。</td>
</tr>
</tbody>
</table>
<h3 id="Spring-Boot-2-0新增事件"><a href="#Spring-Boot-2-0新增事件" class="headerlink" title="Spring Boot 2.0新增事件"></a>Spring Boot 2.0新增事件</h3><p>在Spring Boot 2.0中对事件模型做了一些增强，主要就是增加了<code>ApplicationStartedEvent</code>事件，所以在2.0版本中所有的事件按执行的先后顺序如下：</p>
<ul>
<li><code>ApplicationStartingEvent</code></li>
<li><code>ApplicationEnvironmentPreparedEvent</code></li>
<li><code>ApplicationPreparedEvent</code></li>
<li><code>ApplicationStartedEvent</code> &lt;= 新增的事件</li>
<li><code>ApplicationReadyEvent</code></li>
<li><code>ApplicationFailedEvent</code></li>
</ul>
<h2 id="ApplicationRunner-或-CommandLineRunner"><a href="#ApplicationRunner-或-CommandLineRunner" class="headerlink" title="ApplicationRunner 或 CommandLineRunner"></a>ApplicationRunner 或 CommandLineRunner</h2><p>实现<code>ApplicationRunner</code>或<code>CommandLineRunner</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">public class ProdSyncLayerApplication implements ApplicationRunner,CommandLineRunner&#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(ProdSyncLayerApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void run(ApplicationArguments args) throws Exception &#123;</span><br><span class="line">		System.out.println(&quot;ApplicationRunner...&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void run(String... args) throws Exception &#123;</span><br><span class="line">		System.out.println(&quot;CommandLineRunner...&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ApplicationRunner</code>比<code>CommandLineRunner</code>先执行</p>
<p><strong>总结</strong>：以上三种方式的顺序跟其序号一样</p>
<h2 id="onApplicationEvent执行两次问题"><a href="#onApplicationEvent执行两次问题" class="headerlink" title="onApplicationEvent执行两次问题"></a>onApplicationEvent执行两次问题</h2><p><code>applicationontext</code>和使用MVC之后的<code>webApplicationontext</code>会两次调用上面的方法，如何区分这个两种容器呢？</p>
<p>但是这个时候，会存在一个问题，在web 项目中（spring mvc），系统会存在两个容器，一个是<code>root application context</code> ,另一个就是我们自己的 <code>projectName-servlet context</code>（作为root application context的子容器）。</p>
<p>这种情况下，就会造成<code>onApplicationEvent</code>方法被执行两次。为了避免上面提到的问题，我们可以只在<code>root application context</code>初始化完成后调用逻辑代码，其他的容器的初始化完成，则不做任何处理，修改后代码 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override  </span><br><span class="line">public void onApplicationEvent(ContextRefreshedEvent event) &#123;  </span><br><span class="line">  if(event.getApplicationContext().getParent() == null)&#123;//root application context 没有parent，他就是老大.  </span><br><span class="line">       //需要执行的逻辑代码，当spring容器初始化完成后就会执行该方法。  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>后续发现加上以上判断还是能执行两次，不加的话三次，最终研究结果使用以下判断更加准确：<code>event.getApplicationContext().getDisplayName().equals(&quot;Root WebApplicationContext&quot;)</code></p>
</blockquote>
<h1 id="Spring应用停止前执行程序的几种方式"><a href="#Spring应用停止前执行程序的几种方式" class="headerlink" title="Spring应用停止前执行程序的几种方式"></a>Spring应用停止前执行程序的几种方式</h1><ol>
<li><p>监听<code>ContextClosedEvent</code></p>
</li>
<li><p>实现<code>DisposableBean</code>或使用<code>@PostConstruct</code>，执行顺序：<code>@PostConstruct</code> &gt; <code>DisposableBean</code></p>
</li>
<li><p>使用ShutdownHook:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public class ShutdownHook &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(new Thread(() -&gt; &#123;</span><br><span class="line">            try (FileWriter fw = new FileWriter(&quot;hook.log&quot;)) &#123;</span><br><span class="line">                // 假设记录日志/或者发送消息</span><br><span class="line">                fw.write(&quot;完成销毁操作,回收内存! &quot; + (new Date()).toString());</span><br><span class="line">                System.out.println(&quot;退出程序...&quot;);</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">        IntStream.range(0, 10).forEach(i -&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                System.out.println(&quot;正在工作...&quot;);</span><br><span class="line">                Thread.sleep(2000L);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="元注解与组合注解"><a href="#元注解与组合注解" class="headerlink" title="元注解与组合注解"></a>元注解与组合注解</h1><h2 id="元注解"><a href="#元注解" class="headerlink" title="元注解"></a>元注解</h2><p>Spring4.0的许多注解都可以用作meta annotation（元注解）。元注解是一种使用在别的注解上的注解。这意味着我们可以使用Spring的注解组合成一个我们自己的注解。</p>
<p>类似于：<code>@Documented</code>, <code>@Component</code>, <code>@RequestMapping</code>, <code>@Controller</code>, <code>@ResponseBody</code>等等</p>
<p>对于元注解，是Spring框架中定义的部分，都有特定的含义。我们并不能修改，但是对于组合注解，我们完全可以基于自己的定义进行实现。</p>
<h2 id="组合注解"><a href="#组合注解" class="headerlink" title="组合注解"></a>组合注解</h2><p>自定义注解或组合注解是从其他的Spring元注解创建的，我们先看一下<code>@SpringBootApplication</code>这个神奇的注解（去除注释）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">@SpringBootConfiguration</span><br><span class="line">@EnableAutoConfiguration</span><br><span class="line">@ComponentScan(excludeFilters = &#123;</span><br><span class="line">		@Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span><br><span class="line">		@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span><br><span class="line">public @interface SpringBootApplication &#123;</span><br><span class="line"></span><br><span class="line">	@AliasFor(annotation = EnableAutoConfiguration.class)</span><br><span class="line">	Class&lt;?&gt;[] exclude() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	@AliasFor(annotation = EnableAutoConfiguration.class)</span><br><span class="line">	String[] excludeName() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	@AliasFor(annotation = ComponentScan.class, attribute = &quot;basePackages&quot;)</span><br><span class="line">	String[] scanBasePackages() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	@AliasFor(annotation = ComponentScan.class, attribute = &quot;basePackageClasses&quot;)</span><br><span class="line">	Class&lt;?&gt;[] scanBasePackageClasses() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现这个注解中有含有大量其他注解，并使用了<code>@AliasFor</code>这个注解传递注解属性值。</p>
<h2 id="自定义组合注解"><a href="#自定义组合注解" class="headerlink" title="自定义组合注解"></a>自定义组合注解</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span><br><span class="line">public @interface Rest &#123;</span><br><span class="line">	@AliasFor(annotation = RequestMapping.class, attribute = &quot;value&quot;)</span><br><span class="line">	String[] value() default &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Rest(&quot;/ex&quot;)</span><br><span class="line">public class ExampleController &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring AOP"></a>Spring AOP</h1><blockquote>
<p>AOP为<strong>Aspect Oriented Programming</strong>的缩写，意为：面向切面编程，通过预编译方式和运行期动态代理实现程序功能的统一维护的一种技术。AOP是Spring框架中的一个重要内容，它通过对既有程序定义一个切入点，然后在其前后切入不同的执行内容，比如常见的有：打开数据库连接/关闭数据库连接、打开事务/关闭事务、记录日志等。基于AOP不会破坏原来程序逻辑，因此它可以很好的对业务逻辑的各个部分进行<strong>隔离</strong>，从而使得业务逻辑各部分之间的<strong>耦合度降低</strong>，提高程序的可重用性，同时提高了开发的效率。</p>
</blockquote>
<h2 id="注解说明"><a href="#注解说明" class="headerlink" title="注解说明"></a>注解说明</h2><p>实现AOP的切面主要有以下几个要素：</p>
<ul>
<li>使用<code>@Aspect</code>注解将一个java类定义为切面类</li>
<li>使用<code>@Pointcut</code>定义一个切入点，可以是一个规则表达式，比如下例中某个package下的所有函数，也可以是一个注解等。</li>
<li>根据需要在切入点不同位置的切入内容<ul>
<li>使用<code>@Before</code>在切入点开始处切入内容</li>
<li>使用<code>@After</code>在切入点结尾处切入内容</li>
<li>使用<code>@AfterReturning</code>在切入点return内容之后切入内容（可以用来对处理返回值做一些加工处理）</li>
<li>使用<code>@Around</code>在切入点前后切入内容，并自己控制何时执行切入点自身的内容</li>
<li>使用<code>@AfterThrowing</code>用来处理当切入内容部分抛出异常之后的处理逻辑</li>
</ul>
</li>
</ul>
<h2 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h2><p>与其他模块一样，使用需要引入pom依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p><strong>引入依赖程序将自动启用AOP</strong>，只要引入了AOP依赖后，默认已经增加了<code>@EnableAspectJAutoProxy</code>，并且默认启用<strong>Cglib</strong>代理：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/spring-boot-cglib-default.png" alt=""></p>
<h2 id="AOP顺序"><a href="#AOP顺序" class="headerlink" title="AOP顺序"></a>AOP顺序</h2><p>由于通过AOP实现，程序得到了很好的解耦，但是也会带来一些问题，比如：我们可能会对Web层做多个切面，校验用户，校验头信息等等，这个时候经常会碰到切面的处理<strong>顺序问题</strong>。</p>
<p>所以，我们需要定义每个切面的优先级，我们需要<code>@Order(i)</code>注解来标识切面的优先级。<strong>i的值越小，优先级越高</strong>。</p>
<h2 id="AOP记录Web访问日志用例"><a href="#AOP记录Web访问日志用例" class="headerlink" title="AOP记录Web访问日志用例"></a>AOP记录Web访问日志用例</h2><h3 id="日志注解"><a href="#日志注解" class="headerlink" title="日志注解"></a>日志注解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.METHOD)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">public @interface ReqLog &#123;</span><br><span class="line">	String value() default &quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>别忘了加上<code>@Retention(RetentionPolicy.RUNTIME)</code></p>
<h3 id="声明Pointcut"><a href="#声明Pointcut" class="headerlink" title="声明Pointcut"></a>声明Pointcut</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Pointcut(&quot;execution(public * com.yangbingdong.docker.controller..*.*(..))&quot;)</span><br><span class="line">public void path() &#123;&#125;</span><br><span class="line"></span><br><span class="line">@Pointcut(&quot;@annotation(ReqLog)&quot;)</span><br><span class="line">public void annotation() &#123;&#125;</span><br><span class="line"></span><br><span class="line">@Pointcut(&quot;path() &amp;&amp; annotation()&quot;)</span><br><span class="line">public void logHttp() &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>然后这样使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Before(&quot;path() &amp;&amp; @annotation(reqLog)&quot;)</span><br><span class="line">public void before(JoinPoint joinPoint) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果要很方便地获取<code>@ReqLog</code>的<code>value</code>，我们可以将其<strong>绑定</strong>为参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Pointcut(&quot;execution(public * com.yangbingdong.docker.controller..*.*(..))&quot;)</span><br><span class="line">public void path()&#123;&#125;</span><br><span class="line"></span><br><span class="line">@Before(&quot;path() &amp;&amp; @annotation(reqLog)&quot;)</span><br><span class="line">public void doBefore(JoinPoint joinPoint, ReqLog reqLog) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Pointcut匹配表达式详解可以参考：<strong><em><a href="https://blog.csdn.net/elim168/article/details/78150438" rel="external nofollow noopener noreferrer" target="_blank">https://blog.csdn.net/elim168/article/details/78150438</a></em></strong></p>
<p>如果是使用<code>@Around</code>，则方法参数应该使用<code>ProceedingJoinPoint，</code>因为<code>ProceedingJoinPoint.proceed()</code>可获取方法返回值，且必须返回<code>Object</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Around(&quot;logHttp()&quot;)</span><br><span class="line">public Object around(final ProceedingJoinPoint joinPoint) throws Throwable &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="函数式方式动态注册-Bean"><a href="#函数式方式动态注册-Bean" class="headerlink" title="函数式方式动态注册 Bean"></a>函数式方式动态注册 Bean</h1><blockquote>
<p>Spring 5 支持在应用程序上下文中以函数式方式注册 bean。简单地说，您可以通过在 <strong><code>GenericApplicationContext</code></strong> 类中定义的一个新 <strong><code>registerBean()</code></strong> 方法重载来完成。</p>
</blockquote>
<p>看一下有哪些方法重载：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/spring-reg-bean.png" alt=""></p>
<p>注入<code>GenericWebApplicationContext</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">private GenericWebApplicationContext context;</span><br></pre></td></tr></table></figure>
<p>注册并设置bean：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String beanName = lowercaseInitial(handler.getClass().getSimpleName()) + &quot;-&quot; + j;</span><br><span class="line">context.registerBean(beanName, handler.getClass());</span><br><span class="line">AbstractShardingHandler&lt;AopLogEvent&gt; shardingBean = (AbstractShardingHandler&lt;AopLogEvent&gt;) context.getBean(beanName);</span><br></pre></td></tr></table></figure>
<h1 id="自动配置的原理与自定义starter"><a href="#自动配置的原理与自定义starter" class="headerlink" title="自动配置的原理与自定义starter"></a>自动配置的原理与自定义starter</h1><p>在自定义starter之前，先看一下Spring Boot的一些原理</p>
<h2 id="Spring-Boot实现自动配置的原理"><a href="#Spring-Boot实现自动配置的原理" class="headerlink" title="Spring Boot实现自动配置的原理"></a>Spring Boot实现自动配置的原理</h2><h3 id="入口注解类-EnableAutoConfiguration"><a href="#入口注解类-EnableAutoConfiguration" class="headerlink" title="入口注解类@EnableAutoConfiguration"></a>入口注解类@EnableAutoConfiguration</h3><p><code>@SpringBootApplication</code>注解中包含了自动配置的入口注解：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">@SpringBootConfiguration</span><br><span class="line">@EnableAutoConfiguration</span><br><span class="line">@ComponentScan(excludeFilters = &#123;</span><br><span class="line">        @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span><br><span class="line">        @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span><br><span class="line">public @interface SpringBootApplication &#123;</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;deprecation&quot;)</span><br><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">@AutoConfigurationPackage</span><br><span class="line">@Import(EnableAutoConfigurationImportSelector.class)</span><br><span class="line">public @interface EnableAutoConfiguration &#123;</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个注解的Javadoc内容还是不少，所有就不贴在文章里面了，概括一下：</p>
<ol>
<li>自动配置基于应用的类路径以及你定义了什么Beans</li>
<li>如果使用了<code>@SpringBootApplication</code>注解，那么自动就启用了自动配置</li>
<li>可以通过设置注解的<code>excludeName</code>属性或者通过<code>spring.autoconfigure.exclude</code>配置项来指定不需要自动配置的项目</li>
<li>自动配置的发生时机在用户定义的Beans被注册之后</li>
<li>如果没有和<code>@SpringBootApplication</code>一同使用，最好将<code>@EnableAutoConfiguration</code>注解放在root package的类上，这样就能够搜索到所有子packages中的类了</li>
<li>自动配置类就是普通的Spring <code>@Configuration</code>类，通过<code>SpringFactoriesLoader</code>机制完成加载，实现上通常使用<code>@Conditional</code>(比如<code>@ConditionalOnClass</code>或者<code>@ConditionalOnMissingBean</code>)</li>
</ol>
<h3 id="AutoConfigurationPackage"><a href="#AutoConfigurationPackage" class="headerlink" title="@AutoConfigurationPackage"></a>@AutoConfigurationPackage</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">@Import(AutoConfigurationPackages.Registrar.class)</span><br><span class="line">public @interface AutoConfigurationPackage &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个注解的职责就是<strong>引入</strong>了另外一个配置类：<code>AutoConfigurationPackages.Registrar</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * ImportBeanDefinitionRegistrar用来从导入的Config中保存base package</span><br><span class="line"> */</span><br><span class="line">@Order(Ordered.HIGHEST_PRECEDENCE)</span><br><span class="line">static class Registrar implements ImportBeanDefinitionRegistrar, DeterminableImports &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void registerBeanDefinitions(AnnotationMetadata metadata,</span><br><span class="line">            BeanDefinitionRegistry registry) &#123;</span><br><span class="line">        register(registry, new PackageImport(metadata).getPackageName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Set&lt;Object&gt; determineImports(AnnotationMetadata metadata) &#123;</span><br><span class="line">        return Collections.&lt;Object&gt;singleton(new PackageImport(metadata));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个注解实现的功能已经比较底层了，调试看看上面的register方法什么会被调用：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/spring-boot-code.png" alt=""></p>
<p>调用参数中的<code>packageNames</code>数组中仅包含一个值：<code>com.example.demo</code>，也就是项目的root package名。</p>
<p>从调用栈来看的话，调用<code>register</code>方法的时间在容器刷新期间：</p>
<p><code>refresh</code> -&gt; <code>invokeBeanFactoryPostProcessors</code> -&gt; <code>invokeBeanDefinitionRegistryPostProcessors</code> -&gt; <code>postProcessBeanDefinitionRegistry</code> -&gt; <code>processConfigBeanDefinitions</code>(开始处理配置Bean的定义) -&gt; <code>loadBeanDefinitions</code> -&gt; <code>loadBeanDefinitionsForConfigurationClass</code>(读取配置Class中的Bean定义) -&gt; <code>loadBeanDefinitionsFromRegistrars</code>(这里开始准备进入上面的register方法) -&gt; <code>registerBeanDefinitions</code>(即上述方法)</p>
<p>这个过程已经比较复杂了，目前暂且不深入研究了。它的功能简单说就是将应用的root package给注册到Spring容器中，供后续使用。</p>
<p>相比而言，下面要讨论的几个类型才是实现自动配置的关键。</p>
<h3 id="Import-EnableAutoConfigurationImportSelector-class"><a href="#Import-EnableAutoConfigurationImportSelector-class" class="headerlink" title="@Import(EnableAutoConfigurationImportSelector.class)"></a>@Import(EnableAutoConfigurationImportSelector.class)</h3><p><code>@EnableAutoConfiguration</code>注解的另外一个作用就是引入了<code>EnableAutoConfigurationImportSelector</code>：</p>
<p>它的类图如下所示：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/spring-boot-learning/spring-boot-code02.png" alt=""></p>
<p>可以发现它除了实现几个Aware类接口外，最关键的就是实现了<code>DeferredImportSelector</code>(继承自<code>ImportSelector</code>)接口。</p>
<p>所以我们先来看看<code>ImportSelector</code>以及<code>DeferredImportSelector</code>接口的定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public interface ImportSelector &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 基于被引入的Configuration类的AnnotationMetadata信息选择并返回需要引入的类名列表</span><br><span class="line">     */</span><br><span class="line">    String[] selectImports(AnnotationMetadata importingClassMetadata);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个接口的Javadoc比较长，还是捡重点说明一下：</p>
<ol>
<li>主要功能通过<code>selectImports</code>方法实现，用于筛选需要引入的类名</li>
<li>实现了<code>ImportSelector</code>的类也可以实现一系列Aware接口，这些Aware接口中的相应方法会在<code>selectImports</code>方法之前被调用(这一点通过上面的类图也可以佐证，<code>EnableAutoConfigurationImportSelector</code>确实实现了四个Aware类型的接口)</li>
<li><code>ImportSelector</code>的实现和通常的<code>@Import</code>在处理方式上是一致的，然而还是可以在所有<code>@Configuration</code>类都被处理后再进行引入筛选(具体看下面即将介绍的<code>DeferredImportSelector</code>)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface DeferredImportSelector extends ImportSelector &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个接口是一个<strong>标记接口</strong>，它本身没有定义任何方法。那么这个接口的含义是什么呢：</p>
<ol>
<li>它是<code>ImportSelector</code>接口的一个变体，在所有的<code>@Configuration</code>被处理之后才会执行。在需要筛选的引入类型具备<code>@Conditional</code>注解的时候非常有用</li>
<li>实现类同样也可以实现<code>Ordered</code>接口，来定义多个<code>DeferredImportSelector</code>的优先级别(同样地，<code>EnableAutoConfigurationImportSelector</code>也实现了<code>Ordered</code>接口)</li>
</ol>
<p>明确了这两个接口的意义，下面来看看是如何实现的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">    if (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">        return NO_IMPORTS;</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">      // Step1: 得到注解信息</span><br><span class="line">        AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader</span><br><span class="line">                .loadMetadata(this.beanClassLoader);</span><br><span class="line">        // Step2: 得到注解中的所有属性信息</span><br><span class="line">        AnnotationAttributes attributes = getAttributes(annotationMetadata);</span><br><span class="line">        // Step3: 得到候选配置列表</span><br><span class="line">        List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata,</span><br><span class="line">                attributes);</span><br><span class="line">        // Step4: 去重</span><br><span class="line">        configurations = removeDuplicates(configurations);</span><br><span class="line">        // Step5: 排序</span><br><span class="line">        configurations = sort(configurations, autoConfigurationMetadata);</span><br><span class="line">        // Step6: 根据注解中的exclude信息去除不需要的</span><br><span class="line">        Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);</span><br><span class="line">        checkExcludedClasses(configurations, exclusions);</span><br><span class="line">        configurations.removeAll(exclusions);</span><br><span class="line">        configurations = filter(configurations, autoConfigurationMetadata);</span><br><span class="line">        // Step7: 派发事件</span><br><span class="line">        fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">        return configurations.toArray(new String[configurations.size()]);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (IOException ex) &#123;</span><br><span class="line">        throw new IllegalStateException(ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显，核心就在于上面的<strong>步骤3</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">protected List&lt;String&gt; getCandidateConfigurations(AnnotationMetadata metadata,</span><br><span class="line">        AnnotationAttributes attributes) &#123;</span><br><span class="line">    List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(</span><br><span class="line">            getSpringFactoriesLoaderFactoryClass(), getBeanClassLoader());</span><br><span class="line">    Assert.notEmpty(configurations,</span><br><span class="line">            &quot;No auto configuration classes found in META-INF/spring.factories. If you &quot;</span><br><span class="line">                    + &quot;are using a custom packaging, make sure that file is correct.&quot;);</span><br><span class="line">    return configurations;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它将实现委托给了<code>SpringFactoriesLoader</code>的<code>loadFactoryNames</code>方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 传入的factoryClass：org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><br><span class="line">public static List&lt;String&gt; loadFactoryNames(Class&lt;?&gt; factoryClass, ClassLoader classLoader) &#123;</span><br><span class="line">    String factoryClassName = factoryClass.getName();</span><br><span class="line">    try &#123;</span><br><span class="line">        Enumeration&lt;URL&gt; urls = (classLoader != null ? classLoader.getResources(FACTORIES_RESOURCE_LOCATION) :</span><br><span class="line">                ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));</span><br><span class="line">        List&lt;String&gt; result = new ArrayList&lt;String&gt;();</span><br><span class="line">        while (urls.hasMoreElements()) &#123;</span><br><span class="line">            URL url = urls.nextElement();</span><br><span class="line">            Properties properties = PropertiesLoaderUtils.loadProperties(new UrlResource(url));</span><br><span class="line">            String factoryClassNames = properties.getProperty(factoryClassName);</span><br><span class="line">            result.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(factoryClassNames)));</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (IOException ex) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;Unable to load [&quot; + factoryClass.getName() +</span><br><span class="line">                &quot;] factories from location [&quot; + FACTORIES_RESOURCE_LOCATION + &quot;]&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 相关常量</span><br><span class="line">public static final String FACTORIES_RESOURCE_LOCATION = &quot;META-INF/spring.factories&quot;;</span><br></pre></td></tr></table></figure>
<p>这段代码的意图很明确，在第一篇文章讨论Spring Boot启动过程的时候就已经接触到了。它会从类路径中拿到所有名为<strong><code>META-INF/spring.factories</code></strong>的配置文件，然后按照<code>factoryClass</code>的名称取到对应的值。那么我们就来找一个<strong><code>META-INF/spring.factories</code></strong>配置文件看看。</p>
<h4 id="META-INF-spring-factories"><a href="#META-INF-spring-factories" class="headerlink" title="META-INF/spring.factories"></a>META-INF/spring.factories</h4><p>比如<code>spring-boot-autoconfigure</code>包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cloud.CloudAutoConfiguration,\</span><br><span class="line"># ...</span><br></pre></td></tr></table></figure>
<p>列举了非常多的自动配置候选项，挑一个AOP相关的<code>AopAutoConfiguration</code>看看究竟：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 如果设置了spring.aop.auto=false，那么AOP不会被配置</span><br><span class="line">// 需要检测到@EnableAspectJAutoProxy注解存在才会生效</span><br><span class="line">// 默认使用JdkDynamicAutoProxyConfiguration，如果设置了spring.aop.proxy-target-class=true，那么使用CglibAutoProxyConfiguration</span><br><span class="line">@Configuration</span><br><span class="line">@ConditionalOnClass(&#123; EnableAspectJAutoProxy.class, Aspect.class, Advice.class &#125;)</span><br><span class="line">@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;auto&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span><br><span class="line">public class AopAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    @EnableAspectJAutoProxy(proxyTargetClass = false)</span><br><span class="line">    @ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;false&quot;, matchIfMissing = true)</span><br><span class="line">    public static class JdkDynamicAutoProxyConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    @EnableAspectJAutoProxy(proxyTargetClass = true)</span><br><span class="line">    @ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;true&quot;, matchIfMissing = false)</span><br><span class="line">    public static class CglibAutoProxyConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个自动配置类的作用是判断是否存在配置项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.aop.proxy-target-class=true</span><br></pre></td></tr></table></figure>
<p>如果存在并且值为<code>true</code>的话使用基于<strong>CGLIB</strong>字节码操作的动态代理方案，否则使用JDK自带的动态代理机制。</p>
<p>下面列举所有由Spring Boot提供的条件注解：</p>
<ul>
<li><code>@ConditionalOnBean</code></li>
<li><code>@ConditionalOnClass</code></li>
<li><code>@ConditionalOnCloudPlatform</code></li>
<li><code>@ConditionalOnExpression</code></li>
<li><code>@ConditionalOnJava</code></li>
<li><code>@ConditionalOnJndi</code></li>
<li><code>@ConditionalOnMissingBean</code></li>
<li><code>@ConditionalOnMissingClass</code></li>
<li><code>@ConditionalOnNotWebApplication</code></li>
<li><code>@ConditionalOnProperty</code></li>
<li><code>@ConditionalOnResource</code></li>
<li><code>@ConditionalOnSingleCandidate</code></li>
<li><code>@ConditionalOnWebApplication</code></li>
</ul>
<p>一般的模式，就是一个条件注解对应一个继承自<code>SpringBootCondition</code>的具体实现类。</p>
<h2 id="自定义starter"><a href="#自定义starter" class="headerlink" title="自定义starter"></a>自定义starter</h2><p>看完上面描述之后，应该不难发现，自定义starter的关键就是<strong><code>META-INF/spring.factories</code></strong>了，Spring Boot会在启动时加载这个文件中声明的第三方类。</p>
<h3 id="自定义properties"><a href="#自定义properties" class="headerlink" title="自定义properties"></a>自定义properties</h3><p>为了给可配置的bean属性生成元数据，我们需要引入如下jar包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 将被@ConfigurationProperties注解的类的属性注入到元数据 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;</span><br><span class="line">    &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p><code>application.properties</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ybd.datasource.driver-class-name=com.mysql.jdbc.Driver</span><br><span class="line">ybd.datasource.url=jdbc:mysql://192.168.0.200:3306/transaction_message_test?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false</span><br><span class="line">ybd.datasource.username=ibalife</span><br><span class="line">ybd.datasource.password=ibalife</span><br><span class="line">ybd.datasource.dbcp2.validation-query=select &apos;x&apos;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>生成的元数据位于jar文件中的<code>META-INF/spring-configurationmetadata. json</code>。元数据本身并不会修改被<code>@ConfigurationProperties</code>修饰的类属性，在我的理解里元数据仅仅只是表示配置类的默认值以及java doc，供调用者便利的了解默认配置有哪些以及默认配置的含义，在idea里面如果有元数据则可以提供良好的代码提示功能以方便了解默认的配置。</p>
</blockquote>
<h3 id="properties接收类"><a href="#properties接收类" class="headerlink" title="properties接收类"></a>properties接收类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">@ConfigurationProperties(DataSourceProperties.DATASOURCE_PREFIX)</span><br><span class="line">public class DataSourceProperties &#123;</span><br><span class="line">	public static final String DATASOURCE_PREFIX = &quot;ybd.datasource&quot;;</span><br><span class="line">	private Boolean tcc;</span><br><span class="line">	private String driverClassName = &quot;com.mysql.jdbc.Driver&quot;;</span><br><span class="line">	private String url;</span><br><span class="line">	private String username = &quot;root&quot;;</span><br><span class="line">	private String password = &quot;root&quot;;</span><br><span class="line">	private Dbcp2 dbcp2;</span><br><span class="line"></span><br><span class="line">	@Data</span><br><span class="line">	public static class Dbcp2 &#123;</span><br><span class="line">		private Integer maxTotal = 50;</span><br><span class="line">		private Integer initialSize = 20;</span><br><span class="line">		private Long maxWaitMillis = 60000L;</span><br><span class="line">		private Integer minIdle = 6;</span><br><span class="line">		private Boolean logAbandoned = true;</span><br><span class="line">		private Boolean removeAbandonedOnBorrow = true;</span><br><span class="line">		private Boolean removeAbandonedOnMaintenance = true;</span><br><span class="line">		private Integer removeAbandonedTimeout = 1800;</span><br><span class="line">		private Boolean testWhileIdle = true;</span><br><span class="line">		private Boolean testOnBorrow = false;</span><br><span class="line">		private Boolean testOnReturn = false;</span><br><span class="line">		private String validationQuery;</span><br><span class="line">		private Integer validationQueryTimeout = 1;</span><br><span class="line">		private Long timeBetweenEvictionRunsMillis = 30000L;</span><br><span class="line">		private Integer numTestsPerEvictionRun = 20;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@ConfigurationProperties</code>会将<code>application.properties</code>中指定的前缀的属性注入到bean中</p>
<h3 id="Config类"><a href="#Config类" class="headerlink" title="Config类"></a>Config类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@Import(SpringCloudConfiguration.class)</span><br><span class="line">@ConditionalOnClass(&#123;LocalXADataSource.class&#125;)</span><br><span class="line">@EnableConfigurationProperties(&#123;DataSourceProperties.class&#125;)</span><br><span class="line">public class DataSourceConfiguration &#123;</span><br><span class="line">	private final DataSourceProperties dataSourceProperties;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	public DataSourceConfiguration(DataSourceProperties dataSourceProperties) &#123;</span><br><span class="line">		this.dataSourceProperties = dataSourceProperties;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	@Bean(&quot;dataSource&quot;)</span><br><span class="line">	@ConditionalOnProperty(prefix = DATASOURCE_PREFIX, value = &quot;tcc&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span><br><span class="line">	public DataSource getTccDataSource() &#123;</span><br><span class="line">		LocalXADataSource dataSource = new LocalXADataSource();</span><br><span class="line">		dataSource.setDataSource(this.resolveDbcp2DataSource());</span><br><span class="line">		return dataSource;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private DataSource resolveDbcp2DataSource() &#123;</span><br><span class="line">		BasicDataSource dataSource = new BasicDataSource();</span><br><span class="line">		dataSource.setDriverClassName(dataSourceProperties.getDriverClassName());</span><br><span class="line">		dataSource.setUrl(dataSourceProperties.getUrl());</span><br><span class="line">		dataSource.setUsername(dataSourceProperties.getUsername());</span><br><span class="line">		dataSource.setPassword(dataSourceProperties.getPassword());</span><br><span class="line">		dataSource.setMaxTotal(dataSourceProperties.getDbcp2().getMaxTotal());</span><br><span class="line">		dataSource.setInitialSize(dataSourceProperties.getDbcp2().getInitialSize());</span><br><span class="line">		dataSource.setMaxWaitMillis(dataSourceProperties.getDbcp2().getMaxWaitMillis());</span><br><span class="line">		dataSource.setMinIdle(dataSourceProperties.getDbcp2().getMinIdle());</span><br><span class="line">		dataSource.setLogAbandoned(dataSourceProperties.getDbcp2().getLogAbandoned());</span><br><span class="line">		dataSource.setRemoveAbandonedOnBorrow(dataSourceProperties.getDbcp2().getRemoveAbandonedOnBorrow());</span><br><span class="line">		dataSource.setRemoveAbandonedOnMaintenance(dataSourceProperties.getDbcp2().getRemoveAbandonedOnMaintenance());</span><br><span class="line">		dataSource.setRemoveAbandonedTimeout(dataSourceProperties.getDbcp2().getRemoveAbandonedTimeout());</span><br><span class="line">		dataSource.setTestWhileIdle(dataSourceProperties.getDbcp2().getTestWhileIdle());</span><br><span class="line">		dataSource.setTestOnBorrow(dataSourceProperties.getDbcp2().getTestOnBorrow());</span><br><span class="line">		dataSource.setTestOnReturn(dataSourceProperties.getDbcp2().getTestOnReturn());</span><br><span class="line">		dataSource.setValidationQuery(dataSourceProperties.getDbcp2().getValidationQuery());</span><br><span class="line">		dataSource.setValidationQueryTimeout(dataSourceProperties.getDbcp2().getValidationQueryTimeout());</span><br><span class="line">		dataSource.setTimeBetweenEvictionRunsMillis(dataSourceProperties.getDbcp2().getTimeBetweenEvictionRunsMillis());</span><br><span class="line">		dataSource.setNumTestsPerEvictionRun(dataSourceProperties.getDbcp2().getNumTestsPerEvictionRun());</span><br><span class="line">		return dataSource;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>@Import</code>引入其他配置类</li>
<li><code>@ConditionalOnClass</code>在指定类存在时该配置类生效</li>
<li><code>@EnableConfigurationProperties</code>启用配置接受类，通过Spring字段注入或构造器注入properties配置Bean</li>
</ul>
<h3 id="使Spring-Boot可以自动加载配置类"><a href="#使Spring-Boot可以自动加载配置类" class="headerlink" title="使Spring Boot可以自动加载配置类"></a>使Spring Boot可以自动加载配置类</h3><p>在<code>/resource</code>目录创建<strong><code>META-INF/spring.factories</code></strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">com.yangbingdong.configuration.WebMvcMessageConvertConfiguration</span><br></pre></td></tr></table></figure>
<p>然后打包成Jar，第三方Spring Boot系统通过引入这个Jar包，会自动加载该类。</p>
<p>如果有需要，可以配合<code>@AutoConfigureAfter</code>，<code>@ConditionalOnBean</code>，<code>@ConditionalOnProperty</code>等注解控制配置是否需要加载以及加载顺序。</p>
<p>需要更灵活的配置可以实现<code>Condition</code>或<code>SpringBootCondition</code>通过<code>@Conditional(XXXCondition.class)</code>实现类加载判断。</p>
<h1 id="自定义Banner"><a href="#自定义Banner" class="headerlink" title="自定义Banner"></a>自定义Banner</h1><p>新建一个<code>banner.txt</code>到<code>resources</code>目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$&#123;AnsiColor.BRIGHT_GREEN&#125;</span><br><span class="line">                   $&#123;AnsiColor.BRIGHT_YELLOW&#125;_ooOoo_$&#123;AnsiColor.BRIGHT_YELLOW&#125;</span><br><span class="line">                  $&#123;AnsiColor.BRIGHT_YELLOW&#125;o8888888o$&#123;AnsiColor.BRIGHT_YELLOW&#125;</span><br><span class="line">                  $&#123;AnsiColor.BRIGHT_YELLOW&#125;88$&#123;AnsiColor.BRIGHT_GREEN&#125;&quot; $&#123;AnsiStyle.BOLD&#125;$&#123;AnsiColor.BRIGHT_RED&#125;. $&#123;AnsiColor.BRIGHT_GREEN&#125;&quot;$&#123;AnsiColor.BRIGHT_YELLOW&#125;88$&#123;AnsiColor.BRIGHT_GREEN&#125;</span><br><span class="line">                  (| -_- |)</span><br><span class="line">                  $&#123;AnsiColor.BRIGHT_YELLOW&#125;O$&#123;AnsiColor.BRIGHT_GREEN&#125;\  =  /$&#123;AnsiColor.BRIGHT_YELLOW&#125;O$&#123;AnsiColor.BRIGHT_GREEN&#125;</span><br><span class="line">               ____/`---&apos;\____</span><br><span class="line">             .&apos;  \\|     |//  `.</span><br><span class="line">            /  \\|||  :  |||//  \</span><br><span class="line">           /  _||||| -:- |||||-  \</span><br><span class="line">           |   | \\\  -  /// |   |</span><br><span class="line">           | \_|  &apos;&apos;\---/&apos;&apos;  |   |</span><br><span class="line">           \  .-\__  `-`  ___/-. /</span><br><span class="line">         ___`. .&apos;  /--.--\  `. . __</span><br><span class="line">      .&quot;&quot; &apos;&lt;  `.___\_&lt;|&gt;_/___.&apos;  &gt;&apos;&quot;&quot;.</span><br><span class="line">     | | :  `- \`.;`\ _ /`;.`/ - ` : | |</span><br><span class="line">     \  \ `-.   \_ __\ /__ _/   .-` /  /</span><br><span class="line">======`-.____`-.___\_____/___.-`____.-&apos;======</span><br><span class="line">                   `=---=&apos;</span><br><span class="line">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^         $&#123;spring-boot.formatted-version&#125;</span><br><span class="line">         $&#123;AnsiStyle.BOLD&#125;$&#123;AnsiColor.BRIGHT_GREEN&#125;佛祖保佑       永无BUG</span><br><span class="line"></span><br><span class="line">$&#123;AnsiStyle.NORMAL&#125;</span><br></pre></td></tr></table></figure>
<h1 id="优雅停机"><a href="#优雅停机" class="headerlink" title="优雅停机"></a>优雅停机</h1><p>可参考：<strong><em><a href="http://www.spring4all.com/article/1022" rel="external nofollow noopener noreferrer" target="_blank">http://www.spring4all.com/article/1022</a></em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package com.yangbingdong.docker.config.shutdown;</span><br><span class="line"></span><br><span class="line">import io.undertow.server.HandlerWrapper;</span><br><span class="line">import io.undertow.server.HttpHandler;</span><br><span class="line">import io.undertow.server.handlers.GracefulShutdownHandler;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author ybd</span><br><span class="line"> * @date 18-4-19</span><br><span class="line"> * @contact yangbingdong1994@gmail.com</span><br><span class="line"> */</span><br><span class="line">public class GracefulShutdownWrapper implements HandlerWrapper &#123;</span><br><span class="line">	private GracefulShutdownHandler gracefulShutdownHandler;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public HttpHandler wrap(HttpHandler handler) &#123;</span><br><span class="line">		if(gracefulShutdownHandler == null) &#123;</span><br><span class="line">			this.gracefulShutdownHandler = new GracefulShutdownHandler(handler);</span><br><span class="line">		&#125;</span><br><span class="line">		return gracefulShutdownHandler;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public GracefulShutdownHandler getGracefulShutdownHandler() &#123;</span><br><span class="line">		return gracefulShutdownHandler;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">package com.yangbingdong.docker.config.shutdown;</span><br><span class="line"></span><br><span class="line">import io.undertow.server.handlers.GracefulShutdownHandler;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.context.ApplicationListener;</span><br><span class="line">import org.springframework.context.event.ContextClosedEvent;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author ybd</span><br><span class="line"> * @date 18-4-19</span><br><span class="line"> * @contact yangbingdong1994@gmail.com</span><br><span class="line"> */</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">@Slf4j</span><br><span class="line">public class GracefulShutdownListener implements ApplicationListener&lt;ContextClosedEvent&gt; &#123;</span><br><span class="line"></span><br><span class="line">	private final GracefulShutdownWrapper gracefulShutdownWrapper;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void onApplicationEvent(ContextClosedEvent event) &#123;</span><br><span class="line">		GracefulShutdownHandler gracefulShutdownHandler = gracefulShutdownWrapper.getGracefulShutdownHandler();</span><br><span class="line">		try &#123;</span><br><span class="line">			gracefulShutdownHandler.shutdown();</span><br><span class="line">			gracefulShutdownHandler.awaitShutdown(5000L);</span><br><span class="line">		&#125; catch (InterruptedException e) &#123;</span><br><span class="line">			log.error(&quot;Graceful shutdown container error:&quot;, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package com.yangbingdong.springboot.common.config.shutdown;</span><br><span class="line"></span><br><span class="line">import io.undertow.server.HandlerWrapper;</span><br><span class="line">import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line">import org.springframework.boot.web.embedded.undertow.UndertowServletWebServerFactory;</span><br><span class="line">import org.springframework.boot.web.server.WebServerFactoryCustomizer;</span><br><span class="line">import org.springframework.boot.web.servlet.server.ConfigurableServletWebServerFactory;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author ybd</span><br><span class="line"> * @date 18-4-19</span><br><span class="line"> * @contact yangbingdong1994@gmail.com</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">@ConditionalOnClass(HandlerWrapper.class)</span><br><span class="line">public class GracefulShutdownConfiguration &#123;</span><br><span class="line"></span><br><span class="line">	@Bean</span><br><span class="line">	public GracefulShutdownWrapper gracefulShutdownWrapper() &#123;</span><br><span class="line">		return new GracefulShutdownWrapper();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Bean</span><br><span class="line">	public WebServerFactoryCustomizer&lt;ConfigurableServletWebServerFactory&gt; gracefulWebServerFactoryCustomizer() &#123;</span><br><span class="line">		return factory -&gt; &#123;</span><br><span class="line">			if (factory instanceof UndertowServletWebServerFactory) &#123;</span><br><span class="line">				UndertowServletWebServerFactory undertowServletWebServerFactory = (UndertowServletWebServerFactory) factory;</span><br><span class="line">				undertowServletWebServerFactory</span><br><span class="line">						.addDeploymentInfoCustomizers(deploymentInfo -&gt;</span><br><span class="line">								deploymentInfo.addOuterHandlerChainWrapper(gracefulShutdownWrapper()));</span><br><span class="line">//				undertowServletWebServerFactory.addBuilderCustomizers(builder -&gt; builder.setServerOption(UndertowOptions.ENABLE_STATISTICS, true));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Bean</span><br><span class="line">	public GracefulShutdownListener gracefulShutdown() &#123;</span><br><span class="line">		return new GracefulShutdownListener(gracefulShutdownWrapper());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

<div style="text-align:center;color:#ccc;font-size:14px">---------------- The End ----------------</div>

    <div>
      
        
<div id="wechat_subscriber" style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center">
    <img id="wechat_subscriber_qcode" src="/images/wechat/gongzhonghao.jpg" alt="ookamiAntD wechat" style="width:200px;max-width:100%">
    <div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div>
</div>


      
    </div>

    <div>
      
        


  <div style="padding:10px 0;margin:20px auto;width:90%;text-align:center">
    <div>谢谢大爷～</div>
    <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'>
      <span>赏</span>
    </button>
    <div id="QR" style="display:none">
      
        <div id="wechat" style="display:inline-block">
          <img id="wechat_qr" src="/images/donate/wechat.png" alt="ookamiAntD WeChat Pay">
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display:inline-block">
          <img id="alipay_qr" src="/images/donate/alipay.jpg" alt="ookamiAntD Alipay">
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>
<div>
	  
	    <p id="div-border-left-red">
		Author：<b>ookamiAntD Yang</b><br>
		Link：<a href="/2018/spring-boot-learning-hodgepodge/" title="Spring Boot学习之杂记篇">http://yangbingdong.com/2018/spring-boot-learning-hodgepodge/</a><br>
		Contact：<a>yangbingdong1994@gmail.com</a><br>
	   <b>本文基于<a target="_blank" title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href="http://creativecommons.org/licenses/by-sa/4.0/" rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br>
	    <b>转载请注明出处，谢谢！</b>
	    </p>
	  
	</div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
            <a href="/tags/Spring-Boot/" rel="tag"># Spring Boot</a>
          
            <a href="/tags/Spring/" rel="tag"># Spring</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/mysql-related-learning/" rel="next" title="MySQL杂记">
                <i class="fa fa-chevron-left"></i> MySQL杂记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/spring-boot-mvc-validation/" rel="prev" title="Spring Boot学习之MVC与Validation">
                Spring Boot学习之MVC与Validation <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        
<div class="-hoofoo-share-title">分享到：</div>
<div class="-hoofoo-share-buttons">
    <div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden="true"></i></div>
    <div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden="true"></i></div>
    <div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden="true"></i></div>
    <div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden="true"></i></div>
    <div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden="true"></i></div>
</div>
<div class="-mob-share-ui" style="display:none">
    <ul class="-mob-share-list">
        <li class="-mob-share-weibo"><p>新浪微博</p></li>
        <li class="-mob-share-weixin"><p>微信</p></li>
        <li class="-mob-share-qzone"><p>QQ空间</p></li>
        <li class="-mob-share-qq"><p>QQ好友</p></li>
        <li class="-mob-share-tencentweibo"><p>腾讯微博</p></li>
        <li class="-mob-share-renren"><p>人人网</p></li>
        <li class="-mob-share-kaixin"><p>开心网</p></li>
        <li class="-mob-share-douban"><p>豆瓣</p></li>
        <li class="-mob-share-youdao"><p>有道云笔记</p></li>
        <li class="-mob-share-mingdao"><p>明道</p></li>
        <li class="-mob-share-pengyou"><p>朋友网</p></li>
        <li class="-mob-share-facebook"><p>Facebook</p></li>
        <li class="-mob-share-twitter"><p>Twitter</p></li>
        <li class="-mob-share-pocket"><p>Pocket</p></li>
        <li class="-mob-share-google"><p>Google+</p></li>
        <li class="-mob-share-tumblr"><p>Tumblr</p></li>
        <li class="-mob-share-instapaper"><p>Instapaper</p></li>
        <li class="-mob-share-linkedin"><p>Linkedin</p></li>
    </ul>
    <div class="-mob-share-close">取消</div>
</div>
<div class="-mob-share-ui-bg"></div>
<script id="-mob-share" src="http://f1.webshare.mob.com/code/mob-share.js?appkey=21aa3b13ad233"></script>


      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
<div style="text-align:center">
  

</div>
      <div id="disqus_proxy_thread"></div>
      <div id="disqus_thread"></div>
      
          <script type="text/javascript">window.disqusProxy={username:"ookamiantd",server:"disqus-proxy.yangbingdong.com",port:"5509",defaultAvatar:"/images/avatar/avatar-default.jpg",adminAvatar:"/images/avatar/avatar-admin.jpg",identifier:"2018/spring-boot-learning-hodgepodge/"},window.disqus_config=function(){this.page.url="http://yangbingdong.com/2018/spring-boot-learning-hodgepodge/",this.page.identifier="2018/spring-boot-learning-hodgepodge/"},window.onload=function(){var a=document.createElement("script");a.src="/static/js/main.0d0338ae.js",a.async=!0,document.body.appendChild(a)}</script>
          <link rel="stylesheet" href="/static/css/main.0603c539.css">
      

    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar/avatar-admin.jpg" alt="ookamiAntD">
          <p class="site-author-name" itemprop="name">ookamiAntD</p>
          <p class="site-description motion-element" itemprop="description">码渣 | rocker | 二次元 | 美剧 | 宅</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/masteranthoneyd" target="_blank" rel="external nofollow noopener noreferrer" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/profile.php?id=100014869064462" target="_blank" rel="external nofollow noopener noreferrer" title="Facebook">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                  Facebook
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/ookamiAntD" target="_blank" rel="external nofollow noopener noreferrer" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="cc-opacity" target="_blank" rel="external nofollow noopener noreferrer">
              <img src="/images/cc-by-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa fa-fw fa-globe"></i>
              大神们的博客
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://ycwalker.com/" title="ciqulover" target="_blank" rel="external nofollow noopener noreferrer">ciqulover</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://codepub.cn" title="IT草根" target="_blank" rel="external nofollow noopener noreferrer">IT草根</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://crossoverjie.top/" title="crossoverJie's Blog" target="_blank" rel="external nofollow noopener noreferrer">crossoverJie's Blog</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://yemengying.com/" title="Giraffe's Home" target="_blank" rel="external nofollow noopener noreferrer">Giraffe's Home</a>
                </li>
              
            </ul>
          </div>
        

        <div id="days"></div>
    <script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("01/10/2017 12:34:56"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script>


      </section>

      
      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Preface"><span class="nav-number">1.</span> <span class="nav-text">Preface</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#构建依赖版本管理工程"><span class="nav-number">2.</span> <span class="nav-text">构建依赖版本管理工程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#依赖版本管理工程"><span class="nav-number">2.1.</span> <span class="nav-text">依赖版本管理工程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#父工程"><span class="nav-number">2.2.</span> <span class="nav-text">父工程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#打包"><span class="nav-number">3.</span> <span class="nav-text">打包</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#打包成可执行的Jar"><span class="nav-number">3.1.</span> <span class="nav-text">打包成可执行的Jar</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#打包依赖了Spring-Boot的工具库"><span class="nav-number">3.2.</span> <span class="nav-text">打包依赖了Spring Boot的工具库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#打包契约类"><span class="nav-number">3.3.</span> <span class="nav-text">打包契约类</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置文件：Properties-和-YAML"><span class="nav-number">4.</span> <span class="nav-text">配置文件：Properties 和 YAML</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置文件的生效顺序，会对值进行覆盖"><span class="nav-number">4.1.</span> <span class="nav-text">配置文件的生效顺序，会对值进行覆盖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置随机值"><span class="nav-number">4.2.</span> <span class="nav-text">配置随机值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#应用简单配置"><span class="nav-number">4.3.</span> <span class="nav-text">应用简单配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置文件-多环境配置"><span class="nav-number">4.4.</span> <span class="nav-text">配置文件-多环境配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#多环境配置的好处"><span class="nav-number">4.4.1.</span> <span class="nav-text">多环境配置的好处</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Properties多环境配置"><span class="nav-number">4.4.2.</span> <span class="nav-text">Properties多环境配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#YAML多环境配置"><span class="nav-number">4.4.3.</span> <span class="nav-text">YAML多环境配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#两种配置方式的比较"><span class="nav-number">4.4.4.</span> <span class="nav-text">两种配置方式的比较</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何使用"><span class="nav-number">4.4.5.</span> <span class="nav-text">如何使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#热部署"><span class="nav-number">5.</span> <span class="nav-text">热部署</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用为Undertow作为Web容器"><span class="nav-number">6.</span> <span class="nav-text">使用为Undertow作为Web容器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#与Tomcat性能对比"><span class="nav-number">6.1.</span> <span class="nav-text">与Tomcat性能对比</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Maven配置"><span class="nav-number">6.2.</span> <span class="nav-text">Maven配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#监听多个端口与HTTP2支持"><span class="nav-number">6.3.</span> <span class="nav-text">监听多个端口与HTTP2支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Undertow相关配置"><span class="nav-number">6.4.</span> <span class="nav-text">Undertow相关配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#日志相关"><span class="nav-number">7.</span> <span class="nav-text">日志相关</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用Log4j2"><span class="nav-number">7.1.</span> <span class="nav-text">使用Log4j2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Maven配置-1"><span class="nav-number">7.1.1.</span> <span class="nav-text">Maven配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开启全局异步"><span class="nav-number">7.1.2.</span> <span class="nav-text">开启全局异步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#application-yml简单配置"><span class="nav-number">7.1.3.</span> <span class="nav-text">application.yml简单配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#log4j2-xml配置"><span class="nav-number">7.1.4.</span> <span class="nav-text">log4j2.xml配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#也可以使用log4j2-yml"><span class="nav-number">7.1.5.</span> <span class="nav-text">也可以使用log4j2.yml</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志配置文件中获取Application配置项"><span class="nav-number">7.2.</span> <span class="nav-text">日志配置文件中获取Application配置项</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Logback"><span class="nav-number">7.2.1.</span> <span class="nav-text">Logback</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Log4j2"><span class="nav-number">7.2.2.</span> <span class="nav-text">Log4j2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义字段"><span class="nav-number">7.3.</span> <span class="nav-text">自定义字段</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#查看依赖树"><span class="nav-number">8.</span> <span class="nav-text">查看依赖树</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#创建异步方法"><span class="nav-number">9.</span> <span class="nav-text">创建异步方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#启动异步"><span class="nav-number">9.1.</span> <span class="nav-text">启动异步</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编写异步方法"><span class="nav-number">9.2.</span> <span class="nav-text">编写异步方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置线程池"><span class="nav-number">9.3.</span> <span class="nav-text">配置线程池</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#直接声明线程池"><span class="nav-number">9.3.1.</span> <span class="nav-text">直接声明线程池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现AsyncConfigurer"><span class="nav-number">9.3.2.</span> <span class="nav-text">实现AsyncConfigurer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优雅关闭线程池"><span class="nav-number">9.3.3.</span> <span class="nav-text">优雅关闭线程池</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Async使用指定线程池"><span class="nav-number">9.4.</span> <span class="nav-text">Async使用指定线程池</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取异步执行结果"><span class="nav-number">9.5.</span> <span class="nav-text">获取异步执行结果</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring定时任务"><span class="nav-number">10.</span> <span class="nav-text">Spring定时任务</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring启动后执行程序的几种方式"><span class="nav-number">11.</span> <span class="nav-text">Spring启动后执行程序的几种方式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#PostConstruct-或-InitializingBean"><span class="nav-number">11.1.</span> <span class="nav-text">@PostConstruct 或 InitializingBean</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#监听ContextRefreshedEvent"><span class="nav-number">11.2.</span> <span class="nav-text">监听ContextRefreshedEvent</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring内置事件"><span class="nav-number">11.2.1.</span> <span class="nav-text">Spring内置事件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Boot-2-0新增事件"><span class="nav-number">11.2.2.</span> <span class="nav-text">Spring Boot 2.0新增事件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ApplicationRunner-或-CommandLineRunner"><span class="nav-number">11.3.</span> <span class="nav-text">ApplicationRunner 或 CommandLineRunner</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#onApplicationEvent执行两次问题"><span class="nav-number">11.4.</span> <span class="nav-text">onApplicationEvent执行两次问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring应用停止前执行程序的几种方式"><span class="nav-number">12.</span> <span class="nav-text">Spring应用停止前执行程序的几种方式</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#元注解与组合注解"><span class="nav-number">13.</span> <span class="nav-text">元注解与组合注解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#元注解"><span class="nav-number">13.1.</span> <span class="nav-text">元注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#组合注解"><span class="nav-number">13.2.</span> <span class="nav-text">组合注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义组合注解"><span class="nav-number">13.3.</span> <span class="nav-text">自定义组合注解</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-AOP"><span class="nav-number">14.</span> <span class="nav-text">Spring AOP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#注解说明"><span class="nav-number">14.1.</span> <span class="nav-text">注解说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#引入依赖"><span class="nav-number">14.2.</span> <span class="nav-text">引入依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AOP顺序"><span class="nav-number">14.3.</span> <span class="nav-text">AOP顺序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AOP记录Web访问日志用例"><span class="nav-number">14.4.</span> <span class="nav-text">AOP记录Web访问日志用例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#日志注解"><span class="nav-number">14.4.1.</span> <span class="nav-text">日志注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#声明Pointcut"><span class="nav-number">14.4.2.</span> <span class="nav-text">声明Pointcut</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#函数式方式动态注册-Bean"><span class="nav-number">15.</span> <span class="nav-text">函数式方式动态注册 Bean</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#自动配置的原理与自定义starter"><span class="nav-number">16.</span> <span class="nav-text">自动配置的原理与自定义starter</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Boot实现自动配置的原理"><span class="nav-number">16.1.</span> <span class="nav-text">Spring Boot实现自动配置的原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#入口注解类-EnableAutoConfiguration"><span class="nav-number">16.1.1.</span> <span class="nav-text">入口注解类@EnableAutoConfiguration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AutoConfigurationPackage"><span class="nav-number">16.1.2.</span> <span class="nav-text">@AutoConfigurationPackage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Import-EnableAutoConfigurationImportSelector-class"><span class="nav-number">16.1.3.</span> <span class="nav-text">@Import(EnableAutoConfigurationImportSelector.class)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#META-INF-spring-factories"><span class="nav-number">16.1.3.1.</span> <span class="nav-text">META-INF/spring.factories</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义starter"><span class="nav-number">16.2.</span> <span class="nav-text">自定义starter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义properties"><span class="nav-number">16.2.1.</span> <span class="nav-text">自定义properties</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#properties接收类"><span class="nav-number">16.2.2.</span> <span class="nav-text">properties接收类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Config类"><span class="nav-number">16.2.3.</span> <span class="nav-text">Config类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使Spring-Boot可以自动加载配置类"><span class="nav-number">16.2.4.</span> <span class="nav-text">使Spring Boot可以自动加载配置类</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#自定义Banner"><span class="nav-number">17.</span> <span class="nav-text">自定义Banner</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#优雅停机"><span class="nav-number">18.</span> <span class="nav-text">优雅停机</span></a></li></ol></div>
            

          </div>
        </section>
      
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
	
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-flash"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a></span>
</div>


<div class="powered-by">
    Personal Site
</div>

<div class="theme-info">
  Blog -
ookamiAntD | <span class="post-count">共189.4k字</span>
</div>



        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user">本站访客数</i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span>人次</span>
  

  
    <span class="site-pv"><i class="fa fa-eye">本站总访问量</i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span>次</span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">function run_disqus_script(e){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//"+disqus_shortname+".disqus.com/"+e,(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)}var disqus_shortname="ookamiantd",disqus_identifier="2018/spring-boot-learning-hodgepodge/",disqus_title="Spring Boot学习之杂记篇",disqus={load:function(){"object"!=typeof DISQUS&&(!function(){var e=document.createElement("script");e.async=!0,e.type="text/javascript",e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(e)}(),$("#load-disqus").html("评论加载中，请确保你有梯子，若评论长时间未加载则你可能翻墙失败...").fadeOut(9e3))}}</script>
  









  
  
  <script type="text/javascript">function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),n=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);n.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!1,n=r.title.trim().toLowerCase(),s=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),o=decodeURIComponent(r.url),i=-1,l=-1,p=-1;if(""!=n&&a.forEach(function(e,t){i=n.indexOf(e),l=s.indexOf(e),(i>=0||l>=0)&&(c=!0,0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+o+"' class='search-result-title'>"+n+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;u<0&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),n.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("usE0s6JGUeOiMcsVoRuHuv2B-gzGzoHsz","ewm6NEF07r83HbnOr63ptuKH")</script>
  <script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){if(0!==e.length){for(c=0;c<e.length;c++){var t=e[c],i=t.get("url"),s=t.get("time"),l=document.getElementById(i);$(l).find(".leancloud-visitors-count").text(s)}for(var c=0;c<n.length;c++){var i=n[c],l=document.getElementById(i),r=$(l).find(".leancloud-visitors-count");""==r.text()&&r.text(0)}}else o.find(".leancloud-visitors-count").text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){$(document.getElementById(n)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var s=new e,l=new AV.ACL;l.setPublicReadAccess(!0),l.setPublicWriteAccess(!0),s.setACL(l),s.set("title",o),s.set("url",n),s.set("time",1),s.save(null,{success:function(e){$(document.getElementById(n)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script>



  
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>


  


  <script type="text/javascript" color="255,0,204" opacity="0.5" zindex="-2" count="80" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script>



<script type="text/javascript">$("body").delegate(".-mob-share-weixin-qrcode-bg","click",function(){$(".-mob-share-weixin-qrcode-close").trigger("click")})</script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":100,"height":100,"position":"left"},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.5},"log":false});</script></body></html>