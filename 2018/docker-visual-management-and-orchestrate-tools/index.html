<!doctype html><html class="theme-next muse use-motion" lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta http-equiv="content-language" content="zh-cn"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><style>.pace .pace-progress{background:#ff009e;height:2px}.pace .pace-progress-inner{box-shadow:0 0 10px #e6006b,0 0 5px #ff009e}.pace .pace-activity{border-top-color:#ff009e;border-left-color:#ff009e}</style><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css"><meta name="keywords" content="Docker,Swarm,"><link rel="alternate" href="/atom.xml" title="ookamiAntD's Blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.png?v=5.1.0"><meta name="description" content="Preface在学习了Docker的基本操作之后，接下来就是Docker的管理部分了，这包括Docker的可视化管理以及集群管理。此篇主要记录Docker私有库的搭建，Docker编排工具的介绍以及使用，可视化管理工具的介绍以及搭建…"><meta name="keywords" content="Docker,Swarm"><meta property="og:type" content="article"><meta property="og:title" content="Docker可视化与管理工具"><meta property="og:url" content="http://yangbingdong.com/2018/docker-visual-management-and-orchestrate-tools/index.html"><meta property="og:site_name" content="ookamiAntD&#39;s Blog"><meta property="og:description" content="Preface在学习了Docker的基本操作之后，接下来就是Docker的管理部分了，这包括Docker的可视化管理以及集群管理。此篇主要记录Docker私有库的搭建，Docker编排工具的介绍以及使用，可视化管理工具的介绍以及搭建…"><meta property="og:locale" content="en"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-managerment.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-arch.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/proxy-port.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-registry-data.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-install.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-dashboard.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/refuse.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-push.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-compose-logo.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-machine-logo.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-machine-version.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-machine-create.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-machine-env.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-machine-ssh.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/swarm-diagram.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/services-diagram.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-swarm-task.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-swarm-net.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-node-ls.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/visualizer.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/rancher.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/shipyard-download.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/shipyard-need-containers.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/shipyard-containers.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/shipyard-container-info.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/portainer-demo.gif"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-containers.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-images.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-registry.png"><meta property="og:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/end-point.png"><meta property="og:updated_time" content="2018-08-30T02:56:16.786Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Docker可视化与管理工具"><meta name="twitter:description" content="Preface在学习了Docker的基本操作之后，接下来就是Docker的管理部分了，这包括Docker的可视化管理以及集群管理。此篇主要记录Docker私有库的搭建，Docker编排工具的介绍以及使用，可视化管理工具的介绍以及搭建…"><meta name="twitter:image" content="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-managerment.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",sidebar:{position:"right",display:"always"},fancybox:!0,motion:!0,duoshuo:{userId:"undefined",author:"Author"},algolia:{applicationID:"RI3NF6GUI0",apiKey:"3d33fa60ba30d3b17f37220bb1a36749",indexName:"blogIndex",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://yangbingdong.com/2018/docker-visual-management-and-orchestrate-tools/"><title>Docker可视化与管理工具 | ookamiAntD's Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e9505ac4e11d464329d615553a72b526";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class="headband"></div><a href="https://github.com/masteranthoneyd/blog" rel="external nofollow noopener noreferrer" target="_blank"><img style="position:absolute;top:0;left:0;border:0" src="https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png"></a><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">ookamiAntD's Blog</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Easy coding,easy life.</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook" rel="section"><i class="menu-item-icon fa fa-fw fa-commenting"></i><br>Message</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div><span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://yangbingdong.com/2018/docker-visual-management-and-orchestrate-tools/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ookamiAntD"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar/avatar-admin.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="ookamiAntD's Blog"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="ookamiAntD's Blog" src=""></span></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Docker可视化与管理工具</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-02T12:57:52+08:00">2018-01-02 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span> </a></span></span><span id="/2018/docker-visual-management-and-orchestrate-tools/" class="leancloud_visitors" data-flag-title="Docker可视化与管理工具"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">Visitors </span><span class="leancloud-visitors-count"></span></span><br><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-edit"></i> </span><span class="post-meta-item-text">WordCount:</span> <span class="post-count">11,594字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-text">min2read:</span> <span class="post-count">50分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-managerment.png" alt=""></p><h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><blockquote><p>在学习了Docker的基本操作之后，接下来就是Docker的管理部分了，这包括Docker的可视化管理以及集群管理。</p><p>此篇主要记录Docker私有库的搭建，Docker编排工具的介绍以及使用，可视化管理工具的介绍以及搭建…</p></blockquote><a id="more"></a><h1 id="Docker-Registry-amp-Mirror"><a href="#Docker-Registry-amp-Mirror" class="headerlink" title="Docker Registry &amp; Mirror"></a>Docker Registry &amp; Mirror</h1><h2 id="Harbor"><a href="#Harbor" class="headerlink" title="Harbor"></a>Harbor</h2><p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-arch.png" alt=""></p><p>Harbor是一个用于存储和分发Docker镜像的企业级Registry服务器，通过添加一些企业必需的功能特性，例如安全、标识和管理等，扩展了开源Docker Distribution。作为一个企业级私有Registry服务器，Harbor提供了更好的性能和安全。提升用户使用Registry构建和运行环境传输镜像的效率。Harbor支持安装在多个Registry节点的镜像资源复制，镜像全部保存在私有Registry中， 确保数据和知识产权在公司内部网络中管控。另外，Harbor也提供了高级的安全特性，诸如用户管理，访问控制和活动审计等。</p><ul><li><strong>基于角色的访问控制</strong> - 用户与Docker镜像仓库通过“项目”进行组织管理，一个用户可以对多个镜像仓库在同一命名空间（project）里有不同的权限。</li><li><strong>镜像复制</strong> - 镜像可以在多个Registry实例中复制（同步）。尤其适合于负载均衡，高可用，混合云和多云的场景。</li><li><strong>图形化用户界面</strong> - 用户可以通过浏览器来浏览，检索当前Docker镜像仓库，管理项目和命名空间。</li><li><strong>AD/LDAP 支持</strong> - Harbor可以集成企业内部已有的AD/LDAP，用于鉴权认证管理。</li><li><strong>审计管理</strong> - 所有针对镜像仓库的操作都可以被记录追溯，用于审计管理。</li><li><strong>国际化</strong> - 已拥有英文、中文、德文、日文和俄文的本地化版本。更多的语言将会添加进来。</li><li><strong>RESTful API</strong> - RESTful API 提供给管理员对于Harbor更多的操控, 使得与其它管理软件集成变得更容易。</li><li><p><strong>部署简单</strong> - 提供在线和离线两种安装工具， 也可以安装到vSphere平台(OVA方式)虚拟设备。</p></li><li><p>集成clair进行镜像安全漏洞扫描</p></li></ul><p>Harbor共由七个容器组成:</p><p>a.<code>harbor-adminserver</code>:harbor系统管理服务</p><p>b.<code>harbor-db</code>: 由官方mysql镜像构成的数据库容器</p><p>c.<code>harbor-jobservice</code>:harbor的任务管理服务</p><p>d.<code>harbor-log</code>:harbor的日志收集、管理服务</p><p>e.<code>harbor-ui</code>:harbor的web页面服务</p><p>f.<code>nginx</code>:负责流量转发和安全验证</p><p>g.<code>registry</code>:官方的Docker registry，负责保存镜像</p><h3 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h3><p>前置条件：</p><p>1.需要<code>Python2.7</code>或以上</p><p>2.Docker版本要在1.10或以上</p><p>3.Docker compose版本要在1.6.0或以上</p><h3 id="Download"><a href="#Download" class="headerlink" title="Download"></a>Download</h3><p><a href="https://github.com/vmware/harbor/releases" rel="external nofollow noopener noreferrer" target="_blank"><strong><em>Release页面</em></strong></a>下载离线安装包（或在线也可以，不过安装的时候很慢）</p><h3 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h3><p>解压缩之后，目录下会生成<code>harbor.conf</code>文件，该文件就是Harbor的配置文件。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. hostname设置访问地址，可以使用ip、域名，不可以设置为127.0.0.1或localhost</span></span><br><span class="line"><span class="comment"># 2. 默认情况下，harbor使用的端口是80，若使用自定义的端口，除了要改docker-compose.yml文件中的配置外，</span></span><br><span class="line"><span class="comment"># 这里的hostname也要加上自定义的端口，在docker login、push时会报错</span></span><br><span class="line"><span class="comment"># hostname = $&#123;IP_ADDR&#125;:$&#123;PORT&#125;</span></span><br><span class="line"><span class="attr">hostname</span> = <span class="number">192.168</span>.<span class="number">1.102</span>:<span class="number">8888</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问协议，默认是http，也可以设置https，如果设置https，则nginx ssl需要设置on</span></span><br><span class="line"><span class="attr">ui_url_protocol</span> = http</span><br><span class="line"></span><br><span class="line"><span class="comment"># mysql数据库root用户默认密码root123，实际使用时修改下</span></span><br><span class="line"><span class="attr">db_password</span> = root123</span><br><span class="line"></span><br><span class="line"><span class="comment">#Maximum number of job workers in job service  </span></span><br><span class="line"><span class="attr">max_job_workers</span> = <span class="number">3</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#The path of secretkey storage</span></span><br><span class="line"><span class="attr">secretkey_path</span> = /data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Harbor后，管理员UI登录的密码，默认是Harbor12345</span></span><br><span class="line"><span class="comment"># 若修改了此处的admin登录密码。则登录后台时使用修改后的密码</span></span><br><span class="line"><span class="attr">harbor_admin_password</span> = Harbor12345</span><br><span class="line"></span><br><span class="line"><span class="comment"># 认证方式，这里支持多种认证方式，如LADP、本次存储、数据库认证。默认是db_auth，mysql数据库认证</span></span><br><span class="line"><span class="attr">auth_mode</span> = db_auth</span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否开启自注册</span></span><br><span class="line"><span class="attr">self_registration</span> = <span class="literal">on</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Token有效时间，默认30分钟</span></span><br><span class="line"><span class="attr">token_expiration</span> = <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户创建项目权限控制，默认是everyone（所有人），也可以设置为adminonly（只能管理员）</span></span><br><span class="line"><span class="attr">project_creation_restriction</span> = everyone</span><br></pre></td></tr></table></figure>
<p>harbor默认监听80端口，我们修改为8888端口，同时<code>docker-compose.yml</code>也需要修改<code>proxy</code>的端口</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/proxy-port.png" alt=""></p>
<p>还可以修改仓库的存储位置：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-registry-data.png" alt=""></p>
<h3 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h3><p>运行安装脚本：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./<span class="keyword">install</span>.sh</span><br></pre></td></tr></table></figure>
<p>集成clair漏洞扫描：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./install.sh</span> <span class="params">--with-clair</span></span><br></pre></td></tr></table></figure>
<p>脚本会自动解压镜像文件并运行docker-compose</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-install.png" alt=""></p>
<p>或者运行<code>prepare</code>文件再手动运行docker-compose</p>
<p>启动之后浏览器打开刚才修改的hostname</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-dashboard.png" alt=""></p>
<p><strong>帐号密码默认是</strong> <code>admin/Harbor12345</code>，可在配置文件<code>harbor.conf</code>中修改</p>
<p><strong>修改配置文件之后</strong>需要重新生成一些内置配置：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./<span class="built_in">prepare</span></span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<h3 id="登录被refuse"><a href="#登录被refuse" class="headerlink" title="登录被refuse"></a>登录被refuse</h3><p>多次docker login被refuse</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/refuse.png" alt=""></p>
<p>这是因为 Docker 默认<strong>不允许非 <code>HTTPS</code> 方式推送镜像</strong>。我们可以通过 Docker 配置来<strong>取消这个限制</strong>，或者配置能够通过 <code>HTTPS</code> 访问的私有仓库。</p>
<p>如果是<code>systemd</code> 的系统例如<code>Ubuntu16.04+</code>、<code>Debian 8+</code>、<code>centos 7</code>，可以在<code>/etc/docker/daemon.json</code> 中写入如下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"registry-mirrors"</span>: [<span class="string">"https://xxxxx.mirror.aliyuncs.com"</span>],</span><br><span class="line">  <span class="attr">"insecure-registries"</span>: [<span class="string">"192.168.1.102:8888"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后重新加载Docker：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo systemctl reload docker</span></span><br></pre></td></tr></table></figure>
<h3 id="Login-and-Push"><a href="#Login-and-Push" class="headerlink" title="Login and Push"></a>Login and Push</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker login <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.102</span>:<span class="number">8888</span> -u admin -p Harbor12345</span><br><span class="line"></span><br><span class="line">docker tag ubuntu:latest <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.102</span>/library/ubuntu:latest</span><br><span class="line">docker <span class="keyword">push</span> <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.102</span>/library/ubuntu:latest</span><br></pre></td></tr></table></figure>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-push.png" alt=""></p>
<p><strong>注意</strong>：使用<code>docker stack deploy</code>时，如果是私有镜像，需要终端登录后加上<code>--with-registry-auth</code>选项。</p>
<h3 id="删除Harbor"><a href="#删除Harbor" class="headerlink" title="删除Harbor"></a>删除Harbor</h3><p><strong>删除harbor，但保留数据</strong></p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker-compose down -v</span></span><br></pre></td></tr></table></figure>
<p><strong>删除harbor数据</strong>（对应<code>docker-compose.yml</code>里面的数据卷）</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">rm</span> -r /<span class="class"><span class="keyword">data</span>/database</span></span><br><span class="line"><span class="title">rm</span> -r /<span class="class"><span class="keyword">data</span>/registry</span></span><br></pre></td></tr></table></figure>
<p><strong>删除镜像</strong></p>
<p>UI界面操作删除镜像，只是删除元数据，并未删除真实数据，还需要调用registry的garbage-collect进行清理</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker-compose stop</span><br><span class="line"></span><br><span class="line">docker run -it <span class="params">--name</span> gc <span class="params">--rm</span> <span class="params">--volumes-from</span> registry vmware/registry<span class="function">:2.6.2-photon</span> garbage-collect <span class="params">--dry-run</span> <span class="string">/etc/registry/config.yml</span> <span class="comment">#只是打印过程，并不删除</span></span><br><span class="line"></span><br><span class="line">docker run -it <span class="params">--name</span> gc <span class="params">--rm</span> <span class="params">--volumes-from</span> registry vmware/registry<span class="function">:2.6.2-photon</span> garbage-collect  <span class="string">/etc/registry/config.yml</span></span><br><span class="line"></span><br><span class="line">docker-compose start</span><br></pre></td></tr></table></figure>
<p>注意：配置文件<code>config.yml</code>挂载在<code>/etc/registry/</code>下.</p>
<h3 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h3><h4 id="python版本"><a href="#python版本" class="headerlink" title="python版本"></a>python版本</h4><p>在Ubuntu18.04中的python是3+版本的，需要装回2.7版本，不然会有不明异常。。。：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt <span class="keyword">install</span> python2.<span class="number">7</span> python-minimal -y</span><br></pre></td></tr></table></figure>
<h4 id="Fail-to-generate-key-file"><a href="#Fail-to-generate-key-file" class="headerlink" title="Fail to generate key file"></a>Fail to generate key file</h4><p>这个貌似是openssl的问题，解决方案是将<code>prepare</code>中的<code>empty_subj = &quot;/C=/ST=/L=/O=/CN=/&quot;</code>改为<code>empty_subj = &quot;/&quot;</code></p>
<h2 id="Registry-Mirror"><a href="#Registry-Mirror" class="headerlink" title="Registry Mirror"></a>Registry Mirror</h2><p><strong>registry mirror原理</strong></p>
<p>Docker Hub的镜像数据分为两部分：index数据和registry数据。前者保存了镜像的一些元数据信息，数据量很小；后者保存了镜像的实际数据，数据量比较大。平时我们使用docker pull命令拉取一个镜像时的过程是：先去index获取镜像的一些元数据，然后再去registry获取镜像数据。</p>
<p>所谓registry mirror就是搭建一个registry，然后将docker hub的registry数据缓存到自己本地的registry。整个过程是：当我们使用docker pull去拉镜像的时候，会先从我们本地的registry mirror去获取镜像数据，如果不存在，registry mirror会先从docker hub的registry拉取数据进行缓存，再传给我们。而且整个过程是流式的，registry mirror并不会等全部缓存完再给我们传，而且边缓存边给客户端传。</p>
<p>对于缓存，我们都知道一致性非常重要。registry mirror与docker官方保持一致的方法是：registry mirror只是缓存了docker hub的registry数据，并不缓存index数据。所以我们pull镜像的时候会先连docker hub的index获取镜像的元数据，如果我们registry mirror里面有该镜像的缓存，且数据与从index处获取到的元数据一致，则从registry mirror拉取；如果我们的registry mirror有该镜像的缓存，但数据与index处获取的元数据不一致，或者根本就没有该镜像的缓存，则先从docker hub的registry缓存或者更新数据。</p>
<p>1、拉取镜像</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">docker</span> <span class="selector-tag">pull</span> <span class="selector-tag">registry</span><span class="selector-pseudo">:latest</span></span><br></pre></td></tr></table></figure>
<p>2、获取registry的默认配置</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">run</span> -<span class="keyword">it</span> <span class="comment">--rm --entrypoint cat registry:latest  /etc/docker/registry/config.yml &gt; config.yml</span></span><br></pre></td></tr></table></figure>
<p>内容可能如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">0.1</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">registry</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line"><span class="attr">  cache:</span></span><br><span class="line"><span class="attr">    blobdescriptor:</span> <span class="string">inmemory</span></span><br><span class="line"><span class="attr">  filesystem:</span></span><br><span class="line"><span class="attr">    rootdirectory:</span> <span class="string">/var/lib/registry</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line"><span class="attr">  addr:</span> <span class="string">:5000</span></span><br><span class="line"><span class="attr">  headers:</span></span><br><span class="line"><span class="attr">    X-Content-Type-Options:</span> <span class="string">[nosniff]</span></span><br><span class="line"><span class="attr">health:</span></span><br><span class="line"><span class="attr">  storagedriver:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">    threshold:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>我们在最后面加上如下配置：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy</span>:</span><br><span class="line">  <span class="attribute">remoteurl</span>: <span class="attribute">https</span>:<span class="comment">//registry-1.docker.io</span></span><br><span class="line">  <span class="attribute">username</span>: [username]</span><br><span class="line">  <span class="attribute">password</span>: [password]</span><br></pre></td></tr></table></figure>
<p><code>username</code>和<code>password</code>是可选的，如果配置了的话，那registry mirror除了可以缓存所有的公共镜像外，也可以访问这个用户所有的私有镜像。</p>
<p>启动registry容器：</p>
<p>Bash</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run  --restart=always -p <span class="number">5000</span>:<span class="number">5000</span> --name v2-mirror -v /<span class="symbol">data:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">registry</span> -<span class="title">v</span>  $<span class="title">PWD</span>/<span class="title">config</span>.<span class="title">yml</span>:/<span class="title">etc</span>/<span class="title">registry</span>/<span class="title">config</span>.<span class="title">yml</span> <span class="title">registry</span>:<span class="title">latest</span> /<span class="title">etc</span>/<span class="title">registry</span>/<span class="title">config</span>.<span class="title">yml</span></span></span><br></pre></td></tr></table></figure>
<p>当然我们也可以使用docker-compose启动：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">version</span>: <span class="string">'3'</span></span><br><span class="line"><span class="attribute">services</span>:</span><br><span class="line">  <span class="attribute">registry</span>:</span><br><span class="line">    <span class="attribute">image</span>: library/<span class="attribute">registry</span>:latest</span><br><span class="line">    <span class="attribute">container_name</span>: registry-mirror</span><br><span class="line">    <span class="attribute">restart</span>: always</span><br><span class="line">    <span class="attribute">volumes</span>:</span><br><span class="line">      - /<span class="attribute">data</span>:/var/lib/registry</span><br><span class="line">      - ./config.<span class="attribute">yml</span>:/etc/registry/config.yml</span><br><span class="line">    <span class="attribute">ports</span>:</span><br><span class="line">      - <span class="number">5000</span>:<span class="number">5000</span></span><br><span class="line">    <span class="attribute">command</span>:</span><br><span class="line">      [<span class="string">"serve"</span>, <span class="string">"/etc/registry/config.yml"</span>]</span><br></pre></td></tr></table></figure>
<p>curl验证一下服务是否启动OK：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ybd @ ybd-PC in ~ [17:30:14] </span></span><br><span class="line"><span class="string">$</span> <span class="string">curl</span> <span class="bullet">-I</span> <span class="attr">http://192.168.6.113:5000</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="attr">Cache-Control:</span> <span class="literal">no</span><span class="bullet">-cache</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Fri,</span> <span class="number">05</span> <span class="string">Jan</span> <span class="number">2018</span> <span class="number">09</span><span class="string">:30:27</span> <span class="string">GMT</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">text/plain;</span> <span class="string">charset=utf-8</span></span><br></pre></td></tr></table></figure>
<p>最后修改<code>/etc/docker/daemon.json</code>或<code>/etc/default/docker</code>中的<code>registry-mirrors</code>即可</p>
<h1 id="Cluster-and-Orchestrate-Tools"><a href="#Cluster-and-Orchestrate-Tools" class="headerlink" title="Cluster and Orchestrate Tools"></a>Cluster and Orchestrate Tools</h1><h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-compose-logo.png" alt=""></p>
<blockquote>
<p>官方文档：<a href="https://docs.docker.com/compose/" rel="external nofollow noopener noreferrer" target="_blank"><strong><em>https://docs.docker.com/compose/</em></strong></a></p>
<p>release：<a href="https://github.com/docker/compose/releases" rel="external nofollow noopener noreferrer" target="_blank"><strong><em>https://github.com/docker/compose/releases</em></strong></a></p>
</blockquote>
<p>Compose是定义和运行多容器Docker应用程序的工具，使用Compose，您可以使用YAML文件来配置应用程序的服务，然后，使用单个命令创建并启动配置中的所有服务。</p>
<p>Dockerfile 可以让用户管理一个单独的应用容器。使用Docker Compose，不再需要使用shell脚本来启动容器。在配置文件中，所有的容器通过services来定义，然后使用<code>docker-compose</code>脚本来启动，停止和重启应用，和应用中的服务以及所有依赖服务的容器</p>
<h3 id="Install-1"><a href="#Install-1" class="headerlink" title="Install"></a>Install</h3><p>最新安装请看官方文档：<strong><em><a href="https://docs.docker.com/compose/install/#install-compose" rel="external nofollow noopener noreferrer" target="_blank">https://docs.docker.com/compose/install/#install-compose</a></em></strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L https:<span class="regexp">//gi</span>thub.com<span class="regexp">/docker/</span>compose<span class="regexp">/releases/</span>download<span class="regexp">/1.21.2/</span>docker-compose-`uname -s`-`uname -m` -o <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>docker-compose</span><br></pre></td></tr></table></figure>
<p>变为可执行命令：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>docker-compose</span><br></pre></td></tr></table></figure>
<p>检查安装成功：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="comment">--version</span></span><br></pre></td></tr></table></figure>
<p>卸载：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rm <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>docker-compose</span><br></pre></td></tr></table></figure>
<h3 id="Command"><a href="#Command" class="headerlink" title="Command"></a>Command</h3><p>基本命令：</p>
<p><code>-p</code> 指定项目名称</p>
<p><code>build</code> 构建项目中的服务容器 –force-rm 删除构建过程中的临时容器</p>
<p><code>--no-cache</code> 构建过程中不使用 cache</p>
<p><code>--pull</code> 始终通过 pull 来获取更新版本的镜像</p>
<p><code>docker-compose kill</code> 强制停止服务容器</p>
<p><code>docker-compose logs</code> 查看容器的输出 调试必备</p>
<p><code>docker-compose pause</code> 暂停一个服务容器</p>
<p><code>docker-compose unpause</code> 恢复暂停</p>
<p><code>docker-compose port</code> 打印某个容器端口所映射的公共端口</p>
<p><code>docker-compose ps</code> 列出项目中目前的所有容器 -q 只打印容器 id</p>
<p><code>docker-compose pull</code> 拉取服务依赖的镜像</p>
<p><code>docker-compose restart -t</code> 指定重启前停止容器的超时默认10秒</p>
<p><code>docker-compose rm</code> 删除所有停止状态的容器先执行 stop</p>
<p><code>docker-compose run</code> 指定服务上执行一个命令</p>
<p><code>docker-compose start</code> 启动已经存在的服务容器</p>
<p><code>docker-compose stop</code> 停止已经存在的服务容器</p>
<p><code>docker-compose up</code> 自动构建、创建服务、启动服务，关联一系列，运行在前台，ctrl c 就都停止运行。如果容器已经存在，将会尝试停止容器，重新创建。如果不希望重新创建，可以 <code>--no-recreate</code> 就只启动处于停止状态的容器，如果只想重新部署某个服务，可以使用</p>
<p><code>docker-compose up --no-deps -d</code> ，不影响其所依赖的服务</p>
<p><code>docker-compose up -d</code> 后台启动运行，生产环境必备</p>
<p><code>docker-compose down</code> 停止并删除容器</p>
<h3 id="Zsh命令补全"><a href="#Zsh命令补全" class="headerlink" title="Zsh命令补全"></a>Zsh命令补全</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~<span class="regexp">/.zsh/</span>completion</span><br><span class="line">curl -L https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/docker/</span>compose<span class="regexp">/$(docker-compose version --short)/</span>contrib<span class="regexp">/completion/</span>zsh<span class="regexp">/_docker-compose &gt; ~/</span>.zsh<span class="regexp">/completion/</span>_docker-compose</span><br></pre></td></tr></table></figure>
<p>在<code>.zshrc</code>添加：</p>
<p><strong>注意</strong>：(如果是<code>oh-my-zsh</code>，在<code>$ZSH/oh-my-zsh.sh</code>中添加)</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">fpath</span>=(~/.zsh/completion <span class="variable">$fpath</span>)</span><br></pre></td></tr></table></figure>
<p>执行：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoload -Uz compinit <span class="meta">&amp;&amp; compinit -i</span></span><br></pre></td></tr></table></figure>
<p>重载：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span> <span class="variable">$SHELL</span> -l</span><br></pre></td></tr></table></figure>
<h3 id="Compose-文件指令"><a href="#Compose-文件指令" class="headerlink" title="Compose 文件指令"></a>Compose 文件指令</h3><blockquote>
<p>最新参看文档： <strong><em><a href="https://docs.docker.com/compose/compose-file/" rel="external nofollow noopener noreferrer" target="_blank">https://docs.docker.com/compose/compose-file/</a></em></strong></p>
</blockquote>
<p>默认的模板文件名称为 <code>docker-compose.yml</code>，格式为 YAML 格式。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line"><span class="symbol">  webapp:</span></span><br><span class="line"><span class="symbol">    image:</span> examples/web</span><br><span class="line"><span class="symbol">    ports:</span></span><br><span class="line">      - <span class="string">"80:80"</span></span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - <span class="string">"/data"</span></span><br></pre></td></tr></table></figure>
<p>注意每个服务都必须通过 <code>image</code> 指令指定镜像或 <code>build</code> 指令（需要 Dockerfile）等来自动构建生成镜像。</p>
<p>如果使用 <code>build</code> 指令，在 <code>Dockerfile</code> 中设置的选项(例如：<code>CMD</code>, <code>EXPOSE</code>, <code>VOLUME</code>, <code>ENV</code> 等) 将会自动被获取，无需在 <code>docker-compose.yml</code> 中再次设置。下面分别介绍各个指令的用法。</p>
<h4 id="build"><a href="#build" class="headerlink" title="build"></a><code>build</code></h4><p>指定 <code>Dockerfile</code> 所在文件夹的路径（可以是绝对路径，或者相对 docker-compose.yml 文件的路径）。 <code>Compose</code> 将会利用它自动构建这个镜像，然后使用这个镜像。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">  webapp:</span></span><br><span class="line"><span class="symbol">    build:</span> ./dir</span><br></pre></td></tr></table></figure>
<p>你也可以使用 <code>context</code> 指令指定 <code>Dockerfile</code> 所在文件夹的路径。</p>
<p>使用 <code>dockerfile</code> 指令指定 <code>Dockerfile</code> 文件名。</p>
<p>使用 <code>arg</code> 指令指定构建镜像时的变量。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">  webapp:</span></span><br><span class="line"><span class="symbol">    build:</span></span><br><span class="line"><span class="symbol">      context:</span> ./dir</span><br><span class="line"><span class="symbol">      dockerfile:</span> Dockerfile-alternate</span><br><span class="line"><span class="symbol">      args:</span></span><br><span class="line"><span class="symbol">        buildno:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>使用 <code>cache_from</code> 指定构建镜像的缓存</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">build</span>:</span><br><span class="line">  <span class="attribute">context</span>: .</span><br><span class="line">  <span class="attribute">cache_from</span>:</span><br><span class="line">    - <span class="attribute">alpine</span>:latest</span><br><span class="line">    - corp/<span class="attribute">web_app</span>:<span class="number">3.14</span></span><br></pre></td></tr></table></figure>
<h4 id="cap-add-cap-drop"><a href="#cap-add-cap-drop" class="headerlink" title="cap_add, cap_drop"></a><code>cap_add, cap_drop</code></h4><p>指定容器的内核能力（capacity）分配。</p>
<p>例如，让容器拥有所有能力可以指定为：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cap_add:</span><br><span class="line">  - <span class="keyword">ALL</span></span><br></pre></td></tr></table></figure>
<p>去掉 NET_ADMIN 能力可以指定为：</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">cap_drop:</span></span><br><span class="line">  - NET_ADMIN</span><br></pre></td></tr></table></figure>
<h4 id="command"><a href="#command" class="headerlink" title="command"></a><code>command</code></h4><p>覆盖容器启动后默认执行的命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span>: <span class="built_in">echo</span> <span class="string">"hello world"</span></span><br></pre></td></tr></table></figure>
<h4 id="configs"><a href="#configs" class="headerlink" title="configs"></a><code>configs</code></h4><p>仅用于 <code>Swarm mode</code>，详细内容请查看下面Swarm模式介绍</p>
<h4 id="cgroup-parent"><a href="#cgroup-parent" class="headerlink" title="cgroup_parent"></a><code>cgroup_parent</code></h4><p>指定父 <code>cgroup</code> 组，意味着将继承该组的资源限制。</p>
<p>例如，创建了一个 cgroup 组名称为 <code>cgroups_1</code>。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">cgroup_parent:</span> cgroups_1</span><br></pre></td></tr></table></figure>
<h4 id="container-name"><a href="#container-name" class="headerlink" title="container_name"></a><code>container_name</code></h4><p>指定容器名称。默认将会使用 <code>项目名称_服务名称_序号</code> 这样的格式。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">container_name:</span> docker-web-container</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意: 指定容器名称后，该服务将<strong>无法进行扩展</strong>（<strong>scale</strong>），因为 Docker 不允许多个容器具有相同的名称。</p>
</blockquote>
<h4 id="deploy"><a href="#deploy" class="headerlink" title="deploy"></a><code>deploy</code></h4><p>仅用于 <code>Swarm mode</code>，这是 V3 才能使用的语法，通过<code>docker-compose up</code>方式启动会忽略这部分。</p>
<p>语法规则：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">deploy:</span></span><br><span class="line"><span class="symbol">  replicas:</span> <span class="number">6</span></span><br><span class="line"><span class="symbol">  update_config:</span></span><br><span class="line"><span class="symbol">    parallelism:</span> <span class="number">2</span></span><br><span class="line"><span class="symbol">    delay:</span> <span class="number">10</span>s</span><br><span class="line"><span class="symbol">  restart_policy:</span></span><br><span class="line"><span class="symbol">    condition:</span> on-failure</span><br></pre></td></tr></table></figure>
<h5 id="mode"><a href="#mode" class="headerlink" title="mode"></a><code>mode</code></h5><p>首先 deploy 提供了一个模式选项，它的值有 <code>global</code> 和 <code>replicated</code> 两个，默认是 <code>replicated</code> 模式。</p>
<p>这两个模式的区别是：</p>
<ul>
<li><code>global</code>：每个集群每个服务实例启动一个容器，就像以前启动 Service 时一样。</li>
<li><code>replicated</code>：用户可以指定集群中实例的副本数量。</li>
</ul>
<p>以前这个功能是无法在 Compose 中直接实现的，以前需要用户先使用 <code>docker-compose bundle</code> 命令将 docker-compose.yml 转换为 .dab 文件，然后才能拿到集群部署，而且很多功能用不了。</p>
<p>但是随着这次更新把 stack 加进来了，deploy 也就水到渠成加进了 Compose 功能中。</p>
<h5 id="replicas"><a href="#replicas" class="headerlink" title="replicas"></a><code>replicas</code></h5><p>上面说到可以指定副本数量，其中 replicas 就是用于指定副本数量的选项。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">deploy:</span></span><br><span class="line"><span class="symbol">  replicas:</span> <span class="number">6</span></span><br></pre></td></tr></table></figure>
<p>部署服务栈：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stack <span class="keyword">deploy</span> <span class="params">--compose-file</span> docker-compose.yml</span><br></pre></td></tr></table></figure>
<h5 id="placement"><a href="#placement" class="headerlink" title="placement"></a><code>placement</code></h5><p>这是 Docker 1.12 版本时就引入的概念，允许用户限制服务容器，下面是官方的说明：</p>
<table>
<thead>
<tr>
<th>node attribute</th>
<th>matches</th>
<th>example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>node.id</code></td>
<td>Node ID</td>
<td><code>node.id==2ivku8v2gvtg4</code></td>
</tr>
<tr>
<td><code>node.hostname</code></td>
<td>Node hostname</td>
<td><code>node.hostname!=node-2</code></td>
</tr>
<tr>
<td><code>node.role</code></td>
<td>Node role</td>
<td><code>node.role==manager</code></td>
</tr>
<tr>
<td><code>node.labels</code></td>
<td>user defined node labels</td>
<td><code>node.labels.security==high</code></td>
</tr>
<tr>
<td><code>engine.labels</code></td>
<td>Docker Engine’s labels</td>
<td><code>engine.labels.operatingsystem==ubuntu 14.04</code></td>
</tr>
</tbody>
</table>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">version</span>: '<span class="number">3</span>'</span><br><span class="line">services:</span><br><span class="line">  db:</span><br><span class="line">    image: postgres</span><br><span class="line">    deploy:</span><br><span class="line">      placement:</span><br><span class="line">        constraints:</span><br><span class="line">          - <span class="keyword">node</span>.<span class="title">role</span> == manager</span><br><span class="line">          - engine.labels.operatingsystem == ubuntu <span class="number">14.04</span></span><br><span class="line">        preferences:</span><br><span class="line">          - spread: <span class="keyword">node</span>.<span class="title">labels</span>.zone</span><br></pre></td></tr></table></figure>
<h5 id="update-config"><a href="#update-config" class="headerlink" title="update_config"></a><code>update_config</code></h5><p>早在上一个版本中，Swarm 就提供了一个升级回滚的功能。当服务升级出现故障时，超过重试次数则停止升级的功能，这也很方便，避免让错误的应用替代现有正常服务。</p>
<p>这个选项用于告诉 Compose 使用怎样的方式升级，以及升级失败后怎样回滚原来的服务。</p>
<ul>
<li><code>parallelism</code>: 服务中多个容器同时更新。</li>
<li><code>delay</code>: 设置每组容器更新之间的延迟时间。</li>
<li><code>failure_action</code>: 设置更新失败时的动作，可选值有 continue 与 pause (默认是：pause)。</li>
<li><code>monitor</code>: 每次任务更新失败后监视故障的持续时间 (ns|us|ms|s|m|h) (默认：0s)。</li>
<li><code>max_failure_ratio</code>: 更新期间容忍的故障率。</li>
</ul>
<h5 id="resources"><a href="#resources" class="headerlink" title="resources"></a><code>resources</code></h5><p>看例子：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">resources</span>:</span><br><span class="line">  <span class="attribute">limits</span>:</span><br><span class="line">    <span class="attribute">cpus</span>: <span class="string">'0.001'</span></span><br><span class="line">    <span class="attribute">memory</span>: <span class="number">50</span>M</span><br><span class="line">  <span class="attribute">reservations</span>:</span><br><span class="line">    <span class="attribute">cpus</span>: <span class="string">'0.0001'</span></span><br><span class="line">    <span class="attribute">memory</span>: <span class="number">20</span>M</span><br></pre></td></tr></table></figure>
<p>知道干啥用了吧，这是一个新的语法选项，替代了之前的类似 <code>cpu_shares</code>, <code>cpu_quota</code>, <code>cpuset</code>, <code>mem_limit</code>, <code>memswap_limit</code> 这种选项。统一起来好看点。</p>
<h5 id="restart-policy"><a href="#restart-policy" class="headerlink" title="restart_policy"></a><code>restart_policy</code></h5><p>设置如何重启容器，毕竟有时候容器会意外退出。</p>
<ul>
<li><code>condition</code>：设置重启策略的条件，可选值有 none, on-failure 和 any (默认：any)。</li>
<li><code>delay</code>：在重新启动尝试之间等待多长时间，指定为持续时间（默认值：0）。</li>
<li><code>max_attempts</code>：设置最大的重启尝试次数，默认是永不放弃，哈哈，感受到一股运维的绝望。</li>
<li><code>window</code>：在决定重新启动是否成功之前要等待多长时间，默认是立刻判断，有些容器启动时间比较长，指定一个“窗口期”非常重要。</li>
</ul>
<h4 id="devices"><a href="#devices" class="headerlink" title="devices"></a><code>devices</code></h4><p>指定设备映射关系。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">devices:</span></span><br><span class="line">  - <span class="string">"/dev/ttyUSB1:/dev/ttyUSB0"</span></span><br></pre></td></tr></table></figure>
<h4 id="depends-on"><a href="#depends-on" class="headerlink" title="depends_on"></a><code>depends_on</code></h4><p>解决容器的依赖、<strong>启动先后的问题</strong>。以下例子中会先启动 <code>redis</code> <code>db</code> 再启动 <code>web</code></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">version:</span> <span class="string">'3'</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line"><span class="symbol">  web:</span></span><br><span class="line"><span class="symbol">    build:</span> .</span><br><span class="line"><span class="symbol">    depends_on:</span></span><br><span class="line">      - db</span><br><span class="line">      - redis</span><br><span class="line"></span><br><span class="line"><span class="symbol">  redis:</span></span><br><span class="line"><span class="symbol">    image:</span> redis</span><br><span class="line"></span><br><span class="line"><span class="symbol">  db:</span></span><br><span class="line"><span class="symbol">    image:</span> postgres</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：<code>web</code> 服务不会等待 <code>redis</code> <code>db</code> 「完全启动」之后才启动。</p>
</blockquote>
<h4 id="dns"><a href="#dns" class="headerlink" title="dns"></a><code>dns</code></h4><p>自定义 <code>DNS</code> 服务器。可以是一个值，也可以是一个列表。</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">dns</span>: 8.8.8.8</span><br><span class="line"></span><br><span class="line"><span class="attribute">dns:</span></span><br><span class="line"><span class="attribute">  - 8.8.8.8</span></span><br><span class="line"><span class="attribute">  - 114.114.114.114</span></span><br></pre></td></tr></table></figure>
<h4 id="dns-search"><a href="#dns-search" class="headerlink" title="dns_search"></a><code>dns_search</code></h4><p>配置 <code>DNS</code> 搜索域。可以是一个值，也可以是一个列表。</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">dns_search</span>: example.com</span><br><span class="line"></span><br><span class="line"><span class="attribute">dns_search:</span></span><br><span class="line"><span class="attribute">  - domain1.example.com</span></span><br><span class="line"><span class="attribute">  - domain2.example.com</span></span><br></pre></td></tr></table></figure>
<h4 id="tmpfs"><a href="#tmpfs" class="headerlink" title="tmpfs"></a><code>tmpfs</code></h4><p>挂载一个 tmpfs 文件系统到容器。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tmpfs: /<span class="keyword">run</span><span class="bash"></span></span><br><span class="line"><span class="bash">tmpfs:</span></span><br><span class="line"><span class="bash">  - /run</span></span><br><span class="line"><span class="bash">  - /tmp</span></span><br></pre></td></tr></table></figure>
<h4 id="env-file"><a href="#env-file" class="headerlink" title="env_file"></a><code>env_file</code></h4><p>从文件中获取环境变量，可以为单独的文件路径或列表，默认读当前目录<code>.env</code>。</p>
<p>如果通过 <code>docker-compose -f FILE</code> 方式来指定 Compose 模板文件，则 <code>env_file</code> 中变量的路径会<strong>基于模板文件路径</strong>。</p>
<p>如果有变量名称与 <code>environment</code> 指令冲突，则按照惯例，<strong>以后者为准</strong>。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">env_file</span>: .env</span><br><span class="line"></span><br><span class="line"><span class="attribute">env_file:</span></span><br><span class="line">  - ./common.env</span><br><span class="line">  - ./apps/web.env</span><br><span class="line">  - /opt/secrets.env</span><br></pre></td></tr></table></figure>
<p>环境变量文件中每一行必须符合格式，支持 <code>#</code> 开头的注释行。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># common.env: Set development environment</span></span><br><span class="line"><span class="attr">PROG_ENV</span>=development</span><br></pre></td></tr></table></figure>
<h4 id="environment"><a href="#environment" class="headerlink" title="environment"></a><code>environment</code></h4><p>设置环境变量。你可以使用数组或字典两种格式。</p>
<p><strong>只给定名称的变量会自动获取运行 Compose 主机上对应变量的值</strong>，<strong>可以用来防止泄露不必要的数据</strong>。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">environment:</span></span><br><span class="line"><span class="symbol">  RACK_ENV:</span> development</span><br><span class="line"><span class="symbol">  SESSION_SECRET:</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">environment:</span></span><br><span class="line">  - RACK_ENV=development</span><br><span class="line">  - SESSION_SECRET</span><br></pre></td></tr></table></figure>
<p>如果变量名称或者值中用到 <code>true|false，yes|no</code> 等表达 <a href="http://yaml.org/type/bool.html" rel="external nofollow noopener noreferrer" target="_blank">布尔</a> 含义的词汇，<strong>最好放到引号里</strong>，避免 YAML 自动解析某些内容为对应的布尔语义。这些特定词汇，包括</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">y|<span class="type">Y</span>|<span class="type">yes</span>|<span class="type">Yes</span>|<span class="type">YES</span>|<span class="type">n</span>|<span class="type">N</span>|<span class="type">no</span>|<span class="type">No</span>|<span class="type">NO</span>|<span class="type">true</span>|<span class="type">True</span>|<span class="type">TRUE</span>|<span class="type">false</span>|<span class="type">False</span>|<span class="type">FALSE</span>|<span class="type">on</span>|<span class="type">On</span>|<span class="type">ON</span>|<span class="type">off</span>|<span class="type">Off</span>|<span class="type">OFF</span></span><br></pre></td></tr></table></figure>
<h4 id="expose"><a href="#expose" class="headerlink" title="expose"></a><code>expose</code></h4><p>暴露端口，但不映射到宿主机，只被连接的服务访问。</p>
<p>仅可以指定内部端口为参数</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">expose:</span><br><span class="line"> -<span class="ruby"> <span class="string">"3000"</span></span></span><br><span class="line"><span class="ruby"> - <span class="string">"8000"</span></span></span><br></pre></td></tr></table></figure>
<h4 id="external-links"><a href="#external-links" class="headerlink" title="external_links"></a><code>external_links</code></h4><blockquote>
<p>注意：不建议使用该指令。</p>
</blockquote>
<p>链接到 <code>docker-compose.yml</code> 外部的容器，甚至并非 <code>Compose</code> 管理的外部容器。</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">external_links:</span><br><span class="line"> -<span class="ruby"> redis_1</span></span><br><span class="line"><span class="ruby"> - <span class="symbol">project_db_1:</span>mysql</span></span><br><span class="line"><span class="ruby"> - <span class="symbol">project_db_1:</span>postgresql</span></span><br></pre></td></tr></table></figure>
<h4 id="extra-hosts"><a href="#extra-hosts" class="headerlink" title="extra_hosts"></a><code>extra_hosts</code></h4><p>类似 Docker 中的 <code>--add-host</code> 参数，指定额外的 host 名称映射信息。</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">extra_hosts:</span><br><span class="line"> -<span class="ruby"> <span class="string">"googledns:8.8.8.8"</span></span></span><br><span class="line"><span class="ruby"> - <span class="string">"dockerhub:52.1.157.61"</span></span></span><br></pre></td></tr></table></figure>
<p>会在启动后的服务容器中 <code>/etc/hosts</code> 文件中添加如下两条条目。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">8<span class="selector-class">.8</span><span class="selector-class">.8</span><span class="selector-class">.8</span> <span class="selector-tag">googledns</span></span><br><span class="line">52<span class="selector-class">.1</span><span class="selector-class">.157</span><span class="selector-class">.61</span> <span class="selector-tag">dockerhub</span></span><br></pre></td></tr></table></figure>
<h4 id="healthcheck"><a href="#healthcheck" class="headerlink" title="healthcheck"></a><code>healthcheck</code></h4><p>通过命令检查容器是否健康运行。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">healthcheck:</span></span><br><span class="line"><span class="symbol">  test:</span> [<span class="string">"CMD"</span>, <span class="string">"curl"</span>, <span class="string">"-f"</span>, <span class="string">"http://localhost"</span>]</span><br><span class="line"><span class="symbol">  interval:</span> <span class="number">1</span>m30s</span><br><span class="line"><span class="symbol">  timeout:</span> <span class="number">10</span>s</span><br><span class="line"><span class="symbol">  retries:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h4 id="image"><a href="#image" class="headerlink" title="image"></a><code>image</code></h4><p>指定为镜像名称或镜像 ID。如果镜像在本地不存在，<code>Compose</code> 将会尝试拉去这个镜像。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">image</span>: ubuntu</span><br><span class="line"><span class="built_in">image</span>: orchardup/postgresql</span><br><span class="line"><span class="built_in">image</span>: a4bc65fd</span><br></pre></td></tr></table></figure>
<h4 id="labels"><a href="#labels" class="headerlink" title="labels"></a><code>labels</code></h4><p>为容器添加 Docker 元数据（metadata）信息。例如可以为容器添加辅助说明信息。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">labels:</span><br><span class="line">  com<span class="selector-class">.startupteam</span><span class="selector-class">.description</span>: <span class="string">"webapp for a startup team"</span></span><br><span class="line">  com<span class="selector-class">.startupteam</span><span class="selector-class">.department</span>: <span class="string">"devops department"</span></span><br><span class="line">  com<span class="selector-class">.startupteam</span><span class="selector-class">.release</span>: <span class="string">"rc3 for v1.0"</span></span><br></pre></td></tr></table></figure>
<h4 id="links"><a href="#links" class="headerlink" title="links"></a><code>links</code></h4><blockquote>
<p>注意：不推荐使用该指令。</p>
</blockquote>
<h4 id="logging"><a href="#logging" class="headerlink" title="logging"></a><code>logging</code></h4><p>配置日志选项。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">logging</span>:</span><br><span class="line">  <span class="attribute">driver</span>: syslog</span><br><span class="line">  <span class="attribute">options</span>:</span><br><span class="line">    <span class="attribute">syslog-address</span>: <span class="string">"tcp://192.168.0.42:123"</span></span><br></pre></td></tr></table></figure>
<p>目前支持三种日志驱动类型。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">driver:</span> <span class="string">"json-file"</span></span><br><span class="line"><span class="symbol">driver:</span> <span class="string">"syslog"</span></span><br><span class="line"><span class="symbol">driver:</span> <span class="string">"none"</span></span><br></pre></td></tr></table></figure>
<p><code>options</code> 配置日志驱动的相关参数。</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">options</span>:</span><br><span class="line">  <span class="built-in">max</span>-size: <span class="string">"200k"</span></span><br><span class="line">  <span class="built-in">max</span>-<span class="keyword">file</span>: <span class="string">"10"</span></span><br></pre></td></tr></table></figure>
<p>更多详情：<a href="https://docs.docker.com/engine/admin/logging/overview/" rel="external nofollow noopener noreferrer" target="_blank">https://docs.docker.com/engine/admin/logging/overview/</a></p>
<h4 id="network-mode"><a href="#network-mode" class="headerlink" title="network_mode"></a><code>network_mode</code></h4><p>设置网络模式。使用和 <code>docker run</code> 的 <code>--network</code> 参数一样的值。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">network_mode:</span> <span class="string">"bridge"</span></span><br><span class="line"><span class="symbol">network_mode:</span> <span class="string">"host"</span></span><br><span class="line"><span class="symbol">network_mode:</span> <span class="string">"none"</span></span><br><span class="line"><span class="symbol">network_mode:</span> <span class="string">"service:[service name]"</span></span><br><span class="line"><span class="symbol">network_mode:</span> <span class="string">"container:[container name/id]"</span></span><br></pre></td></tr></table></figure>
<h4 id="networks"><a href="#networks" class="headerlink" title="networks"></a><code>networks</code></h4><p>配置容器连接的网络。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">version</span>: <span class="string">"3"</span></span><br><span class="line"><span class="attribute">services</span>:</span><br><span class="line"></span><br><span class="line">  <span class="attribute">some-service</span>:</span><br><span class="line">    <span class="attribute">networks</span>:</span><br><span class="line">     - some-network</span><br><span class="line">     - other-network</span><br><span class="line"></span><br><span class="line"><span class="attribute">networks</span>:</span><br><span class="line">  <span class="attribute">some-network</span>:</span><br><span class="line">  <span class="attribute">other-network</span>:</span><br></pre></td></tr></table></figure>
<p>Docker 网络类型，有 <code>bridge</code> <code>overlay</code>，默认为<code>bridge</code>。其中 <code>overlay</code> 网络类型用于 <code>Swarm mode</code></p>
<h4 id="pid"><a href="#pid" class="headerlink" title="pid"></a><code>pid</code></h4><p>跟主机系统共享进程命名空间。打开该选项的容器之间，以及容器和宿主机系统之间可以通过进程 ID 来相互访问和操作。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">pid:</span> <span class="string">"host"</span></span><br></pre></td></tr></table></figure>
<h4 id="ports"><a href="#ports" class="headerlink" title="ports"></a><code>ports</code></h4><p>暴露端口信息。</p>
<p>使用宿主端口：容器端口 <code>(HOST:CONTAINER)</code> 格式，或者仅仅指定容器的端口（宿主将会随机选择端口）都可以。</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ports:</span><br><span class="line"> -<span class="ruby"> <span class="string">"3000"</span></span></span><br><span class="line"><span class="ruby"> - <span class="string">"8000:8000"</span></span></span><br><span class="line"><span class="ruby"> - <span class="string">"49100:22"</span></span></span><br><span class="line"><span class="ruby"> - <span class="string">"127.0.0.1:8001:8001"</span></span></span><br></pre></td></tr></table></figure>
<p><em>注意：当使用 HOST:CONTAINER 格式来映射端口时，如果你使用的容器端口小于 60 并且没放到引号里，可能会得到错误结果，因为 YAML 会自动解析 xx:yy 这种数字格式为 60 进制。为避免出现这种问题，建议数字串都采用引号包括起来的字符串格式。</em></p>
<h4 id="secrets"><a href="#secrets" class="headerlink" title="secrets"></a><code>secrets</code></h4><p>存储敏感数据，例如 <code>mysql</code> 服务密码。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">mysql:</span></span><br><span class="line"><span class="symbol">  image:</span> mysql</span><br><span class="line"><span class="symbol">  environment:</span></span><br><span class="line"><span class="symbol">    MYSQL_ROOT_PASSWORD_FILE:</span> <span class="meta-keyword">/run/</span>secrets/db_root_password</span><br><span class="line"><span class="symbol">  secrets:</span></span><br><span class="line">    - db_root_password</span><br><span class="line">    - my_other_secret</span><br><span class="line"></span><br><span class="line"><span class="symbol">secrets:</span></span><br><span class="line"><span class="symbol">  my_secret:</span></span><br><span class="line"><span class="symbol">    file:</span> ./my_secret.txt</span><br><span class="line"><span class="symbol">  my_other_secret:</span></span><br><span class="line"><span class="symbol">    external:</span> true</span><br></pre></td></tr></table></figure>
<h4 id="security-opt"><a href="#security-opt" class="headerlink" title="security_opt"></a><code>security_opt</code></h4><p>指定容器模板标签（label）机制的默认属性（用户、角色、类型、级别等）。例如配置标签的用户名和角色名。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">security_opt:</span><br><span class="line">    - <span class="keyword">label</span><span class="bash">:user:USER</span></span><br><span class="line"><span class="bash">    - label:role:ROLE</span></span><br></pre></td></tr></table></figure>
<h4 id="stop-signal"><a href="#stop-signal" class="headerlink" title="stop_signal"></a><code>stop_signal</code></h4><p>设置另一个信号来停止容器。在默认情况下使用的是 SIGTERM 停止容器。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">stop_signal:</span> SIGUSR1</span><br></pre></td></tr></table></figure>
<h4 id="sysctls"><a href="#sysctls" class="headerlink" title="sysctls"></a><code>sysctls</code></h4><p>配置容器内核参数。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sysctls:</span><br><span class="line">  net<span class="selector-class">.core</span><span class="selector-class">.somaxconn</span>: <span class="number">1024</span></span><br><span class="line">  net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_syncookies</span>: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">sysctls:</span><br><span class="line">  - net<span class="selector-class">.core</span><span class="selector-class">.somaxconn</span>=<span class="number">1024</span></span><br><span class="line">  - net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_syncookies</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure>
<h4 id="ulimits"><a href="#ulimits" class="headerlink" title="ulimits"></a><code>ulimits</code></h4><p>指定容器的 ulimits 限制值。</p>
<p>例如，指定最大进程数为 65535，指定文件句柄数为 20000（软限制，应用可以随时修改，不能超过硬限制） 和 40000（系统硬限制，只能 root 用户提高）。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">ulimits:</span></span><br><span class="line"><span class="symbol">  nproc:</span> <span class="number">65535</span></span><br><span class="line"><span class="symbol">  nofile:</span></span><br><span class="line"><span class="symbol">    soft:</span> <span class="number">20000</span></span><br><span class="line"><span class="symbol">    hard:</span> <span class="number">40000</span></span><br></pre></td></tr></table></figure>
<h4 id="volumes"><a href="#volumes" class="headerlink" title="volumes"></a><code>volumes</code></h4><p>数据卷所挂载路径设置。可以设置宿主机路径 （<code>HOST:CONTAINER</code>） 或加上访问模式 （<code>HOST:CONTAINER:ro</code>）。</p>
<p>该指令中路径支持相对路径。</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">volumes:</span><br><span class="line"> -<span class="ruby"> /var/lib/mysql</span></span><br><span class="line"><span class="ruby"> - cache/<span class="symbol">:/tmp/cache</span></span></span><br><span class="line"><span class="ruby"> - ~<span class="regexp">/configs:/etc</span><span class="regexp">/configs/</span><span class="symbol">:ro</span></span></span><br></pre></td></tr></table></figure>
<h4 id="其它指令"><a href="#其它指令" class="headerlink" title="其它指令"></a>其它指令</h4><p>此外，还有包括 <code>domainname, entrypoint, hostname, ipc, mac_address, privileged, read_only, shm_size, restart, stdin_open, tty, user, working_dir</code> 等指令，基本跟 <code>docker run</code> 中对应参数的功能一致。</p>
<p>指定服务容器启动后执行的入口文件。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">entrypoint</span><span class="bash">: /code/entrypoint.sh</span></span><br></pre></td></tr></table></figure>
<p>指定容器中运行应用的用户名。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">user:</span> nginx</span><br></pre></td></tr></table></figure>
<p>指定容器中工作目录。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">working_dir</span>: /<span class="meta">code</span></span><br></pre></td></tr></table></figure>
<p>指定容器中搜索域名、主机名、mac 地址等。</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">domainname: your_website.com</span><br><span class="line">hostname: test</span><br><span class="line">mac_address: 08<span class="string">-00</span><span class="string">-27</span><span class="string">-00</span><span class="string">-0</span>C<span class="string">-0</span>A</span><br></pre></td></tr></table></figure>
<p>允许容器中运行一些特权命令。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">privileged:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>指定容器退出后的重启策略为始终重启。该命令对保持服务始终运行十分有效，在生产环境中推荐配置为 <code>always</code> 或者 <code>unless-stopped</code>。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">restart:</span> always</span><br></pre></td></tr></table></figure>
<p>以只读模式挂载容器的 root 文件系统，意味着不能对容器内容进行修改。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">read_only:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>打开标准输入，可以接受外部输入。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stdin_open:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>模拟一个伪终端。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tty:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="读取变量"><a href="#读取变量" class="headerlink" title="读取变量"></a>读取变量</h4><p>Compose 模板文件支持动态读取主机的系统环境变量和当前目录下的 <code>.env</code> 文件中的变量。</p>
<p>例如，下面的 Compose 文件将从运行它的环境中读取变量 <code>${MONGO_VERSION}</code> 的值，并写入执行的指令中。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">db:</span></span><br><span class="line"><span class="symbol">  image:</span> <span class="string">"mongo:$&#123;MONGO_VERSION&#125;"</span></span><br></pre></td></tr></table></figure>
<p>如果执行 <code>MONGO_VERSION=3.2 docker-compose up</code> 则会启动一个 <code>mongo:3.2</code> 镜像的容器；如果执行 <code>MONGO_VERSION=2.8 docker-compose up</code> 则会启动一个 <code>mongo:2.8</code> 镜像的容器。</p>
<p>若当前目录存在 <code>.env</code> 文件，执行 <code>docker-compose</code> 命令时将从该文件中读取变量。</p>
<p>在当前目录新建 <code>.env</code> 文件并写入以下内容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 支持 <span class="comment"># 号注释</span></span></span><br><span class="line">MONGO_VERSION=3.6</span><br></pre></td></tr></table></figure>
<p>执行 <code>docker-compose up</code> 则会启动一个 <code>mongo:3.6</code> 镜像的容器。</p>
<p><strong>官方例子</strong>：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">  redis:</span></span><br><span class="line"><span class="symbol">    image:</span> redis:alpine</span><br><span class="line"><span class="symbol">    ports:</span></span><br><span class="line">      - <span class="string">"6379"</span></span><br><span class="line"><span class="symbol">    networks:</span></span><br><span class="line">      - frontend</span><br><span class="line"><span class="symbol">    deploy:</span></span><br><span class="line"><span class="symbol">      replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="symbol">      update_config:</span></span><br><span class="line"><span class="symbol">        parallelism:</span> <span class="number">2</span></span><br><span class="line"><span class="symbol">        delay:</span> <span class="number">10</span>s</span><br><span class="line"><span class="symbol">      restart_policy:</span></span><br><span class="line"><span class="symbol">        condition:</span> on-failure</span><br><span class="line"><span class="symbol">  db:</span></span><br><span class="line"><span class="symbol">    image:</span> postgres:<span class="number">9.4</span></span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - db-data:<span class="meta-keyword">/var/</span>lib<span class="meta-keyword">/postgresql/</span>data</span><br><span class="line"><span class="symbol">    networks:</span></span><br><span class="line">      - backend</span><br><span class="line"><span class="symbol">    deploy:</span></span><br><span class="line"><span class="symbol">      placement:</span></span><br><span class="line"><span class="symbol">        constraints:</span> [node.role == manager]</span><br><span class="line"><span class="symbol">  vote:</span></span><br><span class="line"><span class="symbol">    image:</span> dockersamples/examplevotingapp_vote:before</span><br><span class="line"><span class="symbol">    ports:</span></span><br><span class="line">      - <span class="number">5000</span>:<span class="number">80</span></span><br><span class="line"><span class="symbol">    networks:</span></span><br><span class="line">      - frontend</span><br><span class="line"><span class="symbol">    depends_on:</span></span><br><span class="line">      - redis</span><br><span class="line"><span class="symbol">    deploy:</span></span><br><span class="line"><span class="symbol">      replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="symbol">      update_config:</span></span><br><span class="line"><span class="symbol">        parallelism:</span> <span class="number">2</span></span><br><span class="line"><span class="symbol">      restart_policy:</span></span><br><span class="line"><span class="symbol">        condition:</span> on-failure</span><br><span class="line"><span class="symbol">  result:</span></span><br><span class="line"><span class="symbol">    image:</span> dockersamples/examplevotingapp_result:before</span><br><span class="line"><span class="symbol">    ports:</span></span><br><span class="line">      - <span class="number">5001</span>:<span class="number">80</span></span><br><span class="line"><span class="symbol">    networks:</span></span><br><span class="line">      - backend</span><br><span class="line"><span class="symbol">    depends_on:</span></span><br><span class="line">      - db</span><br><span class="line"><span class="symbol">    deploy:</span></span><br><span class="line"><span class="symbol">      replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="symbol">      update_config:</span></span><br><span class="line"><span class="symbol">        parallelism:</span> <span class="number">2</span></span><br><span class="line"><span class="symbol">        delay:</span> <span class="number">10</span>s</span><br><span class="line"><span class="symbol">      restart_policy:</span></span><br><span class="line"><span class="symbol">        condition:</span> on-failure</span><br><span class="line"></span><br><span class="line"><span class="symbol">  worker:</span></span><br><span class="line"><span class="symbol">    image:</span> dockersamples/examplevotingapp_worker</span><br><span class="line"><span class="symbol">    networks:</span></span><br><span class="line">      - frontend</span><br><span class="line">      - backend</span><br><span class="line"><span class="symbol">    deploy:</span></span><br><span class="line"><span class="symbol">      mode:</span> replicated</span><br><span class="line"><span class="symbol">      replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="symbol">      labels:</span> [APP=VOTING]</span><br><span class="line"><span class="symbol">      restart_policy:</span></span><br><span class="line"><span class="symbol">        condition:</span> on-failure</span><br><span class="line"><span class="symbol">        delay:</span> <span class="number">10</span>s</span><br><span class="line"><span class="symbol">        max_attempts:</span> <span class="number">3</span></span><br><span class="line"><span class="symbol">        window:</span> <span class="number">120</span>s</span><br><span class="line"><span class="symbol">      placement:</span></span><br><span class="line"><span class="symbol">        constraints:</span> [node.role == manager]</span><br><span class="line"></span><br><span class="line"><span class="symbol">  visualizer:</span></span><br><span class="line"><span class="symbol">    image:</span> dockersamples/visualizer:stable</span><br><span class="line"><span class="symbol">    ports:</span></span><br><span class="line">      - <span class="string">"8080:8080"</span></span><br><span class="line"><span class="symbol">    stop_grace_period:</span> <span class="number">1</span>m30s</span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - <span class="string">"/var/run/docker.sock:/var/run/docker.sock"</span></span><br><span class="line"><span class="symbol">    deploy:</span></span><br><span class="line"><span class="symbol">      placement:</span></span><br><span class="line"><span class="symbol">        constraints:</span> [node.role == manager]</span><br><span class="line"></span><br><span class="line"><span class="symbol">networks:</span></span><br><span class="line"><span class="symbol">  frontend:</span></span><br><span class="line"><span class="symbol">  backend:</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">volumes:</span></span><br><span class="line">  db-data:</span><br></pre></td></tr></table></figure>
<h3 id="理解多compose文件组合"><a href="#理解多compose文件组合" class="headerlink" title="理解多compose文件组合"></a>理解多compose文件组合</h3><p>默认，<code>compose</code>会读取两个文件，一个<code>docker-compose.yml</code>和一个可选的<code>docker-compose.override.yml</code>文件。通常，<code>docker-compose.yml</code>文件包含你的基本配置，而<code>docker-compose.override.yml</code>，顾名思义，就是包含的现有服务配置的覆盖内容，或完全新的配置。</p>
<p>如果一个服务在这两个文件中都有定义，那么<code>compose</code>将使用<a href="https://docs.docker.com/compose/extends/#adding-and-overriding-configuration" rel="external nofollow noopener noreferrer" target="_blank">添加和覆盖配置</a>中所描述的规则来合并服务</p>
<p>要使用多个<code>override</code>文件或不同名称的<code>override</code>文件，可以使用<code>-f</code>选项来指定文件列表。<code>compose</code><strong>根据在命令行指定的顺序来合并它们</strong>。</p>
<p>当使用多个配置文件时，必须确保文件中所有的路径都是<strong>相对于</strong><code>base compose</code>文件的(<code>-f</code> 指定的第一个<code>compose</code>文件)。这样要求是因为<code>override</code>文件不需要一个有效的<code>compose</code>文件。<code>override</code>文件可以只包含配置中的一小片段。跟踪一个服务的片段是相对于那个路径的，这是很困难的事，所以一定要保持路径容易理解，所以路径必须定义为相对于base文件的路径。</p>
<p><strong>例如</strong>，定义两个配置文件：</p>
<p><strong>docker-compose.yml</strong></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">web</span>:</span><br><span class="line">  <span class="attribute">image</span>: example/<span class="attribute">my_web_app</span>:latest</span><br><span class="line">  <span class="attribute">links</span>:</span><br><span class="line">    - db</span><br><span class="line">    - cache</span><br><span class="line"></span><br><span class="line"><span class="attribute">db</span>:</span><br><span class="line">  <span class="attribute">image</span>: <span class="attribute">postgres</span>:latest</span><br><span class="line"></span><br><span class="line"><span class="attribute">cache</span>:</span><br><span class="line">  <span class="attribute">image</span>: <span class="attribute">redis</span>:latest</span><br></pre></td></tr></table></figure>
<p><strong>docker-compose.prod.yml</strong></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">web</span>:</span><br><span class="line">  <span class="attribute">ports</span>:</span><br><span class="line">    - <span class="number">80</span>:<span class="number">80</span></span><br><span class="line">  <span class="attribute">environment</span>:</span><br><span class="line">    <span class="attribute">PRODUCTION</span>: <span class="string">'true'</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">cache</span>:</span><br><span class="line">  <span class="attribute">environment</span>:</span><br><span class="line">    <span class="attribute">TTL</span>: <span class="string">'500'</span></span><br></pre></td></tr></table></figure>
<p>要使用这个生产compose文件部署，运行如下命令：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f docker-compose<span class="selector-class">.yml</span> -f docker-compose<span class="selector-class">.prod</span><span class="selector-class">.yml</span> up -d</span><br></pre></td></tr></table></figure>
<p>这将会使用<code>docker-compose.yml</code>和<code>docker-compose.prod.yml</code>来部署这三个服务</p>
<h2 id="Docker-Machine"><a href="#Docker-Machine" class="headerlink" title="Docker Machine"></a>Docker Machine</h2><p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-machine-logo.png" alt=""></p>
<blockquote>
<p>Docker Machine 是供给和管理 docker 化主机的工具。有自己的命令行客户端 <code>docker-machine</code>。提供多种环境的 docker 主机，可以用 Docker Machine 在一个或者多个虚拟系统（本地或者远程）上安装 Docker Engine。</p>
</blockquote>
<h3 id="Install-2"><a href="#Install-2" class="headerlink" title="Install"></a>Install</h3><p>最新安装请看官方文档：<strong><em><a href="https://docs.docker.com/machine/install-machine/" rel="external nofollow noopener noreferrer" target="_blank">https://docs.docker.com/machine/install-machine/</a></em></strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">base=https:<span class="regexp">//gi</span>thub.com<span class="regexp">/docker/m</span>achine<span class="regexp">/releases/</span>download<span class="regexp">/v0.14.0 &amp;&amp; \</span></span><br><span class="line"><span class="regexp">curl -L $base/</span>docker-machine-$(uname -s)-$(uname -m) &gt;<span class="regexp">/tmp/</span>docker-machine &amp;&amp; \</span><br><span class="line">sudo install <span class="regexp">/tmp/</span>docker-machine <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>docker-machine</span><br></pre></td></tr></table></figure>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-machine-version.png" alt=""></p>
<p><strong>uninstall</strong>：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="keyword">rm</span> $(<span class="keyword">which</span> docker-machine)</span><br></pre></td></tr></table></figure>
<h3 id="Zsh命令补全-1"><a href="#Zsh命令补全-1" class="headerlink" title="Zsh命令补全"></a>Zsh命令补全</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~<span class="regexp">/.zsh/</span>completion</span><br><span class="line">curl -L https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/docker/m</span>achine<span class="regexp">/master/</span>contrib<span class="regexp">/completion/</span>zsh<span class="regexp">/_docker-machine &gt; ~/</span>.zsh<span class="regexp">/completion/</span>_docker-machine</span><br></pre></td></tr></table></figure>
<p>在<code>~/.zshrc</code>添加：</p>
<p><strong>注意</strong>：(如果是<code>oh-my-zsh</code>，在<code>$ZSH/oh-my-zsh.sh</code>中添加)</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">fpath</span>=(~/.zsh/completion <span class="variable">$fpath</span>)</span><br></pre></td></tr></table></figure>
<p>执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">autoload</span> -Uz compinit &amp;&amp; \</span><br><span class="line">compinit -i &amp;&amp; \</span><br><span class="line"><span class="built_in">exec</span> <span class="variable">$SHELL</span> -l</span><br></pre></td></tr></table></figure>
<h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><p>确保已经安装了<code>virtualbox</code>：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt <span class="keyword">install</span> virtualbox</span><br></pre></td></tr></table></figure>
<p>创建本地实例：</p>
<p>使用 <code>virtualbox</code> 类型的驱动，创建一台 Docker 主机，命名为 test。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine <span class="keyword">create</span> -d virtualbox <span class="keyword">test</span></span><br></pre></td></tr></table></figure>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-machine-create.png" alt=""></p>
<p>你也可以在创建时加上如下参数，来配置主机或者主机上的 Docker。</p>
<p><code>--engine-opt dns=114.114.114.114</code> 配置 Docker 的默认 DNS</p>
<p><code>--engine-registry-mirror https://registry.docker-cn.com</code> 配置 Docker 的仓库镜像</p>
<p><code>--engine-insecure-registry</code> 可以使用http的仓库</p>
<p><code>--virtualbox-memory 2048</code> 配置主机内存</p>
<p><code>--virtualbox-cpu-count 2</code> 配置主机 CPU</p>
<p>更多参数请使用 <code>docker-machine create --driver virtualbox --help</code> 命令查看。</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine create --driver virtualbox --help</span><br><span class="line">Usage: docker-machine create [OPTIONS] [arg...]</span><br><span class="line"></span><br><span class="line">Create a machine.</span><br><span class="line"></span><br><span class="line">Run 'docker-machine create --driver name' to include the create flags for that driver in the help text.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line"></span><br><span class="line">   -<span class="ruby">-driver, -d <span class="string">"none"</span>                                                                                  Driver to create machine with.</span></span><br><span class="line"><span class="ruby">   --engine-env [--engine-env option --engine-env option]                                               Specify environment variables to set <span class="keyword">in</span> the engine</span></span><br><span class="line"><span class="ruby">   --engine-insecure-registry [--engine-insecure-registry option --engine-insecure-registry option]     Specify insecure registries to allow with the created engine</span></span><br><span class="line"><span class="ruby">   --engine-install-url <span class="string">"https://get.docker.com"</span>                                                        Custom URL to use <span class="keyword">for</span> engine installation [$MACHINE_DOCKER_INSTALL_URL]</span></span><br><span class="line"><span class="ruby">   --engine-label [--engine-label option --engine-label option]                                         Specify labels <span class="keyword">for</span> the created engine</span></span><br><span class="line"><span class="ruby">   --engine-opt [--engine-opt option --engine-opt option]                                               Specify arbitrary flags to <span class="keyword">include</span> with the created engine <span class="keyword">in</span> the form flag=value</span></span><br><span class="line"><span class="ruby">   --engine-registry-mirror [--engine-registry-mirror option --engine-registry-mirror option]           Specify registry mirrors to use [$ENGINE_REGISTRY_MIRROR]</span></span><br><span class="line"><span class="ruby">   --engine-storage-driver                                                                              Specify a storage driver to use with the engine</span></span><br><span class="line"><span class="ruby">   --swarm                                                                                              Configure Machine with Swarm</span></span><br><span class="line"><span class="ruby">   --swarm-addr                                                                                         addr to advertise <span class="keyword">for</span> Swarm (<span class="symbol">default:</span> detect <span class="keyword">and</span> use the machine IP)</span></span><br><span class="line"><span class="ruby">   --swarm-discovery                                                                                    Discovery service to use with Swarm</span></span><br><span class="line"><span class="ruby">   --swarm-experimental                                                                                 Enable Swarm experimental features</span></span><br><span class="line"><span class="ruby">   --swarm-host <span class="string">"tcp://0.0.0.0:3376"</span>                                                                    ip/socket to listen on <span class="keyword">for</span> Swarm master</span></span><br><span class="line"><span class="ruby">   --swarm-image <span class="string">"swarm:latest"</span>                                                                         Specify Docker image to use <span class="keyword">for</span> Swarm [$MACHINE_SWARM_IMAGE]</span></span><br><span class="line"><span class="ruby">   --swarm-master                                                                                       Configure Machine to be a Swarm master</span></span><br><span class="line"><span class="ruby">   --swarm-opt [--swarm-opt option --swarm-opt option]                                                  Define arbitrary flags <span class="keyword">for</span> swarm</span></span><br><span class="line"><span class="ruby">   --swarm-strategy <span class="string">"spread"</span>                                                                            Define a default scheduling strategy <span class="keyword">for</span> Swarm</span></span><br><span class="line"><span class="ruby">   --virtualbox-boot2docker-url                                                                         The URL of the boot2docker image. Defaults to the latest available version [$VIRTUALBOX_BOOT2DOCKER_URL]</span></span><br><span class="line"><span class="ruby">   --virtualbox-cpu-count <span class="string">"1"</span>                                                                           number of CPUs <span class="keyword">for</span> the machine (-<span class="number">1</span> to use the number of CPUs available) [$VIRTUALBOX_CPU_COUNT]</span></span><br><span class="line"><span class="ruby">   --virtualbox-disk-size <span class="string">"20000"</span>                                                                       Size of disk <span class="keyword">for</span> host <span class="keyword">in</span> MB [$VIRTUALBOX_DISK_SIZE]</span></span><br><span class="line"><span class="ruby">   --virtualbox-host-dns-resolver                                                                       Use the host DNS resolver [$VIRTUALBOX_HOST_DNS_RESOLVER]</span></span><br><span class="line"><span class="ruby">   --virtualbox-dns-proxy                                                                               Proxy all DNS requests to the host [$VIRTUALBOX_DNS_PROXY]</span></span><br><span class="line"><span class="ruby">   --virtualbox-hostonly-cidr <span class="string">"192.168.99.1/24"</span>                                                         Specify the Host Only CIDR [$VIRTUALBOX_HOSTONLY_CIDR]</span></span><br><span class="line"><span class="ruby">   --virtualbox-hostonly-nicpromisc <span class="string">"deny"</span>                                                              Specify the Host Only Network Adapter Promiscuous Mode [$VIRTUALBOX_HOSTONLY_NIC_PROMISC]</span></span><br><span class="line"><span class="ruby">   --virtualbox-hostonly-nictype <span class="string">"82540EM"</span>                                                              Specify the Host Only Network Adapter Type [$VIRTUALBOX_HOSTONLY_NIC_TYPE]</span></span><br><span class="line"><span class="ruby">   --virtualbox-import-boot2docker-vm                                                                   The name of a Boot2Docker VM to import</span></span><br><span class="line"><span class="ruby">   --virtualbox-memory <span class="string">"1024"</span>                                                                           Size of memory <span class="keyword">for</span> host <span class="keyword">in</span> MB [$VIRTUALBOX_MEMORY_SIZE]</span></span><br><span class="line"><span class="ruby">   --virtualbox-no-share                                                                                Disable the mount of your home directory</span></span><br></pre></td></tr></table></figure>
<p>创建好主机之后，查看主机</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-machine ls</span><br><span class="line"></span><br><span class="line">NAME      ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER       ERRORS</span><br><span class="line"><span class="keyword">test      </span>-        virtualbox   Running   tcp://192.168.99.187:2376           v17.10.0-ce</span><br></pre></td></tr></table></figure>
<p>创建主机成功后，可以通过 <code>env</code> 命令来让后续操作对象都是目标主机。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine env <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<p>后续根据提示在命令行输入命令之后就可以操作 test 主机。</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-machine-env.png" alt=""></p>
<p>通过以下命令恢复当前环境：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine <span class="keyword">env</span> -u</span><br></pre></td></tr></table></figure>
<p>也可以通过 <code>SSH</code> 登录到主机。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine ssh <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<p>连接到主机之后你就可以在其上使用 Docker 了。</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-machine-ssh.png" alt=""></p>
<p><strong>操作命令</strong></p>
<ul>
<li><code>active</code> 查看活跃的 Docker 主机</li>
<li><code>config</code> 输出连接的配置信息</li>
<li><code>create</code> 创建一个 Docker 主机</li>
<li><code>env</code> 显示连接到某个主机需要的环境变量</li>
<li><code>inspect</code> 输出主机更多信息</li>
<li><code>ip</code> 获取主机地址</li>
<li><code>kill</code> 停止某个主机</li>
<li><code>ls</code> 列出所有管理的主机</li>
<li><code>provision</code> 重新设置一个已存在的主机</li>
<li><code>regenerate-certs</code> 为某个主机重新生成 TLS 认证信息</li>
<li><code>restart</code> 重启主机</li>
<li><code>rm</code> 删除某台主机</li>
<li><code>ssh</code> SSH 到主机上执行命令</li>
<li><code>scp</code> 在主机之间复制文件</li>
<li><code>mount</code> 挂载主机目录到本地</li>
<li><code>start</code> 启动一个主机</li>
<li><code>status</code> 查看主机状态</li>
<li><code>stop</code> 停止一个主机</li>
<li><code>upgrade</code> 更新主机 Docker 版本为最新</li>
<li><code>url</code> 获取主机的 URL</li>
<li><code>version</code> 输出 docker-machine 版本信息</li>
<li><code>help</code> 输出帮助信息</li>
</ul>
<p>每个命令，又带有不同的参数，可以通过</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker-machine COMMAND --<span class="built_in">help</span></span></span><br></pre></td></tr></table></figure>
<p>来查看具体的用法。</p>
<p><strong>注意：</strong>docker-machine 安装的 Docker 在 <code>/etc/systemd/system</code> 目录下多出了一个 Docker 相关的目录：<code>docker.service.d</code>。这个目录中只有一个文件 <code>10-machine.conf</code>，这个配置文件至关重要，因为它会覆盖 Docker 默认安装时的配置文件，从而以 Docker Machine 指定的方式启动 Docker daemon。至此我们有了一个可以被远程访问的 Docker daemon。</p>
<h3 id="使用KVM引擎启动"><a href="#使用KVM引擎启动" class="headerlink" title="使用KVM引擎启动"></a>使用KVM引擎启动</h3><p><strong><em><a href="https://github.com/dhiltgen/docker-machine-kvm" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/dhiltgen/docker-machine-kvm</a></em></strong></p>
<p>首先确保安装了KVM：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt <span class="keyword">install </span>libvirt-<span class="keyword">bin </span>qemu-kvm</span><br></pre></td></tr></table></figure>
<p>到 <strong><em><a href="https://github.com/dhiltgen/docker-machine-kvm/releases" rel="external nofollow noopener noreferrer" target="_blank">Release</a></em></strong> 页面下载相关驱动。</p>
<p>Ubuntu 16.04:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L https:<span class="regexp">//gi</span>thub.com<span class="regexp">/dhiltgen/</span>docker-machine-kvm<span class="regexp">/releases/</span>download<span class="regexp">/v0.10.0/</span>docker-machine-driver-kvm-ubuntu16.<span class="number">04</span> &gt; <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>docker-machine-driver-kvm &amp;&amp; sudo chmod +x <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>docker-machine-driver-kvm</span><br></pre></td></tr></table></figure>
<p>最后启动：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine create -d kvm <span class="attribute">--engine-registry-mirror</span>=https://vioqnt8w.mirror.aliyuncs.com  <span class="attribute">--engine-insecure-registry</span>=192.168.122.213 test01</span><br></pre></td></tr></table></figure>
<h2 id="Swarm-Mode"><a href="#Swarm-Mode" class="headerlink" title="Swarm Mode"></a>Swarm Mode</h2><blockquote>
<p> Docker 1.12 <a href="https://docs.docker.com/engine/swarm/" rel="external nofollow noopener noreferrer" target="_blank">Swarm mode</a> 已经内嵌入 Docker 引擎，成为了 docker 子命令 <code>docker swarm</code>。请注意与旧的 <code>Docker Swarm</code> 区分开来。</p>
<p> <code>Swarm mode</code> 内置 kv 存储功能，提供了众多的新特性，比如：具有容错能力的去中心化设计、内置服务发现、负载均衡、路由网格、动态伸缩、滚动更新、安全传输等。使得 Docker 原生的 <code>Swarm</code> 集群具备与 Mesos、Kubernetes 竞争的实力。</p>
</blockquote>
<h3 id="功能特点"><a href="#功能特点" class="headerlink" title="功能特点"></a>功能特点</h3><h4 id="与Docker-Engine集成的集群管理"><a href="#与Docker-Engine集成的集群管理" class="headerlink" title="与Docker Engine集成的集群管理"></a>与Docker Engine集成的集群管理</h4><p>使用Docker Engine CLI创建一组Docker引擎，您可以在其中部署应用程序服务。您不需要其他编排软件来创建或管理群集。</p>
<h4 id="节点分散式设计"><a href="#节点分散式设计" class="headerlink" title="节点分散式设计"></a>节点分散式设计</h4><p>Docker Engine不是在部署时处理节点角色之间的差异，而是在运行时处理角色变化。您可以使用Docker Engine部署两种类型的节点，管理节点和工作节点。这意味着您可以从单个服务器构建整个群集。</p>
<h4 id="声明性服务模型"><a href="#声明性服务模型" class="headerlink" title="声明性服务模型"></a>声明性服务模型</h4><p>Docker Engine使用声明性方法来定义应用程序堆栈中各种服务的所需状态。例如，您可以描述由具有消息队列服务和数据库后端的Web前端服务组成的应用程序。</p>
<h4 id="可扩容与缩放容器"><a href="#可扩容与缩放容器" class="headerlink" title="可扩容与缩放容器"></a>可扩容与缩放容器</h4><p>对于每个服务，您可以声明要运行的任务数。当您向上或向下缩放时，swarm管理器通过添加或删除任务来自动适应，以保持所需的任务数量来保证集群的可靠状态。</p>
<h4 id="容器容错状态协调"><a href="#容器容错状态协调" class="headerlink" title="容器容错状态协调"></a>容器容错状态协调</h4><p>群集管理器节点不断监视群集状态，并协调您表示的期望状态的实际状态之间的任何差异。例如，如果设置一个服务以运行容器的10个副本，并且托管其中两个副本的工作程序计算机崩溃，则管理器将创建两个新副本以替换崩溃的副本。 swarm管理器将新副本分配给正在运行和可用的worker节点上。</p>
<h4 id="多主机网络"><a href="#多主机网络" class="headerlink" title="多主机网络"></a>多主机网络</h4><p>您可以为服务指定覆盖网络。当swarm管理器初始化或更新应用程序时，它会自动为覆盖网络上的容器分配地址。</p>
<h4 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h4><p>Swarm管理器节点为swarm中的每个服务分配唯一的DNS名称，并负载平衡运行的容器。您可以通过嵌入在swarm中的DNS服务器查询在群中运行的每个容器。</p>
<h4 id="负载平衡"><a href="#负载平衡" class="headerlink" title="负载平衡"></a>负载平衡</h4><p>您可以将服务的端口公开给外部负载平衡器。在内部，swarm允许您指定如何在节点之间分发服务容器。</p>
<h4 id="缺省安全"><a href="#缺省安全" class="headerlink" title="缺省安全"></a>缺省安全</h4><p>群中的每个节点强制执行TLS相互验证和加密，以保护其自身与所有其他节点之间的通信。您可以选择使用自签名根证书或来自自定义根CA的证书。</p>
<h4 id="滚动更新"><a href="#滚动更新" class="headerlink" title="滚动更新"></a>滚动更新</h4><p>在已经运行期间，您可以增量地应用服务更新到节点。 swarm管理器允许您控制将服务部署到不同节点集之间的延迟。如果出现任何问题，您可以将任务回滚到服务的先前版本。</p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h4><p>运行 Docker 的主机可以主动初始化一个 <code>Swarm</code> 集群或者加入一个已存在的 <code>Swarm</code> 集群，这样这个运行 Docker 的主机就成为一个 <code>Swarm</code> 集群的节点 (<code>node</code>) 。</p>
<p>节点分为管理 (<code>manager</code>) 节点和工作 (<code>worker</code>) 节点。</p>
<p>管理节点用于 <code>Swarm</code> 集群的管理，<code>docker swarm</code> 命令基本只能在管理节点执行（节点退出集群命令 <code>docker swarm leave</code> 可以在工作节点执行）。一个 <code>Swarm</code> 集群可以有多个管理节点，但只有一个管理节点可以成为 <code>leader</code>，<code>leader</code> 通过 <code>raft</code> 协议实现。</p>
<p>工作节点是任务执行节点，管理节点将服务 (<code>service</code>) 下发至工作节点执行。管理节点默认也作为工作节点。你也可以通过配置让服务只运行在管理节点。</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/swarm-diagram.png" alt=""></p>
<h4 id="服务和任务"><a href="#服务和任务" class="headerlink" title="服务和任务"></a>服务和任务</h4><p>任务 （<code>Task</code>）是 <code>Swarm</code> 中的最小的调度单位，目前来说就是一个单一的容器。</p>
<p>服务 （<code>Services</code>） 是指一组任务的集合，服务定义了任务的属性。服务有两种模式：</p>
<ul>
<li><code>replicated services</code> 按照一定规则在各个工作节点上运行指定个数的任务。</li>
<li><code>global services</code> 每个工作节点上运行一个任务</li>
</ul>
<p>两种模式通过 <code>docker service create</code> 的 <code>--mode</code> 参数指定。</p>
<p><strong>下图解释服务、任务、容器：</strong></p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/services-diagram.png" alt=""></p>
<p><strong>服务的任务及调试说明：</strong></p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-swarm-task.png" alt=""></p>
<p><strong>服务部署的复制模式和全局模式说明：</strong></p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-swarm-net.png" alt=""></p>
<h3 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h3><p>在创建集群前，如果开启了防火墙，请确认三台主机的防火墙能让swarm需求的端口开放，需要打开主机之间的端口，以下端口必须可用。在某些系统上，这些端口默认为打开。<br><strong>2377</strong>：TCP端口2377用于集群管理通信<br><strong>7946</strong>：TCP和UDP端口7946用于节点之间的通信<br><strong>4789</strong>：TCP和UDP端口4789用于覆盖网络流量<br>如果您计划使用加密（–opt加密）创建覆盖网络，则还需要确保协议50（ESP）已打开。</p>
<p>docker swarm命令：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init --advertise-addr 172.18.60.133</span><br><span class="line"></span><br><span class="line"><span class="comment">#恢复</span></span><br><span class="line">docker swarm init --advertise-addr 172.18.60.133 --force-new-cluster</span><br><span class="line"></span><br><span class="line"><span class="comment">#其它节点加入</span></span><br><span class="line">docker swarm join --token \</span><br><span class="line">     SWMTKN-1-44gjumnutrh4k9lls54f5hp43kiioxf16iuh7qarjfqjsu7jio-2326b8ikb1xiysm3i7neh9nho 172.18.60.133:2377</span><br><span class="line">     </span><br><span class="line"><span class="comment">#输出可以用来以worker角色加入的token</span></span><br><span class="line">docker swarm join-token worker</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出可以用来以manager角色加入的token</span></span><br><span class="line">docker swarm join-token manager</span><br><span class="line"></span><br><span class="line"><span class="comment">#manager节点强制脱离</span></span><br><span class="line">docker swarm leave --force</span><br><span class="line"></span><br><span class="line"><span class="comment">#worker节点脱离</span></span><br><span class="line">docker swarm leave</span><br><span class="line"></span><br><span class="line"><span class="comment">#节点从swarm中移除</span></span><br><span class="line">docker node rm XXXXX</span><br><span class="line"></span><br><span class="line"><span class="comment">#worker节点提升为manager</span></span><br><span class="line">docker node promote ilog2</span><br><span class="line"></span><br><span class="line"><span class="comment">#恢复为worker</span></span><br><span class="line">docker node demote &lt;NODE&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建服务</span></span><br><span class="line">docker<span class="built_in"> service </span>create --replicas 3 --name helloworld alpine<span class="built_in"> ping </span>docker.com</span><br></pre></td></tr></table></figure>
<h3 id="节点管理"><a href="#节点管理" class="headerlink" title="节点管理"></a>节点管理</h3><h4 id="查看集群中的docker信息"><a href="#查看集群中的docker信息" class="headerlink" title="查看集群中的docker信息"></a>查看集群中的docker信息</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">docker</span> <span class="selector-tag">-H</span> 10<span class="selector-class">.0</span><span class="selector-class">.11</span><span class="selector-class">.150</span><span class="selector-pseudo">:2376</span> <span class="selector-tag">info</span></span><br></pre></td></tr></table></figure>
<h4 id="列出节点"><a href="#列出节点" class="headerlink" title="列出节点"></a>列出节点</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">node</span> <span class="title">ls</span></span><br></pre></td></tr></table></figure>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/docker-node-ls.png" alt=""></p>
<p>说明：<br><strong>AVAILABILITY列</strong>：<br>显示调度程序是否可以将任务分配给节点：</p>
<ul>
<li><code>Active</code> 意味着调度程序可以将任务分配给节点。</li>
<li><code>Pause</code> 意味着调度程序不会将新任务分配给节点，但现有任务仍在运行。</li>
<li><code>Drain</code> 意味着调度程序不会向节点分配新任务。调度程序关闭所有现有任务并在可用节点上调度它们。</li>
</ul>
<p><strong>MANAGER STATUS列</strong><br>显示节点是属于manager或者worker</p>
<ul>
<li><strong>没有值</strong> 表示不参与群管理的工作节点。</li>
<li><code>Leader</code> 意味着该节点是使得群的所有群管理和编排决策的主要管理器节点。</li>
<li><code>Reachable</code> 意味着节点是管理者节点正在参与Raft共识。如果领导节点不可用，则该节点有资格被选为新领导者。</li>
<li><code>Unavailable</code> 意味着节点是不能与其他管理器通信的管理器。如果管理器节点不可用，您应该将新的管理器节点加入群集，或者将工作器节点升级为管理器。</li>
</ul>
<h4 id="查看节点的详细信息"><a href="#查看节点的详细信息" class="headerlink" title="查看节点的详细信息"></a>查看节点的详细信息</h4><p>您可以在管理器节点上运行<code>docker node inspect</code>来查看单个节点的详细信息。 输出默认为JSON格式，但您可以传递<code>–pretty</code>标志以以可读的yml格式打印结果</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ybd @ ybd-PC in ~ [9:37:23] </span></span><br><span class="line"><span class="string">$</span> <span class="string">docker</span> <span class="string">node</span> <span class="string">inspect</span> <span class="bullet">--pretty</span> <span class="string">ybd-machine1</span> </span><br><span class="line"><span class="attr">ID:</span>			<span class="string">f917bibevklfp3xjsjoyx2g2t</span></span><br><span class="line"><span class="attr">Hostname:</span>              	<span class="string">ybd-machine1</span></span><br><span class="line"><span class="string">Joined</span> <span class="attr">at:</span>             	<span class="number">2018</span><span class="bullet">-01</span><span class="bullet">-03</span> <span class="number">10</span><span class="string">:00:28.499769713</span> <span class="string">+0000</span> <span class="string">utc</span></span><br><span class="line"><span class="attr">Status:</span></span><br><span class="line"><span class="attr"> State:</span>			<span class="string">Ready</span></span><br><span class="line"><span class="attr"> Availability:</span>         	<span class="string">Active</span></span><br><span class="line"><span class="attr"> Address:</span>		<span class="number">192.168</span><span class="number">.6</span><span class="number">.113</span></span><br><span class="line"><span class="attr">Platform:</span></span><br><span class="line"> <span class="string">Operating</span> <span class="attr">System:</span>	<span class="string">linux</span></span><br><span class="line"><span class="attr"> Architecture:</span>		<span class="string">x86_64</span></span><br><span class="line"><span class="attr">Resources:</span></span><br><span class="line"><span class="attr"> CPUs:</span>			<span class="number">1</span></span><br><span class="line"><span class="attr"> Memory:</span>		<span class="number">995.9</span><span class="string">MiB</span></span><br><span class="line"><span class="attr">Plugins:</span></span><br><span class="line"><span class="attr"> Log:</span>		<span class="string">awslogs,</span> <span class="string">fluentd,</span> <span class="string">gcplogs,</span> <span class="string">gelf,</span> <span class="string">journald,</span> <span class="string">json-file,</span> <span class="string">logentries,</span> <span class="string">splunk,</span> <span class="string">syslog</span></span><br><span class="line"><span class="attr"> Network:</span>		<span class="string">bridge,</span> <span class="string">host,</span> <span class="string">macvlan,</span> <span class="literal">null</span><span class="string">,</span> <span class="string">overlay</span></span><br><span class="line"><span class="attr"> Volume:</span>		<span class="string">local</span></span><br><span class="line"><span class="string">Engine</span> <span class="attr">Version:</span>		<span class="number">17.12</span><span class="number">.0</span><span class="bullet">-ce</span></span><br><span class="line"><span class="string">Engine</span> <span class="attr">Labels:</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">provider=virtualbox</span></span><br><span class="line"><span class="string">TLS</span> <span class="attr">Info:</span></span><br><span class="line"><span class="attr"> TrustRoot:</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">----BEGIN</span> <span class="string">CERTIFICATE-----</span></span><br><span class="line"><span class="string">MIIBajCCARCgAwIBAgIUTdhfszkLcL0IC92X4TaOWbQlbZAwCgYIKoZIzj0EAwIw</span></span><br><span class="line"><span class="string">EzERMA8GA1UEAxMIc3dhcm0tY2EwHhcNMTcxMjIyMDg0NzAwWhcNMzcxMjE3MDg0</span></span><br><span class="line"><span class="string">NzAwWjATMREwDwYDVQQDEwhzd2FybS1jYTBZMBMGByqGSM49AgEGCCqGSM49AwEH</span></span><br><span class="line"><span class="string">A0IABEWabJlpAGjNi6x8QWGXnMUFwPe27anM5nHwLX8y05TbgamYvV7Is4CZ1BbU</span></span><br><span class="line"><span class="string">ypJ/a9FpSp4FbV/6iYveIwwaHLSjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMB</span></span><br><span class="line"><span class="string">Af8EBTADAQH/MB0GA1UdDgQWBBR1K7f/HuhGDD2gzDeejaH2r8ZxIzAKBggqhkjO</span></span><br><span class="line"><span class="string">PQQDAgNIADBFAiEApL0o/FwwzLrhalYddR+buFHg0Hg3jKh37t00TmMU7SICIAOz</span></span><br><span class="line"><span class="string">YZNcngOkQiY2K2poQqRw+dFU9xOk543G+zDHqX4h</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">----END</span> <span class="string">CERTIFICATE-----</span></span><br><span class="line"></span><br><span class="line"> <span class="string">Issuer</span> <span class="attr">Subject:</span>	<span class="string">MBMxETAPBgNVBAMTCHN3YXJtLWNh</span></span><br><span class="line"> <span class="string">Issuer</span> <span class="string">Public</span> <span class="attr">Key:</span>	<span class="string">MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAERZpsmWkAaM2LrHxBYZecxQXA97btqczmcfAtfzLTlNuBqZi9XsizgJnUFtTKkn9r0WlKngVtX/qJi94jDBoctA==</span></span><br></pre></td></tr></table></figure>
<h4 id="更新节点"><a href="#更新节点" class="headerlink" title="更新节点"></a>更新节点</h4><p>Usage:    docker node update [OPTIONS] NODE</p>
<p>Options:<br>      –availability string   Availability of the node (“active”|”pause”|”drain”)<br>      –label-add list        Add or update a node label (key=value)<br>      –label-rm list         Remove a node label if exists<br>      –role string           Role of the node (“worker”|”manager”)</p>
<h4 id="升级或降级节点"><a href="#升级或降级节点" class="headerlink" title="升级或降级节点"></a>升级或降级节点</h4><p>您可以将工作程序节点提升为manager角色。这在管理器节点不可用或者您希望使管理器脱机以进行维护时很有用。 类似地，您可以将管理器节点降级为worker角色。<br>无论您升级或降级节点，您应该始终在群中维护<strong>奇数个</strong>管理器节点。<br>要升级一个节点或一组节点，请从管理器节点运行：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">node</span> <span class="title">promote</span> [<span class="keyword">NODE</span><span class="title">]</span></span><br><span class="line"><span class="title">docker</span> <span class="keyword">node</span> <span class="title">domote</span> [<span class="keyword">NODE</span><span class="title">]</span></span><br></pre></td></tr></table></figure>
<h4 id="退出docker-swarm集群"><a href="#退出docker-swarm集群" class="headerlink" title="退出docker swarm集群"></a>退出docker swarm集群</h4><p>work节点：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker swarm leave</span></span><br></pre></td></tr></table></figure>
<p>manager节点：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker swarm leave -f</span></span><br></pre></td></tr></table></figure>
<h3 id="可视化visualizer服务"><a href="#可视化visualizer服务" class="headerlink" title="可视化visualizer服务"></a>可视化visualizer服务</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker<span class="built_in"> service </span>create \</span><br><span class="line"><span class="attribute">--name</span>=viz \</span><br><span class="line"><span class="attribute">--publish</span>=8088:8080/tcp \</span><br><span class="line"><span class="attribute">--constraint</span>=node.role==manager \</span><br><span class="line"><span class="attribute">--mount</span>=type=bind,src=/var/run/docker.sock,dst=/var/run/docker.sock \</span><br><span class="line">dockersamples/visualizer</span><br></pre></td></tr></table></figure>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/visualizer.png" alt=""></p>
<h3 id="Service用法"><a href="#Service用法" class="headerlink" title="Service用法"></a>Service用法</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">创建服务</span><br><span class="line">docker<span class="built_in"> service </span>create \</span><br><span class="line">--image nginx \</span><br><span class="line">--replicas 2 \</span><br><span class="line">nginx</span><br><span class="line"> </span><br><span class="line">更新服务</span><br><span class="line">docker<span class="built_in"> service </span>update \</span><br><span class="line">--image nginx:alpine \</span><br><span class="line">nginx</span><br><span class="line"> </span><br><span class="line">删除服务</span><br><span class="line">docker<span class="built_in"> service </span>rm nginx</span><br><span class="line"> </span><br><span class="line">减少服务实例(这比直接删除服务要好)</span><br><span class="line">docker<span class="built_in"> service </span>scale <span class="attribute">nginx</span>=0</span><br><span class="line"> </span><br><span class="line">增加服务实例</span><br><span class="line">docker<span class="built_in"> service </span>scale <span class="attribute">nginx</span>=5</span><br><span class="line"> </span><br><span class="line">查看所有服务</span><br><span class="line">docker<span class="built_in"> service </span>ls</span><br><span class="line"> </span><br><span class="line">查看服务的容器状态</span><br><span class="line">docker<span class="built_in"> service </span>ps nginx</span><br><span class="line"> </span><br><span class="line">查看服务的详细信息。</span><br><span class="line">docker<span class="built_in"> service </span>inspect nginx</span><br></pre></td></tr></table></figure>
<p><strong>实现零宕机部署也非常简单。</strong>这样也可以方便地实现持续部署:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">构建新镜像</span><br><span class="line">docker build -t hub.docker.com/image .</span><br><span class="line"> </span><br><span class="line">将新镜像上传到Docker仓库</span><br><span class="line">docker push hub.docker.com/image</span><br><span class="line"> </span><br><span class="line">更新服务的镜像</span><br><span class="line">docker<span class="built_in"> service </span>update --image hub.docker.com/image service</span><br></pre></td></tr></table></figure>
<p><strong>更新服务要慎重</strong>。 你的容器同时运行在多个主机上。更新服务时，只需要更新Docker镜像。合理的测试和部署流程是保证成功的关键。<strong>Swarm非常容易入门</strong>。分布式系统通常是非常复杂的。与其他容器集群系统(Mesos, Kubernetes)相比，Swarm的学习曲线<strong>最低</strong>。</p>
<h1 id="Docker-Visual-Management"><a href="#Docker-Visual-Management" class="headerlink" title="Docker Visual Management"></a>Docker Visual Management</h1><h2 id="Rancher"><a href="#Rancher" class="headerlink" title="Rancher"></a>Rancher</h2><p><a href="http://rancher.com/" rel="external nofollow noopener noreferrer" target="_blank"><strong><em>官方网站</em></strong></a></p>
<p>如果是对集群管理并且管理员只限制Docker命令权限的话，建议用这个工具，商店用起来都比较方便，</p>
<p><strong>优点</strong>：界面中文化，操作简单易懂,功能强大,容灾机制。</p>
<p><strong>缺点</strong>: 不能团队分配权限，容器操作权限太大没法满足需求，部署时相应的Docker 服务也很多，需要逐一去了解容器作用。</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/rancher.png" alt=""></p>
<h2 id="Shipyard"><a href="#Shipyard" class="headerlink" title="Shipyard"></a>Shipyard</h2><p><a href="https://shipyard-project.com/" rel="external nofollow noopener noreferrer" target="_blank"><strong><em>官方网站</em></strong></a></p>
<p>Shipyard是在Docker Swarm的基础上，管理Docker资源，包括容器，镜像，注册表等。</p>
<p><strong>优点</strong>：</p>
<ol>
<li>支持镜像管理、容器管理。</li>
<li>支持控制台命令</li>
<li>容器资源消耗监控</li>
<li>支持集群swarm，可以随意增加节点</li>
<li>支持控制用户管理权限，可以设置某个容器对某个用户只读、管理权限。</li>
<li>有汉化版</li>
</ol>
<p><strong>缺点</strong> ：</p>
<ol>
<li>启动容器较多，占用每个节点的一部分资源</li>
</ol>
<p>部署：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL <span class="string">https:</span><span class="comment">//shipyard-project.com/deploy | bash -s</span></span><br></pre></td></tr></table></figure>
<p>注意：这将在端口2375上暴露Docker Engine。如果此节点可以在安全网络之外访问，建议使用TLS。</p>
<p>支持集群，所以可以添加节点：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://shipyard-project.com/deploy | <span class="attr">ACTION=</span><span class="keyword">node</span> <span class="title">DISCOVERY</span>=etcd://<span class="number">10.0</span>.<span class="number">0.10</span>:<span class="number">4001</span> bash -s</span><br></pre></td></tr></table></figure>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/shipyard-download.png" alt=""></p>
<p>它会下载并启动7个镜像：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/shipyard-need-containers.png" alt=""></p>
<p>界面：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/shipyard-containers.png" alt=""></p>
<p>容器信息：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/shipyard-container-info.png" alt=""></p>
<p>初体验来说，感觉跟下面的Portainer功能差不多，但是Registry总是添加失败</p>
<h2 id="Portainer"><a href="#Portainer" class="headerlink" title="Portainer"></a>Portainer</h2><p><a href="https://portainer.io/" rel="external nofollow noopener noreferrer" target="_blank"><strong><em>官方网站</em></strong></a></p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/portainer-demo.gif" alt=""></p>
<p><code>Portainer</code>是<code>Docker</code>的图形化管理工具，提供状态显示面板、应用模板快速部署、容器镜像网络数据卷的基本操作（包括上传下载镜像，创建容器等操作）、事件日志显示、容器控制台操作、<code>Swarm</code>集群和服务等集中管理和操作、登录用户管理和控制等功能。功能十分全面，基本能满足中小型单位对容器管理的全部需求。</p>
<p><strong>优点</strong></p>
<ol>
<li>支持容器管理、镜像管理</li>
<li>轻量级，消耗资源少</li>
<li>基于docker api，安全性高，可指定docker api端口，支持TLS证书认证。</li>
<li>支持权限分配</li>
<li>支持集群</li>
</ol>
<p><strong>缺点</strong></p>
<ol>
<li>功能不够强大。</li>
<li>容器创建后，无法通过后台增加端口。</li>
<li>没有容灾机制</li>
</ol>
<p>单机启动：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 9000:9000 \</span><br><span class="line">-<span class="ruby">-name portainer \</span></span><br><span class="line"><span class="ruby">--restart=always \</span></span><br><span class="line"><span class="ruby">-v /var/run/docker.<span class="symbol">sock:</span>/var/run/docker.sock \</span></span><br><span class="line"><span class="ruby">portainer/portainer</span></span><br></pre></td></tr></table></figure>
<p>swarm模式启动：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker service create \</span><br><span class="line">-<span class="ruby">-name portainer \</span></span><br><span class="line"><span class="ruby">--publish <span class="number">9000</span><span class="symbol">:</span><span class="number">9000</span> \</span></span><br><span class="line"><span class="ruby">--constraint <span class="string">'node.role == manager'</span> \</span></span><br><span class="line"><span class="ruby">--mount type=bind,src=<span class="regexp">/var/run</span><span class="regexp">/docker.sock,dst=/var</span><span class="regexp">/run/docker</span>.sock \</span></span><br><span class="line"><span class="ruby">--mount type=bind,src=<span class="regexp">/path/on</span><span class="regexp">/host/data</span>,dst=<span class="regexp">/data \</span></span></span><br><span class="line"><span class="ruby">portainer/portainer \</span></span><br><span class="line"><span class="ruby">-H <span class="symbol">unix:</span>/<span class="regexp">//var</span><span class="regexp">/run/docker</span>.sock</span></span><br></pre></td></tr></table></figure>
<p>容器管理：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-containers.png" alt=""></p>
<p>镜像管理：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-images.png" alt=""></p>
<p>镜像仓库：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/harbor-registry.png" alt=""></p>
<p>Endpoints：</p>
<p><img src="http://ojoba1c98.bkt.clouddn.com/img/docker-visual-management-and-orchestrate-tools/end-point.png" alt=""></p>
<p><strong>注意</strong>：添加Endpoints先要暴露节点的2375端口。</p>
<h1 id="Finally"><a href="#Finally" class="headerlink" title="Finally"></a>Finally</h1><blockquote>
<p>参考：</p>
<p><strong><em><a href="https://yeasy.gitbooks.io/docker_practice/content/" rel="external nofollow noopener noreferrer" target="_blank">Docker — 从入门到实践</a></em></strong></p>
<p><strong><em><a href="http://www.jiagoumi.com/virtualization/1464.html" rel="external nofollow noopener noreferrer" target="_blank">在生产环境中使用Docker Swarm的一些建议</a></em></strong></p>
<p><strong><em><a href="https://www.jianshu.com/p/8d4fcff97a35" rel="external nofollow noopener noreferrer" target="_blank">使用Docker Harbor搭建私有镜像服务器和Mirror服务器</a></em></strong></p>
<p><strong><em><a href="https://deepzz.com/post/dockerd-and-docker-remote-api.html" rel="external nofollow noopener noreferrer" target="_blank">远程连接docker daemon，Docker Remote API</a></em></strong></p></blockquote>
      
    </div>

<div style="text-align:center;color:#ccc;font-size:14px">---------------- The End ----------------</div>

    <div>
      
        
<div id="wechat_subscriber" style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center">
    <img id="wechat_subscriber_qcode" src="/images/wechat/gongzhonghao.jpg" alt="ookamiAntD wechat" style="width:200px;max-width:100%">
    <div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div>
</div>


      
    </div>

    <div>
      
        


  <div style="padding:10px 0;margin:20px auto;width:90%;text-align:center">
    <div>谢谢大爷～</div>
    <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'>
      <span>赏</span>
    </button>
    <div id="QR" style="display:none">
      
        <div id="wechat" style="display:inline-block">
          <img id="wechat_qr" src="/images/donate/wechat.png" alt="ookamiAntD WeChat Pay">
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display:inline-block">
          <img id="alipay_qr" src="/images/donate/alipay.jpg" alt="ookamiAntD Alipay">
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>
<div>
	  
	    <p id="div-border-left-red">
		Author：<b>ookamiAntD Yang</b><br>
		Link：<a href="/2018/docker-visual-management-and-orchestrate-tools/" title="Docker可视化与管理工具">http://yangbingdong.com/2018/docker-visual-management-and-orchestrate-tools/</a><br>
		Contact：<a>yangbingdong1994@gmail.com</a><br>
	   <b>本文基于<a target="_blank" title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href="http://creativecommons.org/licenses/by-sa/4.0/" rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br>
	    <b>转载请注明出处，谢谢！</b>
	    </p>
	  
	</div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Docker/" rel="tag"><i class="fa fa-tag"></i> Docker</a>
          
            <a href="/tags/Swarm/" rel="tag"><i class="fa fa-tag"></i> Swarm</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/with-reactor-response-encode/" rel="next" title="使用 Reactor 进行反应式编程">
                <i class="fa fa-chevron-left"></i> 使用 Reactor 进行反应式编程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/micro-service-ddd-notice/" rel="prev" title="关于微服务的一些调研零散笔记">
                关于微服务的一些调研零散笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        
<div class="-hoofoo-share-title">分享到：</div>
<div class="-hoofoo-share-buttons">
    <div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden="true"></i></div>
    <div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden="true"></i></div>
    <div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden="true"></i></div>
    <div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden="true"></i></div>
    <div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden="true"></i></div>
</div>
<div class="-mob-share-ui" style="display:none">
    <ul class="-mob-share-list">
        <li class="-mob-share-weibo"><p>新浪微博</p></li>
        <li class="-mob-share-weixin"><p>微信</p></li>
        <li class="-mob-share-qzone"><p>QQ空间</p></li>
        <li class="-mob-share-qq"><p>QQ好友</p></li>
        <li class="-mob-share-tencentweibo"><p>腾讯微博</p></li>
        <li class="-mob-share-renren"><p>人人网</p></li>
        <li class="-mob-share-kaixin"><p>开心网</p></li>
        <li class="-mob-share-douban"><p>豆瓣</p></li>
        <li class="-mob-share-youdao"><p>有道云笔记</p></li>
        <li class="-mob-share-mingdao"><p>明道</p></li>
        <li class="-mob-share-pengyou"><p>朋友网</p></li>
        <li class="-mob-share-facebook"><p>Facebook</p></li>
        <li class="-mob-share-twitter"><p>Twitter</p></li>
        <li class="-mob-share-pocket"><p>Pocket</p></li>
        <li class="-mob-share-google"><p>Google+</p></li>
        <li class="-mob-share-tumblr"><p>Tumblr</p></li>
        <li class="-mob-share-instapaper"><p>Instapaper</p></li>
        <li class="-mob-share-linkedin"><p>Linkedin</p></li>
    </ul>
    <div class="-mob-share-close">取消</div>
</div>
<div class="-mob-share-ui-bg"></div>
<script id="-mob-share" src="http://f1.webshare.mob.com/code/mob-share.js?appkey=21aa3b13ad233"></script>


      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
<div style="text-align:center">
  

</div>
      <div id="disqus_proxy_thread"></div>
      <div id="disqus_thread"></div>
      
          <script type="text/javascript">window.disqusProxy={username:"ookamiantd",server:"disqus-proxy.yangbingdong.com",port:"5509",defaultAvatar:"/images/avatar/avatar-default.jpg",adminAvatar:"/images/avatar/avatar-admin.jpg",identifier:"2018/docker-visual-management-and-orchestrate-tools/"},window.disqus_config=function(){this.page.url="http://yangbingdong.com/2018/docker-visual-management-and-orchestrate-tools/",this.page.identifier="2018/docker-visual-management-and-orchestrate-tools/"},window.onload=function(){var a=document.createElement("script");a.src="/static/js/main.0d0338ae.js",a.async=!0,document.body.appendChild(a)}</script>
          <link rel="stylesheet" href="/static/css/main.0603c539.css">
      

    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar/avatar-admin.jpg" alt="ookamiAntD">
          <p class="site-author-name" itemprop="name">ookamiAntD</p>
          <p class="site-description motion-element" itemprop="description">码渣 | rocker | 二次元 | 美剧 | 宅</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/masteranthoneyd" target="_blank" rel="external nofollow noopener noreferrer" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/profile.php?id=100014869064462" target="_blank" rel="external nofollow noopener noreferrer" title="Facebook">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                  Facebook
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/ookamiAntD" target="_blank" rel="external nofollow noopener noreferrer" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="cc-opacity" target="_blank" rel="external nofollow noopener noreferrer">
              <img src="/images/cc-by-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa fa-fw fa-globe"></i>
              大神们的博客
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://ycwalker.com/" title="ciqulover" target="_blank" rel="external nofollow noopener noreferrer">ciqulover</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://codepub.cn" title="IT草根" target="_blank" rel="external nofollow noopener noreferrer">IT草根</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://crossoverjie.top/" title="crossoverJie's Blog" target="_blank" rel="external nofollow noopener noreferrer">crossoverJie's Blog</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://yemengying.com/" title="Giraffe's Home" target="_blank" rel="external nofollow noopener noreferrer">Giraffe's Home</a>
                </li>
              
            </ul>
          </div>
        

        <div id="days"></div>
    <script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("01/10/2017 12:34:56"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script>


      </section>

      
      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Preface"><span class="nav-number">1.</span> <span class="nav-text">Preface</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Docker-Registry-amp-Mirror"><span class="nav-number">2.</span> <span class="nav-text">Docker Registry & Mirror</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Harbor"><span class="nav-number">2.1.</span> <span class="nav-text">Harbor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Condition"><span class="nav-number">2.1.1.</span> <span class="nav-text">Condition</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Download"><span class="nav-number">2.1.2.</span> <span class="nav-text">Download</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Config"><span class="nav-number">2.1.3.</span> <span class="nav-text">Config</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Install"><span class="nav-number">2.1.4.</span> <span class="nav-text">Install</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#登录被refuse"><span class="nav-number">2.1.5.</span> <span class="nav-text">登录被refuse</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Login-and-Push"><span class="nav-number">2.1.6.</span> <span class="nav-text">Login and Push</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除Harbor"><span class="nav-number">2.1.7.</span> <span class="nav-text">删除Harbor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#踩坑"><span class="nav-number">2.1.8.</span> <span class="nav-text">踩坑</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#python版本"><span class="nav-number">2.1.8.1.</span> <span class="nav-text">python版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Fail-to-generate-key-file"><span class="nav-number">2.1.8.2.</span> <span class="nav-text">Fail to generate key file</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Registry-Mirror"><span class="nav-number">2.2.</span> <span class="nav-text">Registry Mirror</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Cluster-and-Orchestrate-Tools"><span class="nav-number">3.</span> <span class="nav-text">Cluster and Orchestrate Tools</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-Compose"><span class="nav-number">3.1.</span> <span class="nav-text">Docker Compose</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Install-1"><span class="nav-number">3.1.1.</span> <span class="nav-text">Install</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Command"><span class="nav-number">3.1.2.</span> <span class="nav-text">Command</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zsh命令补全"><span class="nav-number">3.1.3.</span> <span class="nav-text">Zsh命令补全</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Compose-文件指令"><span class="nav-number">3.1.4.</span> <span class="nav-text">Compose 文件指令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#build"><span class="nav-number">3.1.4.1.</span> <span class="nav-text">build</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cap-add-cap-drop"><span class="nav-number">3.1.4.2.</span> <span class="nav-text">cap_add, cap_drop</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#command"><span class="nav-number">3.1.4.3.</span> <span class="nav-text">command</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#configs"><span class="nav-number">3.1.4.4.</span> <span class="nav-text">configs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cgroup-parent"><span class="nav-number">3.1.4.5.</span> <span class="nav-text">cgroup_parent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#container-name"><span class="nav-number">3.1.4.6.</span> <span class="nav-text">container_name</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#deploy"><span class="nav-number">3.1.4.7.</span> <span class="nav-text">deploy</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#mode"><span class="nav-number">3.1.4.7.1.</span> <span class="nav-text">mode</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#replicas"><span class="nav-number">3.1.4.7.2.</span> <span class="nav-text">replicas</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#placement"><span class="nav-number">3.1.4.7.3.</span> <span class="nav-text">placement</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#update-config"><span class="nav-number">3.1.4.7.4.</span> <span class="nav-text">update_config</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#resources"><span class="nav-number">3.1.4.7.5.</span> <span class="nav-text">resources</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#restart-policy"><span class="nav-number">3.1.4.7.6.</span> <span class="nav-text">restart_policy</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#devices"><span class="nav-number">3.1.4.8.</span> <span class="nav-text">devices</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#depends-on"><span class="nav-number">3.1.4.9.</span> <span class="nav-text">depends_on</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dns"><span class="nav-number">3.1.4.10.</span> <span class="nav-text">dns</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dns-search"><span class="nav-number">3.1.4.11.</span> <span class="nav-text">dns_search</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tmpfs"><span class="nav-number">3.1.4.12.</span> <span class="nav-text">tmpfs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#env-file"><span class="nav-number">3.1.4.13.</span> <span class="nav-text">env_file</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#environment"><span class="nav-number">3.1.4.14.</span> <span class="nav-text">environment</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#expose"><span class="nav-number">3.1.4.15.</span> <span class="nav-text">expose</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#external-links"><span class="nav-number">3.1.4.16.</span> <span class="nav-text">external_links</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#extra-hosts"><span class="nav-number">3.1.4.17.</span> <span class="nav-text">extra_hosts</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#healthcheck"><span class="nav-number">3.1.4.18.</span> <span class="nav-text">healthcheck</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#image"><span class="nav-number">3.1.4.19.</span> <span class="nav-text">image</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#labels"><span class="nav-number">3.1.4.20.</span> <span class="nav-text">labels</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#links"><span class="nav-number">3.1.4.21.</span> <span class="nav-text">links</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#logging"><span class="nav-number">3.1.4.22.</span> <span class="nav-text">logging</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#network-mode"><span class="nav-number">3.1.4.23.</span> <span class="nav-text">network_mode</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#networks"><span class="nav-number">3.1.4.24.</span> <span class="nav-text">networks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pid"><span class="nav-number">3.1.4.25.</span> <span class="nav-text">pid</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ports"><span class="nav-number">3.1.4.26.</span> <span class="nav-text">ports</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#secrets"><span class="nav-number">3.1.4.27.</span> <span class="nav-text">secrets</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#security-opt"><span class="nav-number">3.1.4.28.</span> <span class="nav-text">security_opt</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#stop-signal"><span class="nav-number">3.1.4.29.</span> <span class="nav-text">stop_signal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sysctls"><span class="nav-number">3.1.4.30.</span> <span class="nav-text">sysctls</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ulimits"><span class="nav-number">3.1.4.31.</span> <span class="nav-text">ulimits</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#volumes"><span class="nav-number">3.1.4.32.</span> <span class="nav-text">volumes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其它指令"><span class="nav-number">3.1.4.33.</span> <span class="nav-text">其它指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#读取变量"><span class="nav-number">3.1.4.34.</span> <span class="nav-text">读取变量</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#理解多compose文件组合"><span class="nav-number">3.1.5.</span> <span class="nav-text">理解多compose文件组合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-Machine"><span class="nav-number">3.2.</span> <span class="nav-text">Docker Machine</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Install-2"><span class="nav-number">3.2.1.</span> <span class="nav-text">Install</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zsh命令补全-1"><span class="nav-number">3.2.2.</span> <span class="nav-text">Zsh命令补全</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Usage"><span class="nav-number">3.2.3.</span> <span class="nav-text">Usage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用KVM引擎启动"><span class="nav-number">3.2.4.</span> <span class="nav-text">使用KVM引擎启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Swarm-Mode"><span class="nav-number">3.3.</span> <span class="nav-text">Swarm Mode</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#功能特点"><span class="nav-number">3.3.1.</span> <span class="nav-text">功能特点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#与Docker-Engine集成的集群管理"><span class="nav-number">3.3.1.1.</span> <span class="nav-text">与Docker Engine集成的集群管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#节点分散式设计"><span class="nav-number">3.3.1.2.</span> <span class="nav-text">节点分散式设计</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#声明性服务模型"><span class="nav-number">3.3.1.3.</span> <span class="nav-text">声明性服务模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#可扩容与缩放容器"><span class="nav-number">3.3.1.4.</span> <span class="nav-text">可扩容与缩放容器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#容器容错状态协调"><span class="nav-number">3.3.1.5.</span> <span class="nav-text">容器容错状态协调</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多主机网络"><span class="nav-number">3.3.1.6.</span> <span class="nav-text">多主机网络</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务发现"><span class="nav-number">3.3.1.7.</span> <span class="nav-text">服务发现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#负载平衡"><span class="nav-number">3.3.1.8.</span> <span class="nav-text">负载平衡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#缺省安全"><span class="nav-number">3.3.1.9.</span> <span class="nav-text">缺省安全</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#滚动更新"><span class="nav-number">3.3.1.10.</span> <span class="nav-text">滚动更新</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#概念"><span class="nav-number">3.3.2.</span> <span class="nav-text">概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#节点"><span class="nav-number">3.3.2.1.</span> <span class="nav-text">节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务和任务"><span class="nav-number">3.3.2.2.</span> <span class="nav-text">服务和任务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建集群"><span class="nav-number">3.3.3.</span> <span class="nav-text">创建集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#节点管理"><span class="nav-number">3.3.4.</span> <span class="nav-text">节点管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#查看集群中的docker信息"><span class="nav-number">3.3.4.1.</span> <span class="nav-text">查看集群中的docker信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#列出节点"><span class="nav-number">3.3.4.2.</span> <span class="nav-text">列出节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看节点的详细信息"><span class="nav-number">3.3.4.3.</span> <span class="nav-text">查看节点的详细信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#更新节点"><span class="nav-number">3.3.4.4.</span> <span class="nav-text">更新节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#升级或降级节点"><span class="nav-number">3.3.4.5.</span> <span class="nav-text">升级或降级节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#退出docker-swarm集群"><span class="nav-number">3.3.4.6.</span> <span class="nav-text">退出docker swarm集群</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#可视化visualizer服务"><span class="nav-number">3.3.5.</span> <span class="nav-text">可视化visualizer服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Service用法"><span class="nav-number">3.3.6.</span> <span class="nav-text">Service用法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Docker-Visual-Management"><span class="nav-number">4.</span> <span class="nav-text">Docker Visual Management</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Rancher"><span class="nav-number">4.1.</span> <span class="nav-text">Rancher</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Shipyard"><span class="nav-number">4.2.</span> <span class="nav-text">Shipyard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Portainer"><span class="nav-number">4.3.</span> <span class="nav-text">Portainer</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Finally"><span class="nav-number">5.</span> <span class="nav-text">Finally</span></a></li></ol></div>
            

          </div>
        </section>
      
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
	
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-flash"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a></span>
</div>


<div class="powered-by">
    Personal Site
</div>

<div class="theme-info">
  Blog -
ookamiAntD | <span class="post-count">共191.4k字</span>
</div>



        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user">本站访客数</i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span>人次</span>
  

  
    <span class="site-pv"><i class="fa fa-eye">本站总访问量</i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span>次</span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">function run_disqus_script(e){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//"+disqus_shortname+".disqus.com/"+e,(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)}var disqus_shortname="ookamiantd",disqus_identifier="2018/docker-visual-management-and-orchestrate-tools/",disqus_title="Docker可视化与管理工具",disqus={load:function(){"object"!=typeof DISQUS&&(!function(){var e=document.createElement("script");e.async=!0,e.type="text/javascript",e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(e)}(),$("#load-disqus").html("评论加载中，请确保你有梯子，若评论长时间未加载则你可能翻墙失败...").fadeOut(9e3))}}</script>
  









  
  
  <script type="text/javascript">function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),n=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);n.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!1,n=r.title.trim().toLowerCase(),s=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),o=decodeURIComponent(r.url),i=-1,l=-1,p=-1;if(""!=n&&a.forEach(function(e,t){i=n.indexOf(e),l=s.indexOf(e),(i>=0||l>=0)&&(c=!0,0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+o+"' class='search-result-title'>"+n+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;u<0&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),n.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("usE0s6JGUeOiMcsVoRuHuv2B-gzGzoHsz","ewm6NEF07r83HbnOr63ptuKH")</script>
  <script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){if(0!==e.length){for(c=0;c<e.length;c++){var t=e[c],i=t.get("url"),s=t.get("time"),l=document.getElementById(i);$(l).find(".leancloud-visitors-count").text(s)}for(var c=0;c<n.length;c++){var i=n[c],l=document.getElementById(i),r=$(l).find(".leancloud-visitors-count");""==r.text()&&r.text(0)}}else o.find(".leancloud-visitors-count").text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){$(document.getElementById(n)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var s=new e,l=new AV.ACL;l.setPublicReadAccess(!0),l.setPublicWriteAccess(!0),s.setACL(l),s.set("title",o),s.set("url",n),s.set("time",1),s.save(null,{success:function(e){$(document.getElementById(n)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script>



  
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>


  


  <script type="text/javascript" color="255,0,204" opacity="0.5" zindex="-2" count="80" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script>



<script type="text/javascript">$("body").delegate(".-mob-share-weixin-qrcode-bg","click",function(){$(".-mob-share-weixin-qrcode-close").trigger("click")})</script>




<script type="text/javascript" src="/js/src/dytitle.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":88,"height":88,"position":"left"},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.5},"log":false});</script></body></html>